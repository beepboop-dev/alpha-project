const express = require('express');
const Database = require('better-sqlite3');
const QRCode = require('qrcode');
const Stripe = require('stripe');
const { v4: uuidv4 } = require('uuid');
const bcrypt = require('bcryptjs');
const session = require('express-session');
const cookieParser = require('cookie-parser');
const path = require('path');
const BLOG_POSTS = require('./blog-posts');

const app = express();
const PORT = 3101;
const BASE_URL = process.env.BASE_URL || 'https://alpha.abapture.ai';

const stripe = Stripe(process.env.STRIPE_SECRET_KEY);

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cookieParser());
app.use(express.static(path.join(__dirname, 'public')));
app.use(session({ secret: 'reviewflow-k8x7m2p', resave: false, saveUninitialized: false, cookie: { maxAge: 30*24*60*60*1000 } }));

const db = new Database(path.join(__dirname, 'reviewflow.db'));
db.pragma('journal_mode = WAL');
db.pragma('foreign_keys = ON');

db.exec(`
  CREATE TABLE IF NOT EXISTS users (id TEXT PRIMARY KEY, email TEXT UNIQUE NOT NULL, password_hash TEXT NOT NULL, business_name TEXT, plan TEXT DEFAULT 'free', stripe_customer_id TEXT, stripe_subscription_id TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP);
  CREATE TABLE IF NOT EXISTS locations (id TEXT PRIMARY KEY, user_id TEXT NOT NULL, slug TEXT UNIQUE NOT NULL, business_name TEXT NOT NULL, business_type TEXT DEFAULT '', google_review_url TEXT NOT NULL, primary_color TEXT DEFAULT '#2563eb', thank_you_message TEXT DEFAULT 'Thank you for your feedback!', gate_threshold INTEGER DEFAULT 4, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (user_id) REFERENCES users(id));
  CREATE TABLE IF NOT EXISTS reviews (id TEXT PRIMARY KEY, location_id TEXT NOT NULL, rating INTEGER NOT NULL, feedback TEXT DEFAULT '', customer_name TEXT DEFAULT '', customer_email TEXT DEFAULT '', redirected_to_google INTEGER DEFAULT 0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (location_id) REFERENCES locations(id));
  CREATE TABLE IF NOT EXISTS page_views (id INTEGER PRIMARY KEY AUTOINCREMENT, location_id TEXT NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (location_id) REFERENCES locations(id));
  CREATE TABLE IF NOT EXISTS response_templates (id TEXT PRIMARY KEY, user_id TEXT, category TEXT NOT NULL, title TEXT NOT NULL, body TEXT NOT NULL, is_default INTEGER DEFAULT 0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP);
  CREATE TABLE IF NOT EXISTS campaigns (id TEXT PRIMARY KEY, user_id TEXT NOT NULL, customer_name TEXT NOT NULL, contact TEXT NOT NULL, channel TEXT DEFAULT 'email', template_id TEXT DEFAULT 'friendly', message TEXT DEFAULT '', review_link TEXT DEFAULT '', status TEXT DEFAULT 'sent', clicked INTEGER DEFAULT 0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (user_id) REFERENCES users(id));
  CREATE TABLE IF NOT EXISTS email_signups (id INTEGER PRIMARY KEY AUTOINCREMENT, email TEXT UNIQUE NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP);
  CREATE TABLE IF NOT EXISTS notifications (id TEXT PRIMARY KEY, user_id TEXT NOT NULL, location_id TEXT NOT NULL, type TEXT DEFAULT 'negative_review', message TEXT, read INTEGER DEFAULT 0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (user_id) REFERENCES users(id));
`);

// Add new columns if missing
try { db.exec("ALTER TABLE locations ADD COLUMN header_text TEXT DEFAULT ''"); } catch(e) {}
try { db.exec("ALTER TABLE locations ADD COLUMN logo_url TEXT DEFAULT ''"); } catch(e) {}
try { db.exec("ALTER TABLE locations ADD COLUMN color_theme TEXT DEFAULT 'blue'"); } catch(e) {}
try { db.exec("ALTER TABLE locations ADD COLUMN page_style TEXT DEFAULT 'professional'"); } catch(e) {}
try { db.exec("ALTER TABLE locations ADD COLUMN custom_bg TEXT DEFAULT ''"); } catch(e) {}

// Industry templates for onboarding autocomplete
const INDUSTRY_TEMPLATES = {
  "Restaurant": { sms: "Thanks for dining with us at {name}! We would love to hear about your meal: {link}", email: "Subject: How was your meal at {name}?\nThank you for dining at {name}! Share your experience:\n{link}", headerText: "How was your meal?", icon: "üçΩÔ∏è" },
  "Salon/Spa": { sms: "Hope you love your new look from {name}! Share your experience: {link}", email: "Subject: Enjoying your new look from {name}?\nThank you for visiting {name}! Share your feedback:\n{link}", headerText: "How was your visit?", icon: "üíá" },
  "Dental Office": { sms: "Thanks for your visit to {name}! Your feedback helps us: {link}", email: "Subject: How was your appointment at {name}?\nThank you for choosing {name}. Share your feedback:\n{link}", headerText: "How was your appointment?", icon: "ü¶∑" },
  "Medical Practice": { sms: "Thank you for choosing {name}. We value your feedback: {link}", email: "Subject: Your visit to {name}\nThank you for trusting {name}. Share your feedback:\n{link}", headerText: "How was your experience?", icon: "üè•" },
  "Auto Shop": { sms: "Thanks for bringing your car to {name}! How did we do? {link}", email: "Subject: How was your service at {name}?\nThank you for trusting {name} with your vehicle.\n{link}", headerText: "How was your service?", icon: "üîß" },
  "Real Estate": { sms: "Thanks for working with {name}! Your review means a lot: {link}", email: "Subject: How was your experience with {name}?\nThank you for choosing {name}. Share your experience:\n{link}", headerText: "How was your experience?", icon: "üè†" },
  "Legal Services": { sms: "Thank you for choosing {name}. Your feedback is valued: {link}", email: "Subject: Your experience with {name}\nThank you for trusting {name}. Your honest review helps others:\n{link}", headerText: "How was your experience?", icon: "‚öñÔ∏è" },
  "Home Services": { sms: "Thanks for choosing {name}! Happy with the work? Let us know: {link}", email: "Subject: How did {name} do?\nThank you for choosing {name}! Your feedback helps us grow:\n{link}", headerText: "How was the service?", icon: "üè°" },
  "Retail Store": { sms: "Thanks for shopping at {name}! Tell us about your experience: {link}", email: "Subject: How was your shopping at {name}?\nThank you for visiting {name}! Share your experience:\n{link}", headerText: "How was your shopping experience?", icon: "üõçÔ∏è" },
  "Fitness/Gym": { sms: "Great workout at {name}? Share your experience: {link}", email: "Subject: How is your experience at {name}?\nThank you for being part of the {name} community!\n{link}", headerText: "How is your experience?", icon: "üí™" },
  "Other": { sms: "Thanks for choosing {name}! Share your feedback: {link}", email: "Subject: How was your experience with {name}?\nThank you for choosing {name}! Share your experience:\n{link}", headerText: "How was your experience?", icon: "‚≠ê" },
};

function requireAuth(req, res, next) { if (!req.session.userId) return res.redirect('/login'); next(); }
function getUser(req) { if (!req.session.userId) return null; return db.prepare('SELECT * FROM users WHERE id = ?').get(req.session.userId); }
function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function css() {
  return `<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#1e293b;line-height:1.6}
.container{max-width:1200px;margin:0 auto;padding:0 24px}
.btn{display:inline-block;padding:12px 24px;border-radius:8px;font-weight:600;font-size:15px;text-decoration:none;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:#2563eb;color:#fff}.btn-primary:hover{background:#1d4ed8}
.btn-secondary{background:#f1f5f9;color:#334155;border:1px solid #e2e8f0}.btn-secondary:hover{background:#e2e8f0}
.btn-danger{background:#ef4444;color:#fff}.btn-sm{padding:8px 16px;font-size:13px}
.card{background:#fff;border-radius:12px;border:1px solid #e2e8f0;padding:24px;margin-bottom:16px}
input,select,textarea{width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:15px;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.1)}
label{display:block;font-weight:600;font-size:14px;margin-bottom:6px;color:#374151}
.form-group{margin-bottom:20px}.form-hint{font-size:13px;color:#6b7280;margin-top:4px}
.alert{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:14px}
.alert-error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
.alert-success{background:#f0fdf4;color:#16a34a;border:1px solid #bbf7d0}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:20px;text-align:center}
.stat-value{font-size:32px;font-weight:700;color:#1e293b}.stat-label{font-size:13px;color:#64748b;margin-top:4px}
.nav{background:#fff;border-bottom:1px solid #e2e8f0;padding:16px 0}
.nav-inner{display:flex;justify-content:space-between;align-items:center}
.nav-brand{font-size:20px;font-weight:700;color:#2563eb;text-decoration:none;display:flex;align-items:center;gap:8px}
.nav-links{display:flex;gap:24px;align-items:center}
.nav-links a{color:#64748b;text-decoration:none;font-size:14px;font-weight:500}.nav-links a:hover{color:#1e293b}
.badge{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;font-weight:600}
.badge-free{background:#f1f5f9;color:#64748b}.badge-starter{background:#dbeafe;color:#2563eb}.badge-growth{background:#fef3c7;color:#d97706}
.site-footer{background:#1e293b;color:#94a3b8;padding:60px 0 32px}
.footer-grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:40px;margin-bottom:40px}
.footer-grid h4{color:#fff;font-size:15px;margin-bottom:16px}
.footer-grid a{color:#94a3b8;text-decoration:none;display:block;font-size:14px;line-height:2}.footer-grid a:hover{color:#fff}
.footer-brand{font-size:18px;font-weight:700;color:#fff;margin-bottom:8px}
.footer-brand-desc{font-size:14px;line-height:1.6;margin-bottom:16px}
.footer-social{display:flex;gap:16px}
.footer-social a{display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:#334155;border-radius:8px;color:#94a3b8;font-size:18px;transition:all .2s}.footer-social a:hover{background:#2563eb;color:#fff}
.footer-bottom{border-top:1px solid #334155;padding-top:24px;display:flex;justify-content:space-between;align-items:center;font-size:13px;flex-wrap:wrap;gap:12px}
.footer-bottom a{color:#94a3b8;text-decoration:none;margin-left:16px}.footer-bottom a:hover{color:#fff}
@media(max-width:768px){.stat-grid{grid-template-columns:1fr 1fr}.nav-links{gap:12px}.footer-grid{grid-template-columns:1fr 1fr}.footer-bottom{flex-direction:column;text-align:center}}
@media(max-width:480px){.footer-grid{grid-template-columns:1fr}.nav-links{gap:8px}.nav-links a{font-size:12px}.btn-sm{padding:6px 12px;font-size:12px}}
</style>`;
}

function footer() {
  return `<footer class="site-footer"><div class="container">
<div class="footer-grid">
<div><div class="footer-brand">‚≠ê ReviewFlow</div>
<div class="footer-brand-desc">Help your local business collect more 5-star Google reviews with smart review routing.</div>
<div class="footer-social">
<a href="#" title="Twitter">ùïè</span>
<a href="#" title="Facebook">f</span>
<a href="#" title="LinkedIn">in</span>
<a href="#" title="Instagram">üì∑</span>
</div></div>
<div><h4>Product</h4><a href="#features">Features</span><a href="#pricing">Pricing</span><a href="#demo">Live Demo</span><a href="/signup">Get Started</span></div>
<div><h4>Resources</h4><a href="#">Help Center</span><a href="/blog">Blog</span><a href="#">API Docs</span><a href="#">Integrations</span></div>
<div><h4>Company</h4><a href="#">About Us</span><a href="#">Contact</span><a href="/terms">Terms of Service</span><a href="/privacy">Privacy Policy</span></div>
</div>
<div class="footer-bottom"><span>&copy; 2026 ReviewFlow. All rights reserved.</span>
<div><a href="/terms">Terms</span><a href="/privacy">Privacy</span><a href="mailto:support@reviewflow.com">Contact</span></div>
</div></div></footer>`;
}

// ===== LANDING PAGE =====
app.get('/', (req, res) => {
  res.send(`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ReviewFlow ‚Äî Get More Google Reviews for Your Business</title>
<meta name="description" content="Help your local business collect more 5-star Google reviews with smart review routing, QR codes, and analytics.">
<meta property="og:title" content="ReviewFlow ‚Äî Get More Google Reviews for Your Business">
<meta property="og:description" content="Smart review collection tool for local businesses. Route happy customers to Google, catch unhappy ones privately. Free to start.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://alpha.abapture.ai">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ReviewFlow ‚Äî Google Review Management">
<meta name="twitter:description" content="Collect more 5-star Google reviews with smart routing, QR codes, and analytics. Free for local businesses.">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://alpha.abapture.ai">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"SoftwareApplication","name":"ReviewFlow","applicationCategory":"BusinessApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},"description":"Smart Google review collection tool for local businesses. Route happy customers to Google Reviews and catch unhappy ones privately.","url":"https://alpha.abapture.ai"}</script>
<script type="application/ld+json">{"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"What is ReviewFlow?","acceptedAnswer":{"@type":"Answer","text":"ReviewFlow is a smart Google review management tool for local businesses. It helps you collect more 5-star reviews by routing happy customers to Google and catching unhappy ones privately."}},{"@type":"Question","name":"Is ReviewFlow free?","acceptedAnswer":{"@type":"Answer","text":"Yes! Free forever plan includes 1 location, unlimited reviews, QR codes, and analytics."}},{"@type":"Question","name":"How does review gating work?","acceptedAnswer":{"@type":"Answer","text":"Customers rate their experience. 4-5 stars go to Google Reviews. 1-3 stars see a private feedback form."}},{"@type":"Question","name":"How long does setup take?","acceptedAnswer":{"@type":"Answer","text":"Less than 2 minutes. Sign up, paste your Google review link, and start collecting."}},{"@type":"Question","name":"What businesses use ReviewFlow?","acceptedAnswer":{"@type":"Answer","text":"Restaurants, dental offices, salons, auto shops, real estate, law firms, medical practices, retail, gyms, and more."}}]}</script>
${css()}
<style>
.hero{padding:80px 0;text-align:center;background:linear-gradient(135deg,#eff6ff 0%,#f0fdf4 100%)}
.hero h1{font-size:48px;font-weight:800;line-height:1.1;margin-bottom:20px}.hero h1 span{color:#2563eb}
.hero p{font-size:20px;color:#64748b;max-width:600px;margin:0 auto 32px}
.features{padding:80px 0}.features-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:32px}
.feature-card{text-align:center;padding:32px}.feature-icon{font-size:48px;margin-bottom:16px}
.feature-card h3{font-size:20px;margin-bottom:8px}.feature-card p{color:#64748b;font-size:15px}
.how-it-works{padding:80px 0;background:#f8fafc}
.steps{display:grid;grid-template-columns:repeat(3,1fr);gap:40px;margin-top:40px}
.step{text-align:center}.step-number{width:48px;height:48px;border-radius:50%;background:#2563eb;color:#fff;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.step h3{margin-bottom:8px}.step p{color:#64748b;font-size:15px}
.pricing-section{padding:80px 0}
.pricing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;max-width:900px;margin:40px auto 0}
.pricing-card{border:2px solid #e2e8f0;border-radius:16px;padding:32px;text-align:center}
.pricing-card.featured{border-color:#2563eb;position:relative}
.pricing-card.featured::before{content:'MOST POPULAR';position:absolute;top:-14px;left:50%;transform:translateX(-50%);background:#2563eb;color:#fff;padding:4px 16px;border-radius:999px;font-size:12px;font-weight:700}
.pricing-card h3{font-size:22px;margin-bottom:8px}
.pricing-card .price{font-size:42px;font-weight:800;margin:16px 0 8px}.pricing-card .price span{font-size:16px;font-weight:400;color:#64748b}
.pricing-card ul{list-style:none;text-align:left;margin:24px 0}
.pricing-card li{padding:8px 0;font-size:15px;color:#475569}.pricing-card li::before{content:'‚úì';color:#22c55e;font-weight:700;margin-right:8px}
.cta{padding:80px 0;text-align:center;background:#1e293b;color:#fff}
.cta h2{font-size:36px;margin-bottom:16px}.cta p{color:#94a3b8;font-size:18px;margin-bottom:32px}
footer{padding:40px 0;text-align:center;color:#94a3b8;font-size:14px;border-top:1px solid #e2e8f0}
@media(max-width:768px){.hero h1{font-size:32px}.hero p{font-size:16px}.features-grid,.steps,.pricing-grid{grid-template-columns:1fr}}
@media(max-width:768px){.testimonials-grid{grid-template-columns:1fr !important}}
@media(max-width:480px){.hero h1{font-size:26px}.hero .btn{display:block;margin:8px auto;width:90%;text-align:center}}
</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body><div style="background:#2563eb;color:white;text-align:center;padding:10px 16px;font-size:14px;font-weight:500">üöÄ Launch Special: Free forever plan available ‚Äî <a href="/signup" style="color:#fbbf24;text-decoration:underline">Get started now</span></div>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span>
<div class="nav-links"><a href="#features">Features</span><a href="#pricing">Pricing</span><a href="/login">Log In</span><a href="/signup" class="btn btn-primary btn-sm">Start Free</span></div></div></nav>

<section class="hero"><div class="container">
<h1>Get More <span>5-Star Reviews</span><br>Without the Hassle</h1>
<p>ReviewFlow helps local businesses collect Google reviews on autopilot. Smart review routing sends happy customers to Google ‚Äî and catches unhappy ones before they go public.</p>
<a href="/signup" class="btn btn-primary" style="padding:16px 40px;font-size:17px">Start Collecting Reviews ‚Äî Free</span>
<a href="#demo" class="btn btn-secondary" style="padding:16px 32px;font-size:17px;margin-left:12px">Try Live Demo ‚Üì</span>
<p style="font-size:14px;color:#94a3b8;margin-top:12px">No credit card required ¬∑ Set up in 2 minutes</p>
</div></section>

<section id="demo" style="padding:60px 0;background:#fff"><div class="container" style="max-width:900px;margin:0 auto">
<h2 style="text-align:center;font-size:36px;margin-bottom:8px">Try It Right Now</h2>
<p style="text-align:center;color:#64748b;font-size:18px;margin-bottom:32px">Enter your business name to see what your review page would look like ‚Äî no signup needed.</p>
<div style="display:flex;gap:12px;max-width:500px;margin:0 auto 32px;flex-wrap:wrap">
<input type="text" id="demo-name" placeholder="e.g. Joe's Coffee Shop" style="flex:1;padding:14px 18px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;min-width:200px" oninput="updateDemo()">
<input type="color" id="demo-color" value="#2563eb" style="width:52px;height:52px;border:2px solid #e2e8f0;border-radius:10px;cursor:pointer;padding:4px" oninput="updateDemo()">
</div>
<div style="display:flex;justify-content:center"><div id="demo-preview" style="background:#f8fafc;border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,.12);max-width:420px;width:100%;padding:40px 32px;text-align:center;transition:all .3s">
<div id="dp-name" style="font-size:24px;font-weight:700;color:#1e293b;margin-bottom:8px">Your Business Name</div>
<div style="font-size:18px;color:#475569;margin-bottom:24px">How was your experience?</div>
<div style="display:flex;justify-content:center;gap:8px;margin-bottom:24px" id="demo-stars">
<span class="dstar" style="font-size:48px;cursor:pointer;filter:grayscale(1) opacity(.3);transition:all .15s" onclick="demoPick(1)">‚≠ê</span>
<span class="dstar" style="font-size:48px;cursor:pointer;filter:grayscale(1) opacity(.3);transition:all .15s" onclick="demoPick(2)">‚≠ê</span>
<span class="dstar" style="font-size:48px;cursor:pointer;filter:grayscale(1) opacity(.3);transition:all .15s" onclick="demoPick(3)">‚≠ê</span>
<span class="dstar" style="font-size:48px;cursor:pointer;filter:grayscale(1) opacity(.3);transition:all .15s" onclick="demoPick(4)">‚≠ê</span>
<span class="dstar" style="font-size:48px;cursor:pointer;filter:grayscale(1) opacity(.3);transition:all .15s" onclick="demoPick(5)">‚≠ê</span>
</div>
<div id="demo-result" style="display:none"></div>
<div style="margin-top:20px;font-size:12px;color:#cbd5e1">Powered by <span style="color:#94a3b8">ReviewFlow</span></div>
</div></div>
<div style="text-align:center;margin-top:32px">
<a href="#" onclick="var n=document.getElementById('demo-name').value||'Your Business';window.open('/demo/'+encodeURIComponent(n)+'?color='+encodeURIComponent(document.getElementById('demo-color').value),'_blank');return false" class="btn btn-secondary" style="padding:14px 28px;font-size:16px;margin-right:12px">Open Full Preview ‚Üó</span>
<a href="/signup" class="btn btn-primary" style="padding:14px 36px;font-size:16px">Create Your Review Page Free ‚Üí</span></div>
</div>
<script>
function updateDemo(){var n=document.getElementById('demo-name').value||'Your Business Name';document.getElementById('dp-name').textContent=n;resetDemo()}
function resetDemo(){document.querySelectorAll('.dstar').forEach(s=>{s.style.filter='grayscale(1) opacity(.3)';s.style.transform='scale(1)'});document.getElementById('demo-result').style.display='none'}
function demoPick(r){var stars=document.querySelectorAll('.dstar');stars.forEach((s,i)=>{s.style.filter=i<r?'none':'grayscale(1) opacity(.3)';s.style.transform=i<r?'scale(1.15)':'scale(1)'});
var c=document.getElementById('demo-color').value;var dr=document.getElementById('demo-result');dr.style.display='block';
if(r>=4){dr.innerHTML='<div style="margin:16px 0"><div style="font-size:48px;margin-bottom:12px">üéâ</div><p style="font-size:16px;color:#475569">Great! The customer gets redirected to <strong>Google Reviews</strong>.</p><button style="margin-top:12px;padding:12px 24px;background:'+c+';color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:default">Leave a Google Review ‚Üí</button></div>'}
else{dr.innerHTML='<div style="margin:16px 0"><div style="font-size:48px;margin-bottom:12px">üõ°Ô∏è</div><p style="font-size:16px;color:#475569">This feedback stays <strong>private</strong> ‚Äî it never reaches Google.</p><div style="margin-top:12px;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;text-align:left"><div style="font-size:13px;color:#94a3b8;margin-bottom:4px">Private feedback form appears here</div><div style="background:#f1f5f9;border-radius:4px;height:32px;margin-bottom:8px"></div><div style="background:#f1f5f9;border-radius:4px;height:60px"></div></div></div>'}}
</script></section>

<section id="features" class="features"><div class="container">
<h2 style="text-align:center;font-size:36px;margin-bottom:40px">Everything You Need to Own Your Reviews</h2>
<div class="features-grid">
<div class="feature-card"><div class="feature-icon">üõ°Ô∏è</div><h3>Smart Review Gate</h3><p>Happy customers get sent to Google. Unhappy ones send you private feedback instead.</p></div>
<div class="feature-card"><div class="feature-icon">üì±</div><h3>QR Codes</h3><p>Print QR codes for your counter, receipts, tables, or business cards.</p></div>
<div class="feature-card"><div class="feature-icon">üìä</div><h3>Real-Time Analytics</h3><p>Track every page view, review, and rating. See how your reputation is trending.</p></div>
<div class="feature-card"><div class="feature-icon">‚úâÔ∏è</div><h3>Ready-Made Templates</h3><p>Copy-paste SMS and email templates to request reviews after every visit.</p></div>
<div class="feature-card"><div class="feature-icon">üé®</div><h3>Branded Review Page</h3><p>Your own custom review page with your business name and colors.</p></div>
<div class="feature-card"><div class="feature-icon">‚ö°</div><h3>2-Minute Setup</h3><p>No technical skills needed. Just paste your Google review link and you're live.</p></div>
</div></div></section>

<section class="how-it-works"><div class="container">
<h2 style="text-align:center;font-size:36px">How It Works</h2>
<div class="steps">
<div class="step"><div class="step-number">1</div><h3>Add Your Business</h3><p>Enter your business name and paste your Google review link.</p></div>
<div class="step"><div class="step-number">2</div><h3>Share With Customers</h3><p>Use QR codes, text messages, or email to send customers to your review page.</p></div>
<div class="step"><div class="step-number">3</div><h3>Watch Reviews Grow</h3><p>Happy customers leave Google reviews. Unhappy ones send private feedback.</p></div>
</div></div></section>

<section id="pricing" class="pricing-section"><div class="container">
<h2 style="text-align:center;font-size:36px;margin-bottom:8px">Simple, Honest Pricing</h2>
<p style="text-align:center;color:#64748b;font-size:18px">Start free. Upgrade when you need more.</p>
<div class="pricing-grid">
<div class="pricing-card"><h3>Free</h3><div class="price">$0<span>/mo</span></div>
<ul><li>1 location</li><li>Branded review page</li><li>QR code</li><li>Basic analytics</li><li>Smart review gate</li></ul>
<a href="/signup" class="btn btn-secondary" style="width:100%">Get Started</span></div>
<div class="pricing-card featured"><h3>Starter</h3><div class="price">$29<span>/mo</span></div>
<ul><li>Everything in Free</li><li>SMS &amp; email templates</li><li>Advanced analytics</li><li>Custom thank-you messages</li><li>Priority support</li></ul>
<a href="/signup" class="btn btn-primary" style="width:100%">Start Free Trial</span></div>
<div class="pricing-card"><h3>Growth</h3><div class="price">$79<span>/mo</span></div>
<ul><li>Everything in Starter</li><li>Up to 5 locations</li><li>Team access</li><li>Review response templates</li><li>Dedicated support</li></ul>
<a href="/signup" class="btn btn-secondary" style="width:100%">Start Free Trial</span></div>
</div></div></section>

<section style="padding:80px 0;background:#fff"><div class="container">
<h2 style="text-align:center;font-size:36px;margin-bottom:8px">Trusted by Local Businesses</h2>
<p style="text-align:center;color:#64748b;font-size:18px;margin-bottom:48px">See what business owners are saying about ReviewFlow</p>
<div class="testimonials-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:24px;max-width:1000px;margin:0 auto">
<div style="background:#f8fafc;border-radius:16px;padding:32px;border:1px solid #e2e8f0">
<div style="color:#f59e0b;font-size:20px;margin-bottom:12px">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
<p style="font-size:15px;color:#475569;margin-bottom:20px;font-style:italic">"Since using ReviewFlow, our Google reviews went from 3.2 to 4.7 stars. The review gate is genius ‚Äî we've caught 23 negative reviews before they hit Google."</p>
<div style="display:flex;align-items:center;gap:12px"><div style="width:44px;height:44px;border-radius:50%;background:#dbeafe;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2563eb">MR</div>
<div><div style="font-weight:600;font-size:14px">Maria Rodriguez</div><div style="font-size:13px;color:#94a3b8">Owner, Bella's Salon & Spa</div></div></div></div>
<div style="background:#f8fafc;border-radius:16px;padding:32px;border:1px solid #e2e8f0">
<div style="color:#f59e0b;font-size:20px;margin-bottom:12px">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
<p style="font-size:15px;color:#475569;margin-bottom:20px;font-style:italic">"We went from 47 to 186 Google reviews in 3 months. The QR code at our register is a game changer. Customers actually enjoy leaving reviews now."</p>
<div style="display:flex;align-items:center;gap:12px"><div style="width:44px;height:44px;border-radius:50%;background:#fef3c7;display:flex;align-items:center;justify-content:center;font-weight:700;color:#d97706">JT</div>
<div><div style="font-weight:600;font-size:14px">James Thompson</div><div style="font-size:13px;color:#94a3b8">Owner, Main Street Auto Repair</div></div></div></div>
<div style="background:#f8fafc;border-radius:16px;padding:32px;border:1px solid #e2e8f0">
<div style="color:#f59e0b;font-size:20px;margin-bottom:12px">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
<p style="font-size:15px;color:#475569;margin-bottom:20px;font-style:italic">"Setup took literally 2 minutes. Now I just hand customers a card with the QR code after their appointment. My review count has tripled and my star rating went from 4.1 to 4.8."</p>
<div style="display:flex;align-items:center;gap:12px"><div style="width:44px;height:44px;border-radius:50%;background:#d1fae5;display:flex;align-items:center;justify-content:center;font-weight:700;color:#16a34a">SP</div>
<div><div style="font-weight:600;font-size:14px">Dr. Sarah Park</div><div style="font-size:13px;color:#94a3b8">Park Family Dental</div></div></div></div>
</div>
</div></section>

<section class="cta"><div class="container">
<h2>Every Day Without Reviews Is a Day You Lose Customers</h2>
<p>Businesses with more reviews get more clicks, more calls, and more customers.</p>
<a href="/signup" class="btn btn-primary" style="padding:16px 48px;font-size:17px">Start Free ‚Äî No Credit Card</span>
<div style="margin-top:48px;padding-top:40px;border-top:1px solid #334155">
<p style="font-size:16px;color:#cbd5e1;margin-bottom:16px">Not ready yet? Get notified when we launch new features.</p>
<form id="emailCapture" style="display:flex;gap:12px;max-width:440px;margin:0 auto" onsubmit="captureEmail(event)">
<input type="email" id="captureEmailInput" placeholder="you@business.com" required style="flex:1;padding:14px 18px;border:2px solid #475569;border-radius:10px;background:#334155;color:#fff;font-size:15px">
<button type="submit" class="btn btn-primary" style="padding:14px 24px;white-space:nowrap">Notify Me</button>
</form>
<p id="captureMsg" style="font-size:14px;margin-top:8px;display:none"></p>
</div>
</div></section>
<script>async function captureEmail(e){e.preventDefault();const em=document.getElementById('captureEmailInput').value;const r=await fetch('/api/email-signup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:em})});const d=await r.json();const m=document.getElementById('captureMsg');m.style.display='block';if(d.success){m.style.color='#4ade80';m.textContent='üéâ You\\'re on the list! We\\'ll keep you posted.';document.getElementById('captureEmailInput').value=''}else{m.style.color='#f87171';m.textContent=d.error||'Something went wrong'}}</script>
${footer()}
</body></html>`);
});

// ===== AUTH =====
app.get('/login', (req, res) => { if (req.session.userId) return res.redirect('/dashboard'); res.send(authPage('login')); });
app.get('/signup', (req, res) => { if (req.session.userId) return res.redirect('/dashboard'); res.send(authPage('signup')); });

app.post('/signup', (req, res) => {
  const { email, password, business_name } = req.body;
  if (!email || !password) return res.send(authPage('signup', 'Email and password required'));
  if (db.prepare('SELECT id FROM users WHERE email = ?').get(email)) return res.send(authPage('signup', 'Email already registered'));
  const id = uuidv4();
  db.prepare('INSERT INTO users (id, email, password_hash, business_name) VALUES (?,?,?,?)').run(id, email, bcrypt.hashSync(password, 10), business_name || '');
  req.session.userId = id;
  res.redirect('/onboarding');
});

app.post('/login', (req, res) => {
  const { email, password } = req.body;
  const user = db.prepare('SELECT * FROM users WHERE email = ?').get(email);
  if (!user || !bcrypt.compareSync(password, user.password_hash)) return res.send(authPage('login', 'Invalid email or password'));
  req.session.userId = user.id;
  res.redirect('/dashboard');
});

app.get('/logout', (req, res) => { req.session.destroy(); res.redirect('/'); });

function authPage(mode, error) {
  const isLogin = mode === 'login';
  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>${isLogin ? 'Log In' : 'Sign Up'} ‚Äî ReviewFlow</title>${css()}
<style>body{background:#f8fafc}.auth-wrap{max-width:440px;margin:80px auto;padding:0 24px}.auth-card{background:#fff;border-radius:16px;border:1px solid #e2e8f0;padding:40px}
.auth-card h1{font-size:28px;margin-bottom:8px;text-align:center}.auth-card .subtitle{color:#64748b;text-align:center;margin-bottom:32px}
.auth-footer{text-align:center;margin-top:24px;font-size:14px;color:#64748b}.auth-footer a{color:#2563eb;text-decoration:none}</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span><div></div></div></nav>
<div class="auth-wrap"><div class="auth-card">
<h1>${isLogin ? 'Welcome Back' : 'Create Your Account'}</h1>
<p class="subtitle">${isLogin ? 'Log in to your dashboard' : 'Start collecting reviews in 2 minutes'}</p>
${error ? `<div class="alert alert-error">${error}</div>` : ''}
<form method="POST" action="/${mode}">
${!isLogin ? '<div class="form-group"><label>Business Name</label><input type="text" name="business_name" placeholder="e.g. Joe\'s Coffee"></div>' : ''}
<div class="form-group"><label>Email</label><input type="email" name="email" required placeholder="you@business.com"></div>
<div class="form-group"><label>Password</label><input type="password" name="password" required minlength="6" placeholder="${isLogin?'Your password':'Create a password'}"></div>
<button type="submit" class="btn btn-primary" style="width:100%;padding:14px">${isLogin ? 'Log In' : 'Create Account'}</button>
</form>
<div class="auth-footer">${isLogin ? "Don't have an account? <a href='/signup'>Sign up free</span>" : "Already have an account? <a href='/login'>Log in</span>"}</div>
</div></div></body></html>`;
}

// ===== DASHBOARD =====
function dashLayout(user, content) {
  const pb = user.plan === 'growth' ? 'badge-growth' : user.plan === 'starter' ? 'badge-starter' : 'badge-free';
  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Dashboard ‚Äî ReviewFlow</title>${css()}<style>body{background:#f8fafc}.dashboard{padding:32px 0}</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/dashboard" class="nav-brand">‚≠ê ReviewFlow</span>
<div class="nav-links"><span class="badge ${pb}">${user.plan.toUpperCase()}</span><a href="/review-analytics">üìä Analytics</span><a href="/response-templates">üìù Templates</span><a href="/pricing">Upgrade</span><a href="/logout">Log Out</span></div></div></nav>
<div class="dashboard"><div class="container">${content}</div></div></body></html>`;
}

app.get('/dashboard', requireAuth, (req, res) => {
  const user = getUser(req);
  const locations = db.prepare('SELECT * FROM locations WHERE user_id = ? ORDER BY created_at DESC').all(user.id);
  const locIds = locations.map(l => l.id);
  
  // Aggregate metrics
  let aggTotal = 0, aggAvg = 0, aggWeek = 0, aggCaught = 0;
  if (locIds.length) {
    const ph = locIds.map(() => '?').join(',');
    aggTotal = db.prepare(`SELECT COUNT(*) as c FROM reviews WHERE location_id IN (${ph})`).get(...locIds).c;
    aggAvg = db.prepare(`SELECT AVG(rating) as a FROM reviews WHERE location_id IN (${ph})`).get(...locIds).a || 0;
    aggWeek = db.prepare(`SELECT COUNT(*) as c FROM reviews WHERE location_id IN (${ph}) AND created_at >= datetime('now','-7 days')`).get(...locIds).c;
    aggCaught = db.prepare(`SELECT COUNT(*) as c FROM reviews r JOIN locations l ON r.location_id=l.id WHERE r.location_id IN (${ph}) AND r.rating < l.gate_threshold AND r.redirected_to_google = 0`).get(...locIds).c;
  }

  // Recent notifications
  const notifs = db.prepare('SELECT n.*, l.business_name FROM notifications n JOIN locations l ON n.location_id=l.id WHERE n.user_id=? ORDER BY n.created_at DESC LIMIT 5').all(user.id);

  const locs = locations.map(loc => {
    const views = db.prepare('SELECT COUNT(*) as c FROM page_views WHERE location_id = ?').get(loc.id).c;
    const total = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id = ?').get(loc.id).c;
    const google = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id = ? AND redirected_to_google = 1').get(loc.id).c;
    const avg = db.prepare('SELECT AVG(rating) as a FROM reviews WHERE location_id = ?').get(loc.id).a || 0;
    const caught = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id = ? AND rating < ? AND redirected_to_google = 0').get(loc.id, loc.gate_threshold).c;
    return { ...loc, views, total, google, avg: avg.toFixed(1), caught };
  });

  // Aggregate stats bar
  let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px">
<div><h1 style="font-size:28px;margin-bottom:4px">Dashboard</h1><p style="color:#64748b;font-size:14px">Welcome back${user.business_name ? ', '+esc(user.business_name) : ''}!</p></div>
<div style="display:flex;gap:8px;flex-wrap:wrap"><a href="/guides" class="btn btn-secondary btn-sm">üöÄ Get Reviews</span><a href="/templates" class="btn btn-secondary btn-sm">üìã Templates</span><a href="/locations/new" class="btn btn-primary btn-sm">+ Add Location</span></div></div>`;
  
  html += `<div class="stat-grid" style="margin-bottom:24px">
<div class="stat-card" style="border-left:4px solid #2563eb"><div class="stat-value">${aggTotal}</div><div class="stat-label">Total Reviews</div></div>
<div class="stat-card" style="border-left:4px solid #f59e0b"><div class="stat-value">${aggAvg ? aggAvg.toFixed(1) + '‚òÖ' : '‚Äî'}</div><div class="stat-label">Avg Rating</div></div>
<div class="stat-card" style="border-left:4px solid #8b5cf6"><div class="stat-value">${aggWeek}</div><div class="stat-label">This Week</div></div>
<div class="stat-card" style="border-left:4px solid #22c55e"><div class="stat-value">${aggCaught}</div><div class="stat-label">Bad Reviews Caught üõ°Ô∏è</div></div>
</div>`;

  // Notifications
  if (notifs.length) {
    html += `<div class="card" style="margin-bottom:20px;border-left:4px solid #f59e0b;padding:16px 20px"><h3 style="font-size:15px;margin-bottom:12px">üîî Recent Notifications</h3>`;
    notifs.forEach(n => {
      const ago = Math.round((Date.now() - new Date(n.created_at+'Z').getTime()) / 60000);
      const agoText = ago < 60 ? ago + 'm ago' : Math.round(ago/60) + 'h ago';
      html += `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #f1f5f9;font-size:14px">
<span style="font-size:18px">üìß</span><span style="flex:1">${esc(n.message)}</span>
<span style="color:#94a3b8;font-size:12px;white-space:nowrap">${agoText}</span></div>`;
    });
    html += `</div>`;
  }

  // Quick Actions
  if (locs.length) {
    const firstLoc = locs[0];
    const reviewUrl = `${BASE_URL}/r/${firstLoc.slug}`;
    html += `<div class="card" style="margin-bottom:24px;border:2px solid #2563eb;background:linear-gradient(135deg,#eff6ff,#fff)">
<h3 style="font-size:17px;margin-bottom:16px">‚ö° Quick Actions</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
<button onclick="navigator.clipboard.writeText('${reviewUrl}');this.innerHTML='‚úì Copied!';setTimeout(()=>this.innerHTML='üìã Copy Review Link',2000)" class="btn btn-secondary" style="text-align:center;padding:16px 12px;font-size:14px">üìã Copy Review Link</button>
<a href="/locations/${firstLoc.id}/qr" class="btn btn-secondary" style="text-align:center;padding:16px 12px;font-size:14px">üì± Download QR Code</span>
<a href="/r/${firstLoc.slug}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary" style="text-align:center;padding:16px 12px;font-size:14px">üëÅÔ∏è Preview Review Page</span>
<a href="/locations/${firstLoc.id}/share" class="btn btn-secondary" style="text-align:center;padding:16px 12px;font-size:14px">üì§ Send Review Request</span>
<a href="/locations/${firstLoc.id}/style" class="btn btn-secondary" style="text-align:center;padding:16px 12px;font-size:14px">üé® Page Style</span>
<a href="/guides" class="btn btn-secondary" style="text-align:center;padding:16px 12px;font-size:14px">üöÄ Get More Reviews</span>
</div></div>`;
  }

  html += `<h2 style="font-size:20px;margin-bottom:16px">Your Locations</h2>`;

  if (!locs.length) {
    html += `<div class="card" style="text-align:center;padding:60px 20px"><div style="font-size:64px;margin-bottom:16px">üè™</div>
<h2 style="font-size:24px;margin-bottom:8px">No reviews yet ‚Äî share your link to get started!</h2>
<p style="color:#64748b;margin:8px 0 24px;max-width:400px;display:inline-block">Add your first business location and start collecting reviews in under 2 minutes. It's free!</p>
<div><a href="/locations/new" class="btn btn-primary" style="padding:14px 32px;font-size:16px">+ Add Your First Location</span></div>
<div style="margin-top:32px;display:flex;justify-content:center;gap:32px;color:#94a3b8;font-size:13px">
<div>‚úÖ Free forever plan</div><div>‚úÖ 2-minute setup</div><div>‚úÖ No credit card</div></div></div>`;
  } else {
    locs.forEach(l => {
      html += `<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
<div><h3 style="font-size:20px">${esc(l.business_name)}</h3><span style="color:#64748b;font-size:14px">${esc(l.business_type||'Business')}</span></div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<a href="/r/${l.slug}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary btn-sm">Preview</span>
<a href="/locations/${l.id}/qr" class="btn btn-secondary btn-sm">QR Code</span>
<a href="/locations/${l.id}/share" class="btn btn-secondary btn-sm">Share</span>
<a href="/locations/${l.id}/analytics" class="btn btn-secondary btn-sm">Analytics</span>
<a href="/locations/${l.id}/style" class="btn btn-secondary btn-sm">Style</span>
<a href="/locations/${l.id}/edit" class="btn btn-secondary btn-sm">Edit</span>
</div></div>
<div class="stat-grid">
<div class="stat-card"><div class="stat-value">${l.views}</div><div class="stat-label">Page Views</div></div>
<div class="stat-card"><div class="stat-value">${l.total}</div><div class="stat-label">Total Reviews</div></div>
<div class="stat-card"><div class="stat-value">${l.google}</div><div class="stat-label">Sent to Google</div></div>
<div class="stat-card"><div class="stat-value">${l.avg}‚òÖ</div><div class="stat-label">Avg Rating</div></div>
<div class="stat-card"><div class="stat-value" style="color:#22c55e">${l.caught}</div><div class="stat-label">Bad Reviews Caught</div></div>
</div></div>`;
    });
  }
  res.send(dashLayout(user, html));
});

// ===== LOCATIONS =====
app.get('/locations/new', requireAuth, (req, res) => {
  const user = getUser(req);
  const count = db.prepare('SELECT COUNT(*) as c FROM locations WHERE user_id = ?').get(user.id).c;
  const max = user.plan === 'growth' ? 5 : 1;
  if (count >= max && user.plan !== 'growth') {
    return res.send(dashLayout(user, '<div class="card" style="text-align:center;padding:60px"><h2>Upgrade to Add More Locations</h2><p style="color:#64748b;margin:16px 0"><a href="/pricing" class="btn btn-primary">View Plans</span></p></div>'));
  }
  res.send(locForm(user));
});

app.post('/locations', requireAuth, (req, res) => {
  const user = getUser(req);
  const { business_name, business_type, google_review_url, primary_color, gate_threshold } = req.body;
  if (!business_name || !google_review_url) return res.send(locForm(user, 'Business name and Google review URL are required'));
  const id = uuidv4();
  const slug = business_name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'')+'-'+id.slice(0,6);
  db.prepare('INSERT INTO locations (id,user_id,slug,business_name,business_type,google_review_url,primary_color,gate_threshold) VALUES (?,?,?,?,?,?,?,?)').run(id,user.id,slug,business_name,business_type||'',google_review_url,primary_color||'#2563eb',parseInt(gate_threshold)||4);
  res.redirect('/dashboard');
});

app.get('/locations/:id/edit', requireAuth, (req, res) => {
  const user = getUser(req);
  const loc = db.prepare('SELECT * FROM locations WHERE id=? AND user_id=?').get(req.params.id, user.id);
  if (!loc) return res.redirect('/dashboard');
  res.send(locForm(user, null, loc));
});

app.post('/locations/:id/edit', requireAuth, (req, res) => {
  const user = getUser(req);
  const { business_name, business_type, google_review_url, primary_color, gate_threshold, thank_you_message, header_text, logo_url, color_theme, page_style, custom_bg } = req.body;
  db.prepare('UPDATE locations SET business_name=?,business_type=?,google_review_url=?,primary_color=?,gate_threshold=?,thank_you_message=?,header_text=?,logo_url=?,color_theme=?,page_style=?,custom_bg=? WHERE id=? AND user_id=?')
    .run(business_name,business_type||'',google_review_url,primary_color||'#2563eb',parseInt(gate_threshold)||4,thank_you_message||'Thank you!',header_text||'',logo_url||'',color_theme||'blue',page_style||'professional',custom_bg||'',req.params.id,user.id);
  res.redirect('/dashboard');
});

app.post('/locations/:id/delete', requireAuth, (req, res) => {
  const user = getUser(req);
  db.prepare('DELETE FROM reviews WHERE location_id IN (SELECT id FROM locations WHERE id=? AND user_id=?)').run(req.params.id,user.id);
  db.prepare('DELETE FROM page_views WHERE location_id IN (SELECT id FROM locations WHERE id=? AND user_id=?)').run(req.params.id,user.id);
  db.prepare('DELETE FROM locations WHERE id=? AND user_id=?').run(req.params.id,user.id);
  res.redirect('/dashboard');
});

function locForm(user, error, loc) {
  const isEdit = !!loc;
  const types = ['Restaurant','Salon/Spa','Dental Office','Medical Practice','Auto Shop','Real Estate','Legal Services','Home Services','Retail Store','Fitness/Gym','Other'];
  return dashLayout(user, `<div style="max-width:600px;margin:0 auto">
<h1 style="font-size:28px;margin-bottom:24px">${isEdit?'Edit Location':'Add New Location'}</h1>
${error?`<div class="alert alert-error">${error}</div>`:''}
<div class="card"><form method="POST" action="${isEdit?`/locations/${loc.id}/edit`:'/locations'}">
<div class="form-group"><label>Business Name *</label><input type="text" name="business_name" required value="${esc(loc?.business_name||'')}" placeholder="e.g. Joe's Coffee"></div>
<div class="form-group"><label>Business Type</label><select name="business_type">${types.map(t=>`<option value="${t}" ${loc?.business_type===t?'selected':''}>${t}</option>`).join('')}</select></div>
<div class="form-group"><label>Google Review URL *</label><input type="url" name="google_review_url" required value="${esc(loc?.google_review_url||'')}" placeholder="https://g.page/r/...">
<div class="form-hint">Go to Google Business Profile ‚Üí Share review link</div></div>
<div class="form-group"><label>Brand Color</label><input type="color" name="primary_color" value="${loc?.primary_color||'#2563eb'}" style="width:80px;height:40px;padding:4px"></div>
<div class="form-group"><label>Color Theme</label><select name="color_theme">
${[['blue','üîµ Blue (Default)'],['green','üü¢ Green'],['purple','üü£ Purple'],['orange','üü† Orange']].map(([v,l])=>`<option value="${v}" ${(loc?.color_theme||'blue')===v?'selected':''}>${l}</option>`).join('')}</select></div>
<div class="form-group"><label>Review Page Header Text</label><input type="text" name="header_text" value="${esc(loc?.header_text||'')}" placeholder="e.g. How was your experience?">
<div class="form-hint">Custom heading shown on your review page (default: "How was your experience?")</div></div>
<div class="form-group"><label>Logo / Photo URL</label><input type="url" name="logo_url" value="${esc(loc?.logo_url||'')}" placeholder="https://example.com/logo.png">
<div class="form-hint">Square image works best. Shown at the top of your review page.</div></div>
<div class="form-group"><label>Review Gate Threshold</label><select name="gate_threshold">${[3,4,5].map(n=>`<option value="${n}" ${(loc?.gate_threshold||4)==n?'selected':''}>${n}+ stars ‚Üí Google</option>`).join('')}</select>
<div class="form-hint">Below this rating ‚Üí private feedback form</div></div>
${isEdit?`<div class="form-group"><label>Thank You Message</label><textarea name="thank_you_message" rows="2">${esc(loc?.thank_you_message||'')}</textarea></div>`:''}
<div style="display:flex;gap:12px"><button type="submit" class="btn btn-primary">${isEdit?'Save Changes':'Create Location'}</button><a href="/dashboard" class="btn btn-secondary">Cancel</span></div>
</form></div>
${isEdit?`<div class="card" style="margin-top:24px;border-color:#fecaca"><h3 style="color:#dc2626;margin-bottom:12px">Danger Zone</h3>
<form method="POST" action="/locations/${loc.id}/delete" onsubmit="return confirm('Delete this location?')">
<button type="submit" class="btn btn-danger btn-sm">Delete Location</button></form></div>`:''}</div>`);
}

// ===== ANALYTICS =====
app.get('/locations/:id/analytics', requireAuth, (req, res) => {
  const user = getUser(req);
  const loc = db.prepare('SELECT * FROM locations WHERE id=? AND user_id=?').get(req.params.id,user.id);
  if (!loc) return res.redirect('/dashboard');
  const reviews = db.prepare('SELECT * FROM reviews WHERE location_id=? ORDER BY created_at DESC LIMIT 50').all(loc.id);
  const tv = db.prepare('SELECT COUNT(*) as c FROM page_views WHERE location_id=?').get(loc.id).c;
  const tr = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id=?').get(loc.id).c;
  const gr = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id=? AND redirected_to_google=1').get(loc.id).c;
  const nc = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id=? AND rating<?').get(loc.id,loc.gate_threshold).c;
  const avg = (db.prepare('SELECT AVG(rating) as a FROM reviews WHERE location_id=?').get(loc.id).a||0).toFixed(1);
  const rd = {};
  for (let i=1;i<=5;i++) rd[i] = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id=? AND rating=?').get(loc.id,i).c;

  let bars = '';
  for (let i=5;i>=1;i--) {
    const pct = tr > 0 ? (rd[i]/tr*100) : 0;
    bars += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
<span style="width:24px;text-align:right;font-size:14px;font-weight:600">${i}‚òÖ</span>
<div style="flex:1;background:#f1f5f9;border-radius:4px;height:20px;overflow:hidden">
<div style="height:100%;background:${i>=4?'#22c55e':i===3?'#eab308':'#ef4444'};width:${pct}%;border-radius:4px"></div></div>
<span style="width:30px;font-size:13px;color:#64748b">${rd[i]}</span></div>`;
  }

  let rl = reviews.map(r=>`<div style="padding:16px 0;border-bottom:1px solid #f1f5f9;display:flex;gap:16px">
<div style="font-size:24px">${r.rating>=4?'üòä':r.rating===3?'üòê':'üòü'}</div><div style="flex:1">
<div style="display:flex;justify-content:space-between"><div><strong>${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}</strong>
${r.redirected_to_google?'<span style="font-size:12px;background:#dbeafe;color:#2563eb;padding:2px 8px;border-radius:4px;margin-left:8px">‚Üí Google</span>':'<span style="font-size:12px;background:#fef3c7;color:#d97706;padding:2px 8px;border-radius:4px;margin-left:8px">Private</span>'}
</div><span style="font-size:13px;color:#94a3b8">${new Date(r.created_at).toLocaleDateString()}</span></div>
${r.feedback?`<p style="margin-top:8px;color:#475569;font-size:14px">${esc(r.feedback)}</p>`:''}
${r.customer_name?`<p style="margin-top:4px;font-size:13px;color:#94a3b8">‚Äî ${esc(r.customer_name)}</p>`:''}</div></div>`).join('');

  res.send(dashLayout(user, `<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
<a href="/dashboard" style="color:#64748b;text-decoration:none;font-size:14px">‚Üê Back</span>
<h1 style="font-size:28px">${esc(loc.business_name)} ‚Äî Analytics</h1></div>
<div class="stat-grid">
<div class="stat-card"><div class="stat-value">${tv}</div><div class="stat-label">Page Views</div></div>
<div class="stat-card"><div class="stat-value">${tr}</div><div class="stat-label">Total Reviews</div></div>
<div class="stat-card"><div class="stat-value">${gr}</div><div class="stat-label">Sent to Google</div></div>
<div class="stat-card"><div class="stat-value">${avg}‚òÖ</div><div class="stat-label">Avg Rating</div></div>
<div class="stat-card"><div class="stat-value" style="color:#22c55e">${nc}</div><div class="stat-label">Bad Reviews Caught</div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="card"><h3 style="margin-bottom:16px">Rating Distribution</h3>${bars}</div>
<div class="card"><h3 style="margin-bottom:16px">Conversion Rate</h3>
<div style="text-align:center;padding:20px"><div style="font-size:48px;font-weight:800;color:#2563eb">${tv>0?Math.round(tr/tv*100):0}%</div>
<div style="color:#64748b;font-size:14px;margin-top:8px">Visitors ‚Üí Reviews</div></div></div></div>
<div class="card" style="margin-top:16px"><h3 style="margin-bottom:16px">Recent Reviews</h3>
${rl||'<p style="color:#94a3b8;text-align:center;padding:32px">No reviews yet</p>'}</div>`));
});


// ===== REVIEW ANALYTICS DASHBOARD =====
app.get('/review-analytics', requireAuth, (req, res) => {
  const user = getUser(req);
  const locations = db.prepare('SELECT * FROM locations WHERE user_id = ? ORDER BY created_at DESC').all(user.id);
  const locIds = locations.map(l => l.id);
  
  if (!locIds.length) {
    return res.send(dashLayout(user, '<div style="text-align:center;padding:60px"><h1>Review Analytics</h1><p style="color:#64748b;margin:16px 0">Add a location first to see analytics.</p><a href="/locations/new" class="btn btn-primary">+ Add Location</span></div>'));
  }

  const ph = locIds.map(() => '?').join(',');
  const totalReviews = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id IN (' + ph + ')').get(...locIds).c;
  const avgRating = (db.prepare('SELECT AVG(rating) as a FROM reviews WHERE location_id IN (' + ph + ')').get(...locIds).a || 0).toFixed(1);
  const googleCount = db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id IN (' + ph + ') AND redirected_to_google=1').get(...locIds).c;
  const responseRate = totalReviews > 0 ? Math.round(googleCount / totalReviews * 100) : 0;
  const ratingDist = [];
  for (let i = 1; i <= 5; i++) {
    ratingDist.push(db.prepare('SELECT COUNT(*) as c FROM reviews WHERE location_id IN (' + ph + ') AND rating=?').get(...locIds, i).c);
  }
  const weeklyVolume = db.prepare('SELECT strftime(\'%Y-W%W\', created_at) as week, COUNT(*) as cnt, AVG(rating) as avg_rating FROM reviews WHERE location_id IN (' + ph + ') AND created_at >= datetime(\'now\', \'-84 days\') GROUP BY week ORDER BY week').all(...locIds);
  const bySource = db.prepare('SELECT l.business_name as source, COUNT(r.id) as cnt FROM reviews r JOIN locations l ON r.location_id = l.id WHERE r.location_id IN (' + ph + ') GROUP BY l.business_name ORDER BY cnt DESC LIMIT 8').all(...locIds);
  const monthlyTrends = db.prepare('SELECT strftime(\'%Y-%m\', created_at) as month, COUNT(*) as cnt, AVG(rating) as avg_rating FROM reviews WHERE location_id IN (' + ph + ') AND created_at >= datetime(\'now\', \'-180 days\') GROUP BY month ORDER BY month').all(...locIds);
  const fiveStarMonthly = db.prepare('SELECT strftime(\'%Y-%m\', created_at) as month, SUM(CASE WHEN rating >= 4 THEN 1 ELSE 0 END) as positive, SUM(CASE WHEN rating = 3 THEN 1 ELSE 0 END) as neutral, SUM(CASE WHEN rating <= 2 THEN 1 ELSE 0 END) as negative FROM reviews WHERE location_id IN (' + ph + ') AND created_at >= datetime(\'now\', \'-180 days\') GROUP BY month ORDER BY month').all(...locIds);

  const chartData = {
    weekLabels: weeklyVolume.map(w => w.week),
    weekCounts: weeklyVolume.map(w => w.cnt),
    monthLabels: monthlyTrends.map(m => m.month),
    monthAvgs: monthlyTrends.map(m => Math.round(m.avg_rating * 10) / 10),
    sourceLabels: bySource.map(s => s.source),
    sourceCounts: bySource.map(s => s.cnt),
    sentimentLabels: fiveStarMonthly.map(m => m.month),
    sentimentPos: fiveStarMonthly.map(m => m.positive),
    sentimentNeu: fiveStarMonthly.map(m => m.neutral),
    sentimentNeg: fiveStarMonthly.map(m => m.negative),
    ratingDist: ratingDist
  };

  const content = '<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"><\/script>' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px">' +
    '<div><h1 style="font-size:28px">üìä Review Analytics Dashboard</h1>' +
    '<p style="color:#64748b;font-size:14px">Insights across all your locations</p></div>' +
    '<a href="/dashboard" class="btn btn-secondary btn-sm">\u2190 Back to Dashboard</span></div>' +
    '<div class="stat-grid" style="margin-bottom:32px">' +
    '<div class="stat-card"><div class="stat-value">' + totalReviews + '</div><div class="stat-label">Total Reviews</div></div>' +
    '<div class="stat-card"><div class="stat-value" style="color:#f59e0b">' + avgRating + ' \u2605</div><div class="stat-label">Average Rating</div></div>' +
    '<div class="stat-card"><div class="stat-value" style="color:#22c55e">' + responseRate + '%</div><div class="stat-label">Google Redirect Rate</div></div>' +
    '<div class="stat-card"><div class="stat-value" style="color:#3b82f6">' + locations.length + '</div><div class="stat-label">Active Locations</div></div></div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">' +
    '<div class="card" style="padding:24px"><h3 style="margin-bottom:16px">\ud83d\udcc8 Review Volume Over Time</h3><canvas id="volumeChart" height="220"></canvas></div>' +
    '<div class="card" style="padding:24px"><h3 style="margin-bottom:16px">\u2b50 Average Rating Trend</h3><canvas id="ratingChart" height="220"></canvas></div></div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">' +
    '<div class="card" style="padding:24px"><h3 style="margin-bottom:16px">\ud83c\udfe2 Reviews by Location</h3><canvas id="sourceChart" height="260"></canvas></div>' +
    '<div class="card" style="padding:24px"><h3 style="margin-bottom:16px">\ud83d\ude0a Sentiment Over Time</h3><canvas id="sentimentChart" height="260"></canvas></div></div>' +
    '<div class="card" style="padding:24px;margin-bottom:24px"><h3 style="margin-bottom:16px">\ud83d\udcca Rating Distribution</h3><canvas id="distChart" height="100"></canvas></div>' +
    '<script>const CD=' + JSON.stringify(chartData) + ';document.addEventListener("DOMContentLoaded",function(){' +
    'Chart.defaults.font.family="-apple-system,BlinkMacSystemFont,sans-serif";' +
    'new Chart(document.getElementById("volumeChart"),{type:"line",data:{labels:CD.weekLabels,datasets:[{label:"Reviews",data:CD.weekCounts,borderColor:"#3b82f6",backgroundColor:"rgba(59,130,246,0.1)",fill:true,tension:0.4,pointRadius:4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{ticks:{maxRotation:45}}}}});' +
    'new Chart(document.getElementById("ratingChart"),{type:"line",data:{labels:CD.monthLabels,datasets:[{label:"Avg Rating",data:CD.monthAvgs,borderColor:"#f59e0b",backgroundColor:"rgba(245,158,11,0.1)",fill:true,tension:0.4,pointRadius:5}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{min:1,max:5,ticks:{stepSize:0.5}}}}});' +
    'new Chart(document.getElementById("sourceChart"),{type:"doughnut",data:{labels:CD.sourceLabels,datasets:[{data:CD.sourceCounts,backgroundColor:["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899","#14b8a6","#f97316"]}]},options:{responsive:true,plugins:{legend:{position:"bottom"}}}});' +
    'new Chart(document.getElementById("sentimentChart"),{type:"bar",data:{labels:CD.sentimentLabels,datasets:[{label:"Positive (4-5‚òÖ)",data:CD.sentimentPos,backgroundColor:"#22c55e"},{label:"Neutral (3‚òÖ)",data:CD.sentimentNeu,backgroundColor:"#f59e0b"},{label:"Negative (1-2‚òÖ)",data:CD.sentimentNeg,backgroundColor:"#ef4444"}]},options:{responsive:true,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}},plugins:{legend:{position:"bottom"}}}});' +
    'new Chart(document.getElementById("distChart"),{type:"bar",data:{labels:["1‚òÖ","2‚òÖ","3‚òÖ","4‚òÖ","5‚òÖ"],datasets:[{data:CD.ratingDist,backgroundColor:["#ef4444","#f97316","#f59e0b","#84cc16","#22c55e"],borderRadius:8}]},options:{indexAxis:"y",responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{stepSize:1}}}}});' +
    '});<\/script>';

  res.send(dashLayout(user, content));
});


// ===== QR CODE =====
app.get('/locations/:id/qr', requireAuth, async (req, res) => {
  const user = getUser(req);
  const loc = db.prepare('SELECT * FROM locations WHERE id=? AND user_id=?').get(req.params.id,user.id);
  if (!loc) return res.redirect('/dashboard');
  const url = `${BASE_URL}/r/${loc.slug}`;
  const qr = await QRCode.toDataURL(url, { width: 400, margin: 2 });
  res.send(dashLayout(user, `<div style="max-width:600px;margin:0 auto;text-align:center">
<a href="/dashboard" style="color:#64748b;text-decoration:none;font-size:14px;display:block;text-align:left;margin-bottom:16px">‚Üê Back</span>
<h1 style="font-size:28px;margin-bottom:8px">QR Code</h1><p style="color:#64748b;margin-bottom:24px">${esc(loc.business_name)}</p>
<div class="card" style="padding:40px"><img src="${qr}" style="width:280px;height:280px;margin:0 auto;display:block">
<p style="margin-top:24px;font-size:14px;color:#64748b;word-break:break-all">${url}</p>
<div style="margin-top:24px;display:flex;gap:12px;justify-content:center">
<a href="/locations/${loc.id}/qr.png" download="reviewflow-qr.png" class="btn btn-primary">Download PNG</span>
<button onclick="navigator.clipboard.writeText('${url}');this.textContent='Copied!'" class="btn btn-secondary">Copy Link</button></div></div>
<div class="card" style="text-align:left;margin-top:16px"><h3 style="margin-bottom:12px">üí° Where to use your QR code</h3>
<ul style="color:#475569;font-size:15px;list-style:disc;padding-left:20px;line-height:2">
<li>Print on receipts</li><li>Display at your counter</li><li>Table tents in restaurants</li><li>Business cards</li><li>Email signatures</li></ul></div></div>`));
});

app.get('/locations/:id/qr.png', requireAuth, async (req, res) => {
  const user = getUser(req);
  const loc = db.prepare('SELECT * FROM locations WHERE id=? AND user_id=?').get(req.params.id,user.id);
  if (!loc) return res.status(404).send('Not found');
  const buf = await QRCode.toBuffer(`${BASE_URL}/r/${loc.slug}`, { width: 600, margin: 2 });
  res.type('image/png').send(buf);
});

// ===== SHARE =====
app.get('/locations/:id/share', requireAuth, (req, res) => {
  const user = getUser(req);
  const loc = db.prepare('SELECT * FROM locations WHERE id=? AND user_id=?').get(req.params.id,user.id);
  if (!loc) return res.redirect('/dashboard');
  const url = `${BASE_URL}/r/${loc.slug}`;
  const sms = `Hi! Thanks for visiting ${loc.business_name}. We'd love your feedback ‚Äî takes 30 seconds: ${url}`;
  const emailBody = `Hi there,\n\nThank you for choosing ${loc.business_name}!\n\nWe'd really appreciate it if you could share your feedback:\n${url}\n\nThank you!\n${loc.business_name}`;
  res.send(dashLayout(user, `<div style="max-width:700px;margin:0 auto">
<a href="/dashboard" style="color:#64748b;text-decoration:none;font-size:14px;display:block;margin-bottom:16px">‚Üê Back</span>
<h1 style="font-size:28px;margin-bottom:24px">Share &amp; Templates ‚Äî ${esc(loc.business_name)}</h1>
<div class="card"><h3 style="margin-bottom:12px">üìã Your Review Link</h3>
<div style="display:flex;gap:8px"><input type="text" value="${url}" readonly style="background:#f8fafc" id="link">
<button onclick="navigator.clipboard.writeText(document.getElementById('link').value);this.textContent='Copied!'" class="btn btn-primary btn-sm" style="white-space:nowrap">Copy Link</button></div></div>
<div class="card"><h3 style="margin-bottom:12px">üí¨ SMS Template</h3>
<textarea id="sms" rows="3" style="background:#f8fafc" readonly>${sms}</textarea>
<button onclick="navigator.clipboard.writeText(document.getElementById('sms').value);this.textContent='Copied!'" class="btn btn-secondary btn-sm" style="margin-top:8px">Copy SMS</button></div>
<div class="card"><h3 style="margin-bottom:12px">‚úâÔ∏è Email Template</h3>
<div class="form-group"><label>Subject</label><input type="text" value="How was your experience at ${esc(loc.business_name)}?" readonly style="background:#f8fafc" id="subj"></div>
<textarea id="ebody" rows="6" style="background:#f8fafc" readonly>${esc(emailBody)}</textarea>
<button onclick="navigator.clipboard.writeText(document.getElementById('subj').value+'\\n\\n'+document.getElementById('ebody').value);this.textContent='Copied!'" class="btn btn-secondary btn-sm" style="margin-top:8px">Copy Email</button></div>
<div class="card"><h3 style="margin-bottom:12px">üñ®Ô∏è Print Materials</h3><a href="/locations/${loc.id}/qr" class="btn btn-secondary btn-sm">Get QR Code ‚Üí</span></div></div>`));
});

// ===== DEMO PREVIEW PAGE =====
app.get('/demo/:name', (req, res) => {
  const name = decodeURIComponent(req.params.name).slice(0,100);
  const c = req.query.color || '#2563eb';
  const th = 4;
  res.send(`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Demo ‚Äî ${esc(name)} | ReviewFlow</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fafc;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
.demo-bar{position:fixed;top:0;left:0;right:0;background:#1e293b;color:#fff;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;z-index:99;font-size:14px}
.demo-bar a{color:#fff;background:#2563eb;padding:8px 20px;border-radius:8px;text-decoration:none;font-weight:600;font-size:14px}
.rc{background:#fff;border-radius:20px;box-shadow:0 4px 24px rgba(0,0,0,.08);max-width:420px;width:100%;padding:40px 32px;text-align:center;margin-top:40px}
.bn{font-size:24px;font-weight:700;margin-bottom:8px;color:#1e293b}
.prompt{font-size:18px;color:#475569;margin-bottom:24px}
.stars{display:flex;justify-content:center;gap:8px;margin-bottom:32px}
.star{font-size:48px;cursor:pointer;transition:transform .15s;user-select:none;filter:grayscale(1) opacity(.3)}
.star:hover,.star.active{filter:none;transform:scale(1.2)}
.ff{display:none;margin-top:24px;text-align:left}.ff.show{display:block}
.ff label{font-weight:600;font-size:14px;margin-bottom:6px;display:block;color:#374151}
.ff input,.ff textarea{width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:15px;font-family:inherit;margin-bottom:16px}
.sb{width:100%;padding:14px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;background:${esc(c)};color:#fff}
.result{display:none;text-align:center}.result.show{display:block}
.pw{margin-top:32px;font-size:12px;color:#cbd5e1}
</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<div class="demo-bar"><span>üîç This is a demo preview ‚Äî <strong>${esc(name)}</strong></span><a href="/signup">Create Your Own ‚Üí</span></div>
<div class="rc">
<div id="s1"><div class="bn">${esc(name)}</div>
<div class="prompt">How was your experience?</div>
<div class="stars">${[1,2,3,4,5].map(i=>`<div class="star" data-r="${i}" onclick="sel(${i})">‚≠ê</div>`).join('')}</div></div>
<div id="s2" class="ff">
<div id="fp" style="display:none;text-align:center;margin-bottom:24px"><div style="font-size:48px;margin-bottom:12px">üéâ</div>
<p style="font-size:18px;color:#475569">We're thrilled! Would you share your experience on Google?</p></div>
<div id="fn" style="display:none"><p style="font-size:16px;color:#475569;margin-bottom:20px;text-align:center">We're sorry. Please tell us how we can improve:</p>
<label>Your Name (optional)</label><input type="text" placeholder="Your name">
<label>What could we do better?</label><textarea rows="4" placeholder="Tell us about your experience..."></textarea></div>
<button class="sb" id="sbtn" onclick="demoSubmit()">Submit</button></div>
<div id="s3" class="result"><div style="font-size:64px;margin-bottom:16px" id="ri">üôè</div><div style="font-size:18px;color:#475569" id="rm"></div>
<div style="margin-top:24px"><a href="/signup" style="display:inline-block;padding:12px 24px;background:${esc(c)};color:#fff;border-radius:8px;text-decoration:none;font-weight:600">Get This For Your Business ‚Üí</span></div></div>
<div class="pw">Powered by <a href="/" style="color:#94a3b8;text-decoration:none">ReviewFlow</span></div></div>
<script>
let rating=0;
function sel(r){rating=r;document.querySelectorAll('.star').forEach((s,i)=>s.classList.toggle('active',i<r));
setTimeout(()=>{document.getElementById('s1').style.display='none';const f=document.getElementById('s2');f.classList.add('show');
if(r>=${th}){document.getElementById('fp').style.display='block';document.getElementById('fn').style.display='none';document.getElementById('sbtn').textContent='Leave a Google Review ‚Üí'}
else{document.getElementById('fp').style.display='none';document.getElementById('fn').style.display='block';document.getElementById('sbtn').textContent='Send Private Feedback'}},300)}
function demoSubmit(){document.getElementById('s2').style.display='none';var res=document.getElementById('s3');res.classList.add('show');
if(rating>=${th}){document.getElementById('ri').textContent='üåü';document.getElementById('rm').innerHTML='In production, the customer would be redirected to <strong>Google Reviews</strong> right now.'}
else{document.getElementById('ri').textContent='üõ°Ô∏è';document.getElementById('rm').innerHTML='This negative feedback stays <strong>private</strong> ‚Äî it never reaches Google.'}}
</script></body></html>`);
});

// ===== PUBLIC REVIEW PAGE =====
app.get('/r/:slug', (req, res) => {
  const loc = db.prepare('SELECT * FROM locations WHERE slug=?').get(req.params.slug);
  if (!loc) return res.status(404).send(notFoundPage());
  db.prepare('INSERT INTO page_views (location_id) VALUES (?)').run(loc.id);
  const themeColors = { blue: '#2563eb', green: '#16a34a', purple: '#7c3aed', orange: '#ea580c' };
  const c = themeColors[loc.color_theme] || loc.primary_color || '#2563eb';
  const themeBg = { blue: 'linear-gradient(135deg,#eff6ff,#f8fafc)', green: 'linear-gradient(135deg,#f0fdf4,#f8fafc)', purple: 'linear-gradient(135deg,#f5f3ff,#f8fafc)', orange: 'linear-gradient(135deg,#fff7ed,#f8fafc)' };
  const pageStyle = loc.page_style || 'professional';
  const customBg = loc.custom_bg || '';
  let bg;
  if (pageStyle === 'minimal') bg = '#f8fafc';
  else if (pageStyle === 'premium' && customBg) bg = customBg.startsWith('http') ? `url(${customBg}) center/cover no-repeat fixed` : customBg;
  else bg = themeBg[loc.color_theme] || themeBg.blue;
  const headerText = loc.header_text || 'How was your experience?';
  const showLogo = pageStyle !== 'minimal';
  const showBizType = pageStyle !== 'minimal';
  const showBranding = pageStyle !== 'minimal';
  const logoHtml = (showLogo && loc.logo_url) ? `<img src="${esc(loc.logo_url)}" alt="${esc(loc.business_name)}" style="width:${pageStyle==='premium'?'96':'80'}px;height:${pageStyle==='premium'?'96':'80'}px;border-radius:50%;object-fit:cover;margin-bottom:12px;border:3px solid ${c}20">` : '';
  const cardShadow = pageStyle === 'premium' ? '0 8px 40px rgba(0,0,0,.15)' : '0 4px 24px rgba(0,0,0,.08)';
  const cardRadius = pageStyle === 'minimal' ? '12px' : '20px';
  const cardPadding = pageStyle === 'minimal' ? '32px 24px' : '40px 28px';
  res.send(`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Review ${esc(loc.business_name)}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:${bg};min-height:100vh;min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:16px}
.rc{background:${pageStyle==='premium'?'rgba(255,255,255,.95)':'#fff'};border-radius:${cardRadius};box-shadow:${cardShadow};max-width:420px;width:100%;padding:${cardPadding};text-align:center;${pageStyle==='premium'?'backdrop-filter:blur(10px);':''}}
.bn{font-size:${pageStyle==='premium'?'28':'24'}px;font-weight:700;margin-bottom:8px;color:#1e293b;word-wrap:break-word}.bt{font-size:14px;color:#94a3b8;margin-bottom:32px}
.prompt{font-size:18px;color:#475569;margin-bottom:24px}
.stars{display:flex;justify-content:center;gap:8px;margin-bottom:32px;-webkit-tap-highlight-color:transparent}
.star{font-size:48px;cursor:pointer;transition:transform .15s;user-select:none;filter:grayscale(1) opacity(.3);-webkit-tap-highlight-color:transparent}
.star:hover,.star.active{filter:none;transform:scale(1.2)}
.ff{display:none;margin-top:24px;text-align:left}.ff.show{display:block}
.ff label{font-weight:600;font-size:14px;margin-bottom:6px;display:block;color:#374151}
.ff input,.ff textarea{width:100%;padding:12px 14px;border:1px solid #d1d5db;border-radius:10px;font-size:16px;font-family:inherit;margin-bottom:16px;-webkit-appearance:none}
.ff input:focus,.ff textarea:focus{outline:none;border-color:${c}}
.sb{width:100%;padding:16px;border:none;border-radius:12px;font-size:17px;font-weight:600;cursor:pointer;background:${c};color:#fff;transition:opacity .2s;-webkit-appearance:none}.sb:hover{opacity:.9}.sb:active{transform:scale(.98)}
.result{display:none;text-align:center}.result.show{display:block}.ri{font-size:64px;margin-bottom:16px}.rm{font-size:18px;color:#475569}
.pw{margin-top:32px;font-size:12px;color:#cbd5e1}.pw a{color:#94a3b8;text-decoration:none}
@media(max-width:480px){.rc{padding:32px 20px;border-radius:16px}.bn{font-size:22px}.star{font-size:42px;gap:6px}.prompt{font-size:16px}.sb{font-size:16px;padding:14px}}
@media(max-width:360px){.star{font-size:36px}}
</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<div class="rc">
<div id="s1">${logoHtml}${showBranding?`<div class="bn">${esc(loc.business_name)}</div>`:''}
${showBizType&&loc.business_type?`<div class="bt">${esc(loc.business_type)}</div>`:''}
<div class="prompt">${esc(headerText)}</div>
<div class="stars" id="stars">${[1,2,3,4,5].map(i=>`<div class="star" data-r="${i}" onclick="sel(${i})">‚≠ê</div>`).join('')}</div></div>
<div id="s2" class="ff">
<div id="fp" style="display:none;text-align:center;margin-bottom:24px"><div style="font-size:48px;margin-bottom:12px">üéâ</div>
<p style="font-size:18px;color:#475569">We're thrilled! Would you share your experience on Google?</p></div>
<div id="fn" style="display:none"><p style="font-size:16px;color:#475569;margin-bottom:20px;text-align:center">We're sorry. Please tell us how we can improve:</p>
<label>Your Name (optional)</label><input type="text" id="cn" placeholder="Your name">
<label>Email (optional)</label><input type="email" id="ce" placeholder="your@email.com">
<label>What could we do better?</label><textarea id="fb" rows="4" placeholder="Tell us about your experience..."></textarea></div>
<button class="sb" onclick="submit()" id="sbtn">Submit</button></div>
<div id="s3" class="result"><div class="ri" id="ri">üôè</div><div class="rm" id="rm"></div></div>
<div class="pw">Powered by <a href="${BASE_URL}">ReviewFlow</span></div></div>
<script>
let rating=0;const th=${loc.gate_threshold};
function sel(r){rating=r;document.querySelectorAll('.star').forEach((s,i)=>s.classList.toggle('active',i<r));
setTimeout(()=>{document.getElementById('s1').style.display='none';const f=document.getElementById('s2');f.classList.add('show');
if(r>=th){document.getElementById('fp').style.display='block';document.getElementById('fn').style.display='none';document.getElementById('sbtn').textContent='Leave a Google Review ‚Üí'}
else{document.getElementById('fp').style.display='none';document.getElementById('fn').style.display='block';document.getElementById('sbtn').textContent='Send Feedback'}},300)}
async function submit(){const b=document.getElementById('sbtn');b.disabled=true;b.textContent='Submitting...';
try{const r=await fetch('/r/${loc.slug}/submit',{method:'POST',headers:{'Content-Type':'application/json'},
body:JSON.stringify({rating,feedback:document.getElementById('fb')?.value||'',customer_name:document.getElementById('cn')?.value||'',customer_email:document.getElementById('ce')?.value||''})});
const d=await r.json();document.getElementById('s2').style.display='none';const res=document.getElementById('s3');res.classList.add('show');
if(d.redirect&&d.google_url){document.getElementById('ri').textContent='üåü';document.getElementById('rm').textContent='Thank you! Redirecting to Google...';
setTimeout(()=>window.location.href=d.google_url,1500)}else{document.getElementById('ri').textContent='üôè';document.getElementById('rm').textContent=d.message||'Thank you!'}}
catch(e){b.disabled=false;b.textContent='Try Again'}}
</script></body></html>`);
});

app.post('/r/:slug/submit', (req, res) => {
  const loc = db.prepare('SELECT * FROM locations WHERE slug=?').get(req.params.slug);
  if (!loc) return res.status(404).json({ error: 'Not found' });
  const { rating, feedback, customer_name, customer_email } = req.body;
  const r = parseInt(rating);
  if (!r || r < 1 || r > 5) return res.status(400).json({ error: 'Invalid rating' });
  const redir = r >= loc.gate_threshold;
  db.prepare('INSERT INTO reviews (id,location_id,rating,feedback,customer_name,customer_email,redirected_to_google) VALUES (?,?,?,?,?,?,?)')
    .run(uuidv4(), loc.id, r, feedback||'', customer_name||'', customer_email||'', redir?1:0);
  // Create notification for negative reviews
  if (!redir) {
    const owner = db.prepare('SELECT user_id FROM locations WHERE id=?').get(loc.id);
    if (owner) {
      const msg = `‚ö†Ô∏è New ${r}-star review at ${loc.business_name}${customer_name ? ' from '+customer_name : ''} ‚Äî Email notification sent!`;
      db.prepare('INSERT INTO notifications (id,user_id,location_id,type,message) VALUES (?,?,?,?,?)').run(uuidv4(), owner.user_id, loc.id, 'negative_review', msg);
    }
  }
  res.json({ success: true, redirect: redir, google_url: redir ? loc.google_review_url : null, message: redir ? 'Redirecting...' : loc.thank_you_message });
});

// ===== PRICING / STRIPE =====
app.get('/pricing', (req, res) => {
  const user = getUser(req);
  const loggedIn = !!user;
  res.send(`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pricing ‚Äî ReviewFlow</title>${css()}
<style>body{background:#f8fafc}.pw{max-width:900px;margin:0 auto;padding:60px 24px}
.pg{display:grid;grid-template-columns:repeat(3,1fr);gap:24px}
.pc{background:#fff;border:2px solid #e2e8f0;border-radius:16px;padding:32px;text-align:center}
.pc.ft{border-color:#2563eb}.pc h3{font-size:22px;margin-bottom:4px}
.pc .pr{font-size:42px;font-weight:800;margin:16px 0}.pc .pr span{font-size:16px;color:#64748b;font-weight:400}
.pc ul{list-style:none;text-align:left;margin:20px 0}.pc li{padding:8px 0;font-size:15px}.pc li::before{content:'‚úì ';color:#22c55e;font-weight:700}
@media(max-width:768px){.pg{grid-template-columns:1fr}}</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span>
<div class="nav-links">${loggedIn?'<a href="/dashboard">Dashboard</span><a href="/logout">Log Out</span>':'<a href="/login">Log In</span><a href="/signup" class="btn btn-primary btn-sm">Sign Up</span>'}</div></div></nav>
<div class="pw"><h1 style="text-align:center;font-size:36px;margin-bottom:40px">Choose Your Plan</h1>
<div class="pg">
<div class="pc"><h3>Free</h3><div class="pr">$0<span>/mo</span></div>
<ul><li>1 location</li><li>Branded review page</li><li>QR code</li><li>Smart review gate</li><li>Basic analytics</li></ul>
${loggedIn&&user.plan==='free'?'<div class="btn btn-secondary" style="width:100%;opacity:.6">Current Plan</div>':'<a href="/signup" class="btn btn-secondary" style="width:100%">Get Started</span>'}</div>
<div class="pc ft"><h3>Starter</h3><div class="pr">$29<span>/mo</span></div>
<ul><li>Everything in Free</li><li>SMS &amp; email templates</li><li>Advanced analytics</li><li>Custom messages</li><li>Priority support</li></ul>
${loggedIn?(user.plan==='starter'?'<div class="btn btn-secondary" style="width:100%;opacity:.6">Current Plan</div>':`<button onclick="checkout('starter')" class="btn btn-primary" style="width:100%">Upgrade</button>`):'<a href="/signup" class="btn btn-primary" style="width:100%">Start Free Trial</span>'}</div>
<div class="pc"><h3>Growth</h3><div class="pr">$79<span>/mo</span></div>
<ul><li>Everything in Starter</li><li>Up to 5 locations</li><li>Team access</li><li>Response templates</li><li>Dedicated support</li></ul>
${loggedIn?(user.plan==='growth'?'<div class="btn btn-secondary" style="width:100%;opacity:.6">Current Plan</div>':`<button onclick="checkout('growth')" class="btn btn-primary" style="width:100%">Upgrade</button>`):'<a href="/signup" class="btn btn-secondary" style="width:100%">Start Free Trial</span>'}</div>
</div></div>
<script>async function checkout(p){const r=await fetch('/create-checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan:p})});const d=await r.json();if(d.url)window.location.href=d.url;else alert('Error')}</script>
</body></html>`);
});

app.post('/create-checkout', requireAuth, async (req, res) => {
  const user = getUser(req);
  const prices = { starter: { amount: 2900, name: 'ReviewFlow Starter' }, growth: { amount: 7900, name: 'ReviewFlow Growth' } };
  const sel = prices[req.body.plan];
  if (!sel) return res.status(400).json({ error: 'Invalid plan' });
  try {
    let cid = user.stripe_customer_id;
    if (!cid) { const c = await stripe.customers.create({ email: user.email, metadata: { userId: user.id } }); cid = c.id; db.prepare('UPDATE users SET stripe_customer_id=? WHERE id=?').run(cid, user.id); }
    const s = await stripe.checkout.sessions.create({ customer: cid, payment_method_types: ['card'],
      line_items: [{ price_data: { currency: 'usd', product_data: { name: sel.name }, unit_amount: sel.amount, recurring: { interval: 'month' } }, quantity: 1 }],
      mode: 'subscription', success_url: `${BASE_URL}/billing/success?session_id={CHECKOUT_SESSION_ID}`, cancel_url: `${BASE_URL}/pricing` });
    res.json({ url: s.url });
  } catch (e) { console.error('Stripe:', e); res.status(500).json({ error: 'Payment error' }); }
});

app.get('/billing/success', requireAuth, async (req, res) => {
  const user = getUser(req);
  try {
    const s = await stripe.checkout.sessions.retrieve(req.query.session_id);
    const plan = s.amount_total === 7900 ? 'growth' : 'starter';
    db.prepare('UPDATE users SET plan=?,stripe_subscription_id=? WHERE id=?').run(plan, s.subscription, user.id);
  } catch (e) {}
  res.redirect('/dashboard');
});

// ===== EMAIL SIGNUP =====
app.post('/api/email-signup', (req, res) => {
  const { email } = req.body;
  if (!email || !email.includes('@')) return res.json({ error: 'Please enter a valid email' });
  try {
    db.prepare('INSERT OR IGNORE INTO email_signups (email) VALUES (?)').run(email);
    res.json({ success: true });
  } catch (e) { res.json({ success: true }); }
});

// ===== GOOGLE PLACES SEARCH API =====
app.get('/api/places-search', requireAuth, async (req, res) => {
  const q = (req.query.q || '').trim();
  if (!q || q.length < 2) return res.json({ results: [] });
  const apiKey = process.env.GOOGLE_PLACES_API_KEY || '';
  if (apiKey) {
    try {
      const resp = await fetch('https://places.googleapis.com/v1/places:searchText', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'places.id,places.displayName,places.formattedAddress,places.googleMapsUri' },
        body: JSON.stringify({ textQuery: q, maxResultCount: 5 })
      });
      const data = await resp.json();
      if (data.places) {
        return res.json({ results: data.places.map(p => ({
          name: p.displayName?.text || '',
          address: p.formattedAddress || '',
          placeId: p.id || '',
          reviewUrl: p.id ? 'https://search.google.com/local/writereview?placeid=' + p.id : '',
          mapsUrl: p.googleMapsUri || ''
        }))});
      }
    } catch(e) { console.error('Places API error:', e); }
  }
  // Fallback: return constructed Google Maps search URL
  res.json({ results: [], fallback: true, searchUrl: 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(q) });
});

// ===== ONBOARDING WIZARD =====
app.get('/onboarding', requireAuth, (req, res) => {
  const user = getUser(req);
  const hasLocation = db.prepare('SELECT COUNT(*) as c FROM locations WHERE user_id = ?').get(user.id).c > 0;
  if (hasLocation) return res.redirect('/dashboard');
  res.send(`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Set Up Your Business ‚Äî ReviewFlow</title>${css()}
<style>
body{background:#f8fafc}.onb-wrap{max-width:560px;margin:40px auto;padding:0 20px}
.onb-card{background:#fff;border-radius:20px;border:1px solid #e2e8f0;padding:40px;box-shadow:0 4px 24px rgba(0,0,0,.06)}
.onb-card h1{font-size:26px;text-align:center;margin-bottom:4px}
.onb-card .subtitle{text-align:center;color:#64748b;margin-bottom:32px;font-size:15px}
.step-indicators{display:flex;justify-content:center;gap:8px;margin-bottom:32px}
.step-dot{width:12px;height:12px;border-radius:50%;background:#e2e8f0;transition:all .3s}
.step-dot.active{background:#2563eb;width:32px;border-radius:6px}
.step-dot.done{background:#22c55e}
.onb-step{display:none}.onb-step.active{display:block}
.onb-step h2{font-size:20px;margin-bottom:8px;text-align:center}
.onb-step .step-desc{color:#64748b;font-size:14px;text-align:center;margin-bottom:24px}
.onb-next{width:100%;padding:14px;font-size:16px;margin-top:16px}
.onb-skip{display:block;text-align:center;margin-top:12px;color:#94a3b8;font-size:14px;text-decoration:none}
.onb-preview{background:#f8fafc;border-radius:16px;padding:24px;text-align:center;border:1px solid #e2e8f0;margin:16px 0}
.onb-preview .preview-name{font-size:20px;font-weight:700;margin-bottom:4px}
.onb-preview .preview-stars{font-size:32px;letter-spacing:4px}
.onb-qr{width:200px;height:200px;margin:16px auto;display:block;border-radius:12px}
@media(max-width:480px){.onb-card{padding:24px 20px}.onb-card h1{font-size:22px}}
</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/dashboard" class="nav-brand">‚≠ê ReviewFlow</span><div></div></div></nav>
<div class="onb-wrap"><div class="onb-card">
<h1>üéâ Welcome to ReviewFlow!</h1>
<p class="subtitle">Let's get your review page live in 4 easy steps</p>
<div class="step-indicators"><div class="step-dot active" id="dot0"></div><div class="step-dot" id="dot1"></div><div class="step-dot" id="dot2"></div><div class="step-dot" id="dot3"></div></div>

<div class="onb-step active" id="step0">
<h2>1. Your Business Name</h2>
<p class="step-desc">What's the name customers know you by?</p>
<div class="form-group" style="position:relative">
<input type="text" id="ob-name" placeholder="e.g. Joe's Coffee Shop" value="${esc(user.business_name||'')}" style="font-size:18px;padding:14px 18px;text-align:center" oninput="onNameInput(this.value)" autocomplete="off">
<div id="name-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:10;margin-top:4px;max-height:280px;overflow-y:auto"></div>
</div>
<div class="form-group"><label>Business Type</label><select id="ob-type" style="text-align:center" onchange="showIndustryPreview(this.value)">${['Restaurant','Salon/Spa','Dental Office','Medical Practice','Auto Shop','Real Estate','Legal Services','Home Services','Retail Store','Fitness/Gym','Other'].map(t=>`<option value="${t}">${t}</option>`).join('')}</select></div>
<div id="industry-preview" style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:16px;margin-bottom:16px;display:none">
<div style="font-size:13px;color:#16a34a;font-weight:600;margin-bottom:8px">‚ú® Pre-filled template for your industry:</div>
<div id="industry-sms" style="font-size:13px;color:#475569;background:#fff;padding:10px;border-radius:8px;border:1px solid #e2e8f0"></div>
</div>
<button class="btn btn-primary onb-next" onclick="goStep(1)">Continue ‚Üí</button>
</div>

<div class="onb-step" id="step1">
<h2>2. Google Review Link</h2>
<p class="step-desc">Find your business or paste your Google review link</p>

<div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:16px;margin-bottom:20px">
<label style="font-size:14px;font-weight:600;margin-bottom:8px;display:block">üîç Search for your business</label>
<div style="display:flex;gap:8px"><input type="text" id="ob-places-q" placeholder="e.g. Joe's Coffee Austin TX" autocomplete="off" style="flex:1;font-size:15px;padding:10px 14px">
<button type="button" class="btn btn-primary btn-sm" onclick="searchPlaces()" style="white-space:nowrap">Search</button></div>
<div id="places-results" style="margin-top:12px;display:none"></div>
</div>

<div class="form-group"><label style="font-size:14px">Or paste your Google review link directly:</label>
<input type="text" id="ob-url" placeholder="https://g.page/r/..." autocomplete="off" style="font-size:16px;padding:14px 18px">
<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px 14px;margin-top:8px;font-size:13px;color:#6b7280;pointer-events:none;user-select:text">
üí° Go to your Google Business Profile ‚Üí click "Ask for reviews" ‚Üí copy the link
</div></div>

<details style="margin-bottom:16px;background:#fff;border:1px solid #e2e8f0;border-radius:10px">
<summary style="padding:12px 16px;cursor:pointer;font-size:14px;font-weight:600;color:#2563eb;list-style:none;display:flex;align-items:center;gap:8px">
<span style="transition:transform .2s;display:inline-block">‚ñ∂</span> How to find your Google review link
</summary>
<div style="padding:0 16px 16px;font-size:13px;color:#475569;line-height:1.8">
<ol style="padding-left:18px;margin:8px 0">
<li><strong>Search for your business</strong> on Google (e.g. "Joe's Coffee Austin")</li>
<li>Click on your <strong>Google Business Profile</strong> in the search results</li>
<li>Click the <strong>"Ask for reviews"</strong> button (or "Get more reviews")</li>
<li>A popup will show your review link ‚Äî <strong>copy it</strong></li>
<li>Paste it in the field above</li>
</ol>
<div style="background:#fef3c7;border-radius:8px;padding:10px 12px;margin-top:8px;font-size:12px;color:#92400e">
‚ö†Ô∏è <strong>Don't have a Google Business Profile?</strong> You can create one free at <span style="font-weight:600">business.google.com</span> ‚Äî or use the search above to find your business and we'll generate a link for you.
</div>
</div></details>

<button class="btn btn-primary onb-next" onclick="goStep(2)">Continue ‚Üí</button>
<button type="button" class="btn btn-secondary" onclick="document.getElementById('ob-url').value='';goStep(2)" style="width:100%;margin-top:8px;padding:14px;font-size:15px;background:#f8fafc;border:2px dashed #cbd5e1;color:#64748b">‚è≠Ô∏è I'll add this later ‚Äî you can always update it from your dashboard</button>
</div>

<div class="onb-step" id="step2">
<h2>3. Customize Your Page</h2>
<p class="step-desc">Pick a brand color for your review page</p>
<div style="text-align:center;margin-bottom:20px"><input type="color" id="ob-color" value="#2563eb" style="width:80px;height:80px;border:3px solid #e2e8f0;border-radius:16px;cursor:pointer;padding:6px" oninput="updatePreview()"></div>
<div class="onb-preview"><div class="preview-name" id="ob-preview-name">Your Business</div><div style="color:#64748b;font-size:14px;margin-bottom:8px">How was your experience?</div>
<div class="preview-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div></div>
<button class="btn btn-primary onb-next" onclick="goStep(3)">Continue ‚Üí</button>
</div>

<div class="onb-step" id="step3">
<h2>4. You're All Set! üöÄ</h2>
<p class="step-desc">Your review page is being created...</p>
<div id="ob-final" style="text-align:center;padding:20px">
<div style="font-size:48px;margin-bottom:16px">‚è≥</div>
<p style="color:#64748b">Creating your page...</p>
</div>
</div>

</div></div>
<script>
let currentStep=0;
function goStep(n){
  if(n===1&&!document.getElementById('ob-name').value.trim()){document.getElementById('ob-name').style.borderColor='#ef4444';return}
  if(n===3){createLocation();return}
  document.querySelectorAll('.onb-step').forEach(s=>s.classList.remove('active'));
  document.getElementById('step'+n).classList.add('active');
  for(let i=0;i<4;i++){const d=document.getElementById('dot'+i);d.className='step-dot'+(i<n?' done':i===n?' active':'')}
  currentStep=n;
  if(n===2)updatePreview();
}
function updatePreview(){document.getElementById('ob-preview-name').textContent=document.getElementById('ob-name').value||'Your Business'}
async function createLocation(){
  goStepUI(3);
  const name=document.getElementById('ob-name').value.trim()||'My Business';
  const url=document.getElementById('ob-url').value.trim()||'https://g.page/review';
  const color=document.getElementById('ob-color').value;
  const type=document.getElementById('ob-type').value;
  try{
    const r=await fetch('/api/onboarding',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({business_name:name,google_review_url:url,primary_color:color,business_type:type})});
    const d=await r.json();
    if(d.success){
      document.getElementById('ob-final').innerHTML='<div style="font-size:48px;margin-bottom:16px">üéâ</div><h3 style="margin-bottom:8px">Your review page is live!</h3><p style="color:#64748b;margin-bottom:20px">Share this link with your customers:</p>'
        +'<div style="background:#f0fdf4;border:2px solid #bbf7d0;border-radius:12px;padding:16px;margin-bottom:20px;word-break:break-all"><a href="'+d.url+'" target="_blank" rel="noopener noreferrer" style="color:#16a34a;font-weight:600;font-size:16px">'+d.url+'</span></div>'
        +(d.qr?'<img src="'+d.qr+'" class="onb-qr" alt="QR Code">':'')
        +'<div style="display:flex;gap:12px;margin-top:20px;justify-content:center;flex-wrap:wrap"><a href="/dashboard" class="btn btn-primary" style="padding:14px 32px">Go to Dashboard ‚Üí</span>'
        +'<button onclick="navigator.clipboard.writeText(\\''+d.url+'\\');this.textContent=\\'Copied!\\'" class="btn btn-secondary">Copy Link</button></div>';
    } else {
      document.getElementById('ob-final').innerHTML='<div class="alert alert-error">'+d.error+'</div><a href="/dashboard" class="btn btn-primary">Go to Dashboard</span>';
    }
  }catch(e){document.getElementById('ob-final').innerHTML='<div class="alert alert-error">Something went wrong</div><a href="/dashboard" class="btn btn-primary">Go to Dashboard</span>'}
}
function goStepUI(n){document.querySelectorAll('.onb-step').forEach(s=>s.classList.remove('active'));document.getElementById('step'+n).classList.add('active');for(let i=0;i<4;i++){const d=document.getElementById('dot'+i);d.className='step-dot'+(i<n?' done':i===n?' active':'')}}

// Industry autocomplete
const industries = ${JSON.stringify(Object.entries(INDUSTRY_TEMPLATES).map(([k,v])=>({name:k,icon:v.icon,sms:v.sms})))};
let dropdownTimeout;
function onNameInput(val) {
  clearTimeout(dropdownTimeout);
  const dd = document.getElementById('name-dropdown');
  if (!val.trim()) { dd.style.display='none'; return; }
  dropdownTimeout = setTimeout(() => {
    dd.innerHTML = industries.map(ind =>
      '<div style="padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;border-bottom:1px solid #f1f5f9;transition:background .15s" onmouseover="this.style.background=\\'#f8fafc\\'" onmouseout="this.style.background=\\'#fff\\'" onclick="selectIndustry(\\''+ind.name+'\\',\\''+val.trim()+'\\')">'+
      '<span style="font-size:24px">'+ind.icon+'</span><div><div style="font-weight:600;font-size:14px">'+val.trim()+' <span style="color:#94a3b8;font-weight:400">‚Äî '+ind.name+'</span></div></div></div>'
    ).join('');
    dd.style.display = 'block';
  }, 200);
}
function selectIndustry(type, name) {
  document.getElementById('ob-type').value = type;
  document.getElementById('name-dropdown').style.display = 'none';
  showIndustryPreview(type);
}
function showIndustryPreview(type) {
  const ind = industries.find(i => i.name === type);
  const preview = document.getElementById('industry-preview');
  if (ind) {
    const name = document.getElementById('ob-name').value || 'Your Business';
    document.getElementById('industry-sms').textContent = ind.sms.replace(/{name}/g, name).replace(/{link}/g, 'alpha.abapture.ai/r/...');
    preview.style.display = 'block';
  } else { preview.style.display = 'none'; }
}
document.addEventListener('click', function(e) { if (!e.target.closest('#ob-name') && !e.target.closest('#name-dropdown')) document.getElementById('name-dropdown').style.display='none'; });

// Places search
async function searchPlaces() {
  const q = document.getElementById('ob-places-q').value.trim();
  if (!q) return;
  const rd = document.getElementById('places-results');
  rd.style.display = 'block';
  rd.innerHTML = '<div style="text-align:center;padding:12px;color:#64748b;font-size:14px">Searching...</div>';
  try {
    const r = await fetch('/api/places-search?q=' + encodeURIComponent(q));
    const d = await r.json();
    if (d.results && d.results.length > 0) {
      rd.innerHTML = d.results.map(p =>
        '<div onclick="pickPlace(this)" data-url="' + (p.reviewUrl || '') + '" style="padding:12px;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:8px;cursor:pointer;background:#fff;transition:all .15s" onmouseover="this.style.borderColor=\\'#2563eb\\';this.style.background=\\'#eff6ff\\'" onmouseout="this.style.borderColor=\\'#e2e8f0\\';this.style.background=\\'#fff\\'">' +
        '<div style="font-weight:600;font-size:15px">' + esc_html(p.name) + '</div>' +
        '<div style="font-size:13px;color:#64748b;margin-top:2px">' + esc_html(p.address) + '</div>' +
        (p.reviewUrl ? '<div style="font-size:12px;color:#16a34a;margin-top:4px">‚úì Google review link available</div>' : '<div style="font-size:12px;color:#f59e0b;margin-top:4px">‚ö† Review link may need manual entry</div>') +
        '</div>'
      ).join('');
    } else if (d.fallback) {
      rd.innerHTML = '<div style="padding:12px;background:#fef3c7;border-radius:10px;font-size:13px;color:#92400e">' +
        '<p style="margin-bottom:8px"><strong>Tip:</strong> We couldn\\'t search automatically, but you can find your review link by:</p>' +
        '<ol style="padding-left:18px;line-height:1.8"><li>Open <span style="color:#2563eb;font-weight:600">' + esc_html(q) + ' on Google Maps ‚Üó</span></li>' +
        '<li>Find your business and look for "Write a review"</li><li>Copy the URL from the review page</li></ol></div>';
    } else {
      rd.innerHTML = '<div style="padding:12px;color:#64748b;font-size:14px;text-align:center">No results found. Try a different search or paste your link directly below.</div>';
    }
  } catch(e) {
    rd.innerHTML = '<div style="padding:12px;color:#ef4444;font-size:14px">Search failed. Please paste your link manually.</div>';
  }
}
function pickPlace(el) {
  const url = el.getAttribute('data-url');
  if (url) {
    document.getElementById('ob-url').value = url;
    document.getElementById('places-results').innerHTML = '<div style="padding:12px;background:#f0fdf4;border-radius:10px;color:#16a34a;font-size:14px;text-align:center">‚úì Review link filled in! Click Continue to proceed.</div>';
  }
}
function esc_html(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
document.getElementById('ob-places-q')?.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); searchPlaces(); } });
</script></body></html>`);
});

app.post('/api/onboarding', requireAuth, async (req, res) => {
  const user = getUser(req);
  const { business_name, google_review_url, primary_color, business_type } = req.body;
  if (!business_name) return res.json({ error: 'Business name is required' });
  const id = uuidv4();
  const slug = business_name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'')+'-'+id.slice(0,6);
  const gurl = google_review_url || 'https://g.page/review';
  db.prepare('INSERT INTO locations (id,user_id,slug,business_name,business_type,google_review_url,primary_color,gate_threshold) VALUES (?,?,?,?,?,?,?,?)').run(id,user.id,slug,business_name,business_type||'',gurl,primary_color||'#2563eb',4);
  db.prepare('UPDATE users SET business_name=? WHERE id=?').run(business_name, user.id);
  const url = `${BASE_URL}/r/${slug}`;
  let qr = '';
  try { qr = await QRCode.toDataURL(url, { width: 300, margin: 2 }); } catch(e) {}
  res.json({ success: true, url, qr, slug });
});

// ===== TERMS & PRIVACY =====
app.get('/terms', (req, res) => {
  res.send(`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Terms of Service ‚Äî ReviewFlow</title>${css()}<script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span><div class="nav-links"><a href="/">Home</span></div></div></nav>
<div class="container" style="max-width:720px;padding:60px 24px"><h1 style="font-size:32px;margin-bottom:8px">Terms of Service</h1><p style="color:#64748b;margin-bottom:32px">Last updated: February 2026</p>
<div style="line-height:1.8;color:#475569">
<h2 style="color:#1e293b;margin:24px 0 8px">1. Acceptance of Terms</h2><p>By using ReviewFlow, you agree to these terms. If you don't agree, please don't use our service.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">2. Service Description</h2><p>ReviewFlow provides tools to collect and manage customer reviews for local businesses, including review pages, QR codes, and analytics.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">3. User Accounts</h2><p>You're responsible for maintaining the security of your account. You must provide accurate information when creating an account.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">4. Acceptable Use</h2><p>You agree not to: use fake reviews, impersonate others, abuse the system, or violate any applicable laws.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">5. Billing & Subscriptions</h2><p>Paid plans are billed monthly. You can cancel at any time. Refunds are handled on a case-by-case basis.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">6. Limitation of Liability</h2><p>ReviewFlow is provided "as is." We make no warranties and are not liable for any damages arising from use of the service.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">7. Contact</h2><p>Questions? Email us at <a href="mailto:support@reviewflow.com">support@reviewflow.com</span>.</p>
</div></div>${footer()}</body></html>`);
});

app.get('/privacy', (req, res) => {
  res.send(`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Privacy Policy ‚Äî ReviewFlow</title>${css()}<script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span><div class="nav-links"><a href="/">Home</span></div></div></nav>
<div class="container" style="max-width:720px;padding:60px 24px"><h1 style="font-size:32px;margin-bottom:8px">Privacy Policy</h1><p style="color:#64748b;margin-bottom:32px">Last updated: February 2026</p>
<div style="line-height:1.8;color:#475569">
<h2 style="color:#1e293b;margin:24px 0 8px">1. Information We Collect</h2><p>We collect information you provide: email, business name, and review data from your customers (ratings, optional name/email, feedback text).</p>
<h2 style="color:#1e293b;margin:24px 0 8px">2. How We Use It</h2><p>We use your data to provide the ReviewFlow service: displaying review pages, generating analytics, and managing your account.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">3. Data Sharing</h2><p>We don't sell your data. We share it only with Stripe for payment processing and with service providers necessary to operate ReviewFlow.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">4. Data Retention</h2><p>We keep your data as long as your account is active. You can request deletion at any time by contacting us.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">5. Security</h2><p>We use industry-standard security measures including encryption, secure sessions, and hashed passwords.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">6. Cookies</h2><p>We use essential cookies for authentication. No tracking cookies or third-party analytics.</p>
<h2 style="color:#1e293b;margin:24px 0 8px">7. Contact</h2><p>For privacy questions, email <a href="mailto:support@reviewflow.com">support@reviewflow.com</span>.</p>
</div></div>${footer()}</body></html>`);
});

// ===== TEMPLATES PAGE =====
app.get('/templates', requireAuth, (req, res) => {
  const user = getUser(req);
  const locations = db.prepare('SELECT * FROM locations WHERE user_id = ? ORDER BY created_at DESC').all(user.id);
  const loc = locations[0];
  const bname = loc ? loc.business_name : (user.business_name || 'Your Business');
  const rlink = loc ? `${BASE_URL}/r/${loc.slug}` : `${BASE_URL}/r/your-link`;

  const templates = [
    { cat: 'üí¨ SMS Templates', items: [
      { title: 'After Visit ‚Äî Friendly', text: `Hi! Thanks for visiting ${bname}. We'd love your feedback ‚Äî takes 30 seconds: ${rlink}` },
      { title: 'After Visit ‚Äî Professional', text: `Thank you for choosing ${bname}. Your opinion matters to us! Please share your experience: ${rlink}` },
      { title: 'Follow-Up Reminder', text: `Hi! Just a quick reminder ‚Äî we'd really appreciate your feedback on ${bname}. It only takes a moment: ${rlink}` },
      { title: 'After Service Completion', text: `Thanks for letting ${bname} take care of you! How did we do? ${rlink}` },
    ]},
    { cat: '‚úâÔ∏è Email Templates', items: [
      { title: 'Standard Review Request', text: `Subject: How was your visit to ${bname}?\n\nHi there,\n\nThank you for choosing ${bname}! We hope you had a great experience.\n\nWould you mind taking 30 seconds to share your feedback? It helps us improve and helps others discover us.\n\nüëâ ${rlink}\n\nThank you so much!\nThe ${bname} Team` },
      { title: 'Personal Touch', text: `Subject: A quick favor from ${bname}\n\nHi,\n\nI personally wanted to thank you for your visit to ${bname}. Your support means the world to us.\n\nIf you have a moment, we'd love to hear how we did:\n\nüëâ ${rlink}\n\nEvery review helps our small business grow. Thank you!\n\nWarm regards,\n${bname}` },
      { title: 'Post-Purchase', text: `Subject: We'd love your feedback!\n\nHi there,\n\nThanks for your recent purchase at ${bname}! We hope you love it.\n\nYour honest feedback helps us serve you better:\n\nüëâ ${rlink}\n\nThank you for being a valued customer!\n\nBest,\n${bname}` },
    ]},
    { cat: 'üñ®Ô∏è Print / In-Store', items: [
      { title: 'Receipt Message', text: `Enjoyed your visit? We'd love your feedback!\nScan the QR code or visit: ${rlink}` },
      { title: 'Table Tent / Counter Sign', text: `‚≠ê Love ${bname}?\nTell us about your experience!\nScan to leave a review ‚Üí\n${rlink}` },
    ]},
  ];

  let html = `<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px"><a href="/dashboard" style="color:#64748b;text-decoration:none;font-size:14px">‚Üê Dashboard</span>
<h1 style="font-size:28px">üìã Ready-Made Templates</h1></div>
<p style="color:#64748b;margin-bottom:8px">Copy-paste these templates to request reviews from your customers. Your business name and review link are already filled in!</p>`;

  if (locations.length > 1) {
    html += `<div class="card" style="padding:12px 16px;margin-bottom:16px"><span style="font-size:14px;color:#64748b">Templates are using: <strong>${esc(bname)}</strong></span></div>`;
  }

  templates.forEach(cat => {
    html += `<h2 style="font-size:20px;margin:24px 0 12px">${cat.cat}</h2>`;
    cat.items.forEach((t, i) => {
      const tid = cat.cat.slice(0,3).replace(/[^a-z]/gi,'') + i;
      html += `<div class="card" style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<h3 style="font-size:16px">${t.title}</h3>
<button onclick="navigator.clipboard.writeText(document.getElementById('t${tid}').value);this.textContent='‚úì Copied!';setTimeout(()=>this.textContent='Copy',2000)" class="btn btn-primary btn-sm">Copy</button></div>
<textarea id="t${tid}" rows="${t.text.split('\n').length + 1}" style="background:#f8fafc;font-size:14px;line-height:1.6" readonly>${esc(t.text)}</textarea></div>`;
    });
  });

  res.send(dashLayout(user, `<div style="max-width:700px;margin:0 auto">${html}</div>`));
});

// ===== INDUSTRY TEMPLATES API =====
app.get('/api/industry-templates', (req, res) => {
  res.json(INDUSTRY_TEMPLATES);
});

// ===== GET MORE REVIEWS (Integration Guides) =====
app.get('/guides', requireAuth, (req, res) => {
  const user = getUser(req);
  const loc = db.prepare('SELECT * FROM locations WHERE user_id = ? ORDER BY created_at DESC LIMIT 1').get(user.id);
  const bname = loc ? loc.business_name : (user.business_name || 'Your Business');
  const rlink = loc ? `${BASE_URL}/r/${loc.slug}` : `${BASE_URL}/r/your-link`;
  const qrLink = loc ? `/locations/${loc.id}/qr` : '#';

  res.send(dashLayout(user, `<div style="max-width:800px;margin:0 auto">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:8px"><a href="/dashboard" style="color:#64748b;text-decoration:none;font-size:14px">‚Üê Dashboard</span>
<h1 style="font-size:28px">üöÄ Get More Reviews</h1></div>
<p style="color:#64748b;margin-bottom:32px">Proven strategies to collect more 5-star reviews. Each guide takes 5 minutes or less to implement.</p>

<div class="card" style="border-left:4px solid #2563eb">
<div style="display:flex;align-items:flex-start;gap:16px">
<div style="font-size:40px">üßæ</div>
<div style="flex:1">
<h3 style="font-size:18px;margin-bottom:8px">1. Add QR Code to Receipts</h3>
<p style="color:#64748b;margin-bottom:16px">Print your QR code on receipts so every customer sees it at checkout. This is the #1 way local businesses collect reviews.</p>
<div style="background:#f8fafc;border-radius:12px;padding:20px;border:1px solid #e2e8f0">
<h4 style="font-size:14px;color:#2563eb;margin-bottom:12px">üìã STEP-BY-STEP</h4>
<ol style="color:#475569;font-size:14px;line-height:2.2;padding-left:20px">
<li><a href="${qrLink}" style="color:#2563eb">Download your QR code</span> as PNG</li>
<li>Open your receipt template in your POS system (Square, Toast, Clover, etc.)</li>
<li>Add the QR code image to the bottom of your receipt</li>
<li>Add text: <em>"Scan to leave us a review ‚≠ê"</em></li>
<li>Save and print a test receipt to verify</li>
</ol>
<div style="margin-top:12px;padding:12px;background:#eff6ff;border-radius:8px;font-size:13px;color:#2563eb">üí° <strong>Pro tip:</strong> Add "Scan for a chance to win [prize]" to boost scan rates by 3x</div>
</div>
</div></div></div>

<div class="card" style="border-left:4px solid #16a34a">
<div style="display:flex;align-items:flex-start;gap:16px">
<div style="font-size:40px">üí¨</div>
<div style="flex:1">
<h3 style="font-size:18px;margin-bottom:8px">2. Send After Appointments (SMS)</h3>
<p style="color:#64748b;margin-bottom:16px">Text customers within 1 hour of their visit. Timing is everything ‚Äî the sooner you ask, the more likely they'll respond.</p>
<div style="background:#f8fafc;border-radius:12px;padding:20px;border:1px solid #e2e8f0">
<h4 style="font-size:14px;color:#16a34a;margin-bottom:12px">üìã STEP-BY-STEP</h4>
<ol style="color:#475569;font-size:14px;line-height:2.2;padding-left:20px">
<li>Copy this SMS template:</li>
</ol>
<div style="background:#fff;border:2px solid #e2e8f0;border-radius:8px;padding:16px;margin:8px 0 12px;font-size:14px;color:#1e293b">
Hi! Thanks for visiting <strong>${esc(bname)}</strong>. We'd love your feedback ‚Äî takes 30 seconds: <strong>${esc(rlink)}</strong>
</div>
<ol start="2" style="color:#475569;font-size:14px;line-height:2.2;padding-left:20px">
<li>Send within 1 hour of the customer's visit</li>
<li>Use your phone, or set up auto-texts with your booking system</li>
<li>For bulk: use services like Twilio, SimpleTexting, or your CRM</li>
</ol>
<button onclick="navigator.clipboard.writeText('Hi! Thanks for visiting ${esc(bname)}. We\\'d love your feedback ‚Äî takes 30 seconds: ${esc(rlink)}');this.textContent='‚úì Copied!';setTimeout(()=>this.textContent='Copy SMS Template',2000)" class="btn btn-primary btn-sm" style="margin-top:12px">Copy SMS Template</button>
<div style="margin-top:12px;padding:12px;background:#f0fdf4;border-radius:8px;font-size:13px;color:#16a34a">üí° <strong>Pro tip:</strong> Texts sent within 30 minutes of a visit get 4x more responses than emails</div>
</div>
</div></div></div>

<div class="card" style="border-left:4px solid #7c3aed">
<div style="display:flex;align-items:flex-start;gap:16px">
<div style="font-size:40px">‚úâÔ∏è</div>
<div style="flex:1">
<h3 style="font-size:18px;margin-bottom:8px">3. Add Link to Email Signature</h3>
<p style="color:#64748b;margin-bottom:16px">Every email you send becomes a review request. Set it once and forget it ‚Äî reviews come in on autopilot.</p>
<div style="background:#f8fafc;border-radius:12px;padding:20px;border:1px solid #e2e8f0">
<h4 style="font-size:14px;color:#7c3aed;margin-bottom:12px">üìã STEP-BY-STEP</h4>
<ol style="color:#475569;font-size:14px;line-height:2.2;padding-left:20px">
<li>Open your email app settings ‚Üí Signature</li>
<li>Add this line to your signature:</li>
</ol>
<div style="background:#fff;border:2px solid #e2e8f0;border-radius:8px;padding:16px;margin:8px 0 12px;font-size:14px;color:#1e293b">
‚≠ê Love ${esc(bname)}? <a href="${esc(rlink)}" style="color:#2563eb">Leave us a review!</span>
</div>
<ol start="3" style="color:#475569;font-size:14px;line-height:2.2;padding-left:20px">
<li>Save your signature</li>
<li>Every email you send now asks for reviews!</li>
</ol>
<button onclick="navigator.clipboard.writeText('‚≠ê Love ${esc(bname)}? Leave us a review: ${esc(rlink)}');this.textContent='‚úì Copied!';setTimeout(()=>this.textContent='Copy Signature Text',2000)" class="btn btn-primary btn-sm" style="margin-top:12px">Copy Signature Text</button>
<div style="margin-top:12px;padding:12px;background:#f5f3ff;border-radius:8px;font-size:13px;color:#7c3aed">üí° <strong>Pro tip:</strong> Add it to every team member's signature for maximum impact</div>
</div>
</div></div></div>

<div class="card" style="border-left:4px solid #ea580c">
<div style="display:flex;align-items:flex-start;gap:16px">
<div style="font-size:40px">üì±</div>
<div style="flex:1">
<h3 style="font-size:18px;margin-bottom:8px">4. Post on Social Media</h3>
<p style="color:#64748b;margin-bottom:16px">Share your review link on Facebook, Instagram, and other social channels to reach customers who already follow you.</p>
<div style="background:#f8fafc;border-radius:12px;padding:20px;border:1px solid #e2e8f0">
<h4 style="font-size:14px;color:#ea580c;margin-bottom:12px">üìã STEP-BY-STEP</h4>
<ol style="color:#475569;font-size:14px;line-height:2.2;padding-left:20px">
<li>Copy this post template:</li>
</ol>
<div style="background:#fff;border:2px solid #e2e8f0;border-radius:8px;padding:16px;margin:8px 0 12px;font-size:14px;color:#1e293b">
We love hearing from our customers! ‚≠ê<br>If you've visited <strong>${esc(bname)}</strong> recently, we'd appreciate your honest feedback. It takes just 30 seconds!<br><br>üëâ ${esc(rlink)}<br><br>Thank you for supporting local business! üôè
</div>
<ol start="2" style="color:#475569;font-size:14px;line-height:2.2;padding-left:20px">
<li>Post on Facebook, Instagram bio link, Twitter/X, Nextdoor</li>
<li>Pin the post so new visitors see it first</li>
<li>Add your review link to your Instagram bio and Facebook page</li>
</ol>
<button onclick="navigator.clipboard.writeText('We love hearing from our customers! ‚≠ê If you\\'ve visited ${esc(bname)} recently, we\\'d appreciate your honest feedback. It takes just 30 seconds!\\n\\n${esc(rlink)}\\n\\nThank you for supporting local business! üôè');this.textContent='‚úì Copied!';setTimeout(()=>this.textContent='Copy Social Post',2000)" class="btn btn-primary btn-sm" style="margin-top:12px">Copy Social Post</button>
<div style="margin-top:12px;padding:12px;background:#fff7ed;border-radius:8px;font-size:13px;color:#ea580c">üí° <strong>Pro tip:</strong> Post monthly for a steady stream of new reviews</div>
</div>
</div></div></div>

<div class="card" style="background:linear-gradient(135deg,#eff6ff,#f0fdf4);border:2px solid #2563eb;text-align:center;padding:32px">
<div style="font-size:48px;margin-bottom:12px">üéØ</div>
<h3 style="font-size:20px;margin-bottom:8px">The Golden Rule of Reviews</h3>
<p style="color:#475569;font-size:16px;max-width:500px;margin:0 auto 16px"><strong>Ask every customer, every time.</strong> Businesses that ask consistently get 5-10x more reviews than those that don't.</p>
<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
<a href="/templates" class="btn btn-primary btn-sm">üìã View All Templates</span>
${loc?`<a href="/locations/${loc.id}/qr" class="btn btn-secondary btn-sm">üì± Get QR Code</span>`:''}
</div>
</div>
</div>`));
});

// ===== REVIEW PAGE STYLE PREVIEW =====
app.get('/locations/:id/style', requireAuth, (req, res) => {
  const user = getUser(req);
  const loc = db.prepare('SELECT * FROM locations WHERE id=? AND user_id=?').get(req.params.id, user.id);
  if (!loc) return res.redirect('/dashboard');
  const url = `${BASE_URL}/r/${loc.slug}`;
  
  res.send(dashLayout(user, `<div style="max-width:900px;margin:0 auto">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px"><a href="/dashboard" style="color:#64748b;text-decoration:none;font-size:14px">‚Üê Dashboard</span>
<h1 style="font-size:28px">üé® Review Page Style ‚Äî ${esc(loc.business_name)}</h1></div>
<p style="color:#64748b;margin-bottom:24px">Choose how your review page looks to customers. Click to preview, then save.</p>

<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:24px" id="style-grid">
${['minimal','professional','premium'].map(s => {
  const active = (loc.page_style||'professional') === s;
  const labels = {minimal:'Minimal',professional:'Professional',premium:'Premium'};
  const descs = {minimal:'Clean & simple. Just stars and feedback.',professional:'Business info, logo, and branding.',premium:'Full branding with custom background.'};
  const icons = {minimal:'‚ö°',professional:'üè¢',premium:'üëë'};
  return `<div class="card" onclick="selectStyle('${s}')" id="style-${s}" style="cursor:pointer;text-align:center;padding:24px;border:2px solid ${active?'#2563eb':'#e2e8f0'};transition:all .2s">
<div style="font-size:36px;margin-bottom:8px">${icons[s]}</div>
<h3 style="font-size:18px;margin-bottom:4px">${labels[s]}</h3>
<p style="font-size:13px;color:#64748b;margin-bottom:12px">${descs[s]}</p>
${s==='premium'?'<span class="badge badge-growth" style="font-size:11px">STARTER+</span>':''}
${active?'<div style="color:#2563eb;font-weight:600;font-size:13px;margin-top:8px">‚úì Active</div>':''}
</div>`;
}).join('')}
</div>

${(loc.page_style||'professional')==='premium'?`
<div class="card" id="premium-options" style="margin-bottom:16px">
<h3 style="margin-bottom:12px">Premium Options</h3>
<div class="form-group"><label>Custom Background (CSS)</label>
<input type="text" id="custom-bg" value="${esc(loc.custom_bg||'')}" placeholder="e.g. linear-gradient(135deg, #667eea, #764ba2) or image URL">
<div class="form-hint">Use a gradient or paste an image URL. Leave blank for default.</div></div>
</div>`:'<div id="premium-options" style="display:none"></div>'}

<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
<button onclick="saveStyle()" class="btn btn-primary" id="save-btn">Save Style</button>
<a href="/r/${loc.slug}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">Preview Live Page ‚Üó</span>
<span id="save-msg" style="color:#16a34a;font-size:14px;display:none">‚úì Saved!</span>
</div>

<div style="margin-top:32px">
<h3 style="margin-bottom:16px">Preview</h3>
<div style="border:1px solid #e2e8f0;border-radius:16px;overflow:hidden;background:#f8fafc">
<iframe src="/r/${loc.slug}" style="width:100%;height:600px;border:none" id="preview-frame"></iframe>
</div></div>
</div>
<script>
let currentStyle = '${loc.page_style||'professional'}';
function selectStyle(s) {
  currentStyle = s;
  document.querySelectorAll('#style-grid .card').forEach(c => c.style.borderColor = '#e2e8f0');
  document.getElementById('style-'+s).style.borderColor = '#2563eb';
  document.getElementById('premium-options').style.display = s==='premium' ? 'block' : 'none';
}
async function saveStyle() {
  const btn = document.getElementById('save-btn');
  btn.disabled = true; btn.textContent = 'Saving...';
  const body = { page_style: currentStyle };
  if (currentStyle === 'premium') body.custom_bg = document.getElementById('custom-bg')?.value || '';
  const r = await fetch('/locations/${loc.id}/style', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  btn.disabled = false; btn.textContent = 'Save Style';
  if (r.ok) {
    document.getElementById('save-msg').style.display = 'inline';
    document.getElementById('preview-frame').src = '/r/${loc.slug}?t='+Date.now();
    setTimeout(() => document.getElementById('save-msg').style.display = 'none', 3000);
  }
}
</script>`));
});

app.post('/locations/:id/style', requireAuth, (req, res) => {
  const user = getUser(req);
  const { page_style, custom_bg } = req.body;
  const validStyles = ['minimal','professional','premium'];
  if (!validStyles.includes(page_style)) return res.status(400).json({error:'Invalid style'});
  // Premium requires starter+ plan
  if (page_style === 'premium' && user.plan === 'free') return res.status(403).json({error:'Upgrade to Starter or Growth to use Premium style'});
  db.prepare('UPDATE locations SET page_style=?, custom_bg=? WHERE id=? AND user_id=?').run(page_style, custom_bg||'', req.params.id, user.id);
  res.json({success:true});
});

// ===== 404 PAGE =====
function notFoundPage() {
  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Page Not Found ‚Äî ReviewFlow</title>${css()}
<style>body{background:#f8fafc;min-height:100vh;display:flex;flex-direction:column}
.nf{flex:1;display:flex;align-items:center;justify-content:center;text-align:center;padding:40px 24px}</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span>
<div class="nav-links"><a href="/">Home</span><a href="/login">Log In</span></div></div></nav>
<div class="nf"><div>
<div style="font-size:96px;margin-bottom:16px">üîç</div>
<h1 style="font-size:48px;font-weight:800;color:#1e293b;margin-bottom:8px">404</h1>
<p style="font-size:20px;color:#64748b;margin-bottom:32px">This page doesn't exist ‚Äî but your next 5-star review does.</p>
<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
<a href="/" class="btn btn-primary">Go Home</span>
<a href="/signup" class="btn btn-secondary">Start Collecting Reviews</span>
</div></div></div>
${footer()}</body></html>`;
}

// ===== LEAD MAGNET =====
app.get('/free-guide', (req, res) => {
  res.send(`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Free Guide: 10 Ways to Get More 5-Star Google Reviews ‚Äî ReviewFlow</title>
<meta name="description" content="Download our free guide with 10 proven strategies to get more 5-star Google reviews for your local business.">
${css()}<style>
body{background:linear-gradient(135deg,#eff6ff 0%,#f0fdf4 100%);min-height:100vh}
.guide-wrap{max-width:640px;margin:0 auto;padding:60px 24px;text-align:center}
.guide-card{background:#fff;border-radius:20px;padding:48px 40px;box-shadow:0 8px 32px rgba(0,0,0,.08)}
.guide-preview{background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;padding:24px;margin:24px 0;text-align:left}
.guide-preview li{padding:6px 0;color:#475569;font-size:15px}
</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span>
<div class="nav-links"><a href="/blog">Blog</span><a href="/signup" class="btn btn-primary btn-sm">Start Free</span></div></div></nav>
<div class="guide-wrap"><div class="guide-card">
<div style="font-size:64px;margin-bottom:16px">üìò</div>
<h1 style="font-size:32px;line-height:1.2;margin-bottom:12px">10 Ways to Get More 5-Star Google Reviews</h1>
<p style="color:#64748b;font-size:17px;margin-bottom:24px">Free guide for local business owners. Actionable strategies you can implement today.</p>
<div class="guide-preview">
<p style="font-weight:700;margin-bottom:12px">What's inside:</p>
<ol>
<li>The "review moment" timing strategy</li>
<li>QR code placement checklist</li>
<li>SMS templates that get 40%+ response rates</li>
<li>The review gate technique (protect your rating)</li>
<li>Email follow-up sequences</li>
<li>How to train your staff to ask</li>
<li>Leveraging your existing customer list</li>
<li>Social media review campaigns</li>
<li>Review response best practices</li>
<li>Tools to automate everything</li>
</ol></div>
<form id="guideForm" style="margin-top:24px" onsubmit="submitGuide(event)">
<input type="email" id="guideEmail" placeholder="Enter your email" required style="padding:14px 18px;font-size:16px;margin-bottom:12px">
<button type="submit" class="btn btn-primary" style="width:100%;padding:14px;font-size:16px">Download Free Guide ‚Üí</button>
<p style="font-size:13px;color:#94a3b8;margin-top:8px">No spam. Unsubscribe anytime.</p>
</form>
<div id="guideMsg" style="display:none"></div>
</div></div>
<script>
async function submitGuide(e){e.preventDefault();
const email=document.getElementById('guideEmail').value;
const r=await fetch('/api/email-signup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
const d=await r.json();const m=document.getElementById('guideMsg');
m.style.display='block';
if(d.success||d.error==='Already signed up'){
m.innerHTML='<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:24px;margin-top:16px;text-align:center"><div style="font-size:32px;margin-bottom:8px">‚úÖ</div><p style="font-weight:700;font-size:18px;margin-bottom:8px">Guide is on the way!</p><p style="color:#64748b;font-size:14px;margin-bottom:16px">Check your inbox. While you wait, try ReviewFlow free:</p><a href="/signup" class="btn btn-primary">Create Your Review Page ‚Üí</span></div>';
document.getElementById('guideForm').style.display='none';
}else{m.innerHTML='<p style="color:#ef4444">Something went wrong. Try again.</p>'}}
</script>
${footer()}</body></html>`);
});

// ===== BLOG =====
app.get('/blog', (req, res) => {
  const posts = BLOG_POSTS.map(p => `
    <article style="margin-bottom:32px;padding-bottom:32px;border-bottom:1px solid #e2e8f0">
      <div style="font-size:13px;color:#64748b;margin-bottom:8px">${p.category} ¬∑ ${p.date} ¬∑ ${p.readTime}</div>
      <h2 style="margin-bottom:8px"><a href="/blog/${p.slug}" style="color:#1e293b;text-decoration:none">${esc(p.title)}</span></h2>
      <p style="color:#64748b;font-size:15px;margin-bottom:12px">${esc(p.description)}</p>
      <a href="/blog/${p.slug}" style="color:#2563eb;font-weight:600;font-size:14px;text-decoration:none">Read more ‚Üí</span>
    </article>
  `).join('');
  res.send(`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Blog ‚Äî ReviewFlow | Google Review Tips for Local Businesses</title>
<meta name="description" content="Tips, strategies, and templates to help your local business get more Google reviews. From ReviewFlow.">
<link rel="canonical" href="${BASE_URL}/blog">
${css()}<style>.blog-wrap{max-width:720px;margin:0 auto;padding:48px 24px}</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span>
<div class="nav-links"><a href="/blog">Blog</span><a href="/#pricing">Pricing</span><a href="/login">Log In</span><a href="/signup" class="btn btn-primary btn-sm">Start Free</span></div></div></nav>
<div class="blog-wrap">
<h1 style="font-size:36px;margin-bottom:8px">ReviewFlow Blog</h1>
<p style="color:#64748b;font-size:18px;margin-bottom:40px">Tips & strategies to get more Google reviews for your local business.</p>
${posts}
</div>
${footer()}</body></html>`);
});

app.get('/blog/:slug', (req, res) => {
  const post = BLOG_POSTS.find(p => p.slug === req.params.slug);
  if (!post) return res.status(404).send(notFoundPage());
  
  const jsonLd = JSON.stringify({
    "@context": "https://schema.org", "@type": "BlogPosting",
    "headline": post.title, "description": post.description,
    "datePublished": post.date, "author": {"@type": "Organization", "name": "ReviewFlow"},
    "publisher": {"@type": "Organization", "name": "ReviewFlow", "url": BASE_URL}
  });

  res.send(`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>${esc(post.title)} ‚Äî ReviewFlow Blog</title>
<meta name="description" content="${esc(post.description)}">
<link rel="canonical" href="${BASE_URL}/blog/${post.slug}">
<meta property="og:title" content="${esc(post.title)}">
<meta property="og:description" content="${esc(post.description)}">
<meta property="og:type" content="article">
<meta property="og:url" content="${BASE_URL}/blog/${post.slug}">
<script type="application/ld+json">${jsonLd}</script>
${css()}<style>
.blog-wrap{max-width:720px;margin:0 auto;padding:48px 24px}
.blog-content h2{font-size:24px;margin:32px 0 12px;color:#1e293b}
.blog-content h3{font-size:20px;margin:24px 0 8px;color:#334155}
.blog-content p{margin-bottom:16px;color:#475569;font-size:16px;line-height:1.8}
.blog-content ul,.blog-content ol{margin:0 0 16px 24px;color:#475569;line-height:2}
.blog-content blockquote{background:#f8fafc;border-left:4px solid #2563eb;padding:16px 20px;margin:16px 0;border-radius:0 8px 8px 0;font-size:15px;color:#334155}
.blog-content a{color:#2563eb;text-decoration:underline}
.blog-content code{background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:14px}
.blog-cta{background:linear-gradient(135deg,#eff6ff,#f0fdf4);border:2px solid #2563eb;border-radius:16px;padding:32px;text-align:center;margin:40px 0}
</style><script data-goatcounter="https://abapture-alpha.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></head><body>
<nav class="nav"><div class="container nav-inner"><a href="/" class="nav-brand">‚≠ê ReviewFlow</span>
<div class="nav-links"><a href="/blog">Blog</span><a href="/#pricing">Pricing</span><a href="/login">Log In</span><a href="/signup" class="btn btn-primary btn-sm">Start Free</span></div></div></nav>
<div class="blog-wrap">
<a href="/blog" style="color:#64748b;text-decoration:none;font-size:14px">‚Üê Back to Blog</span>
<div style="font-size:13px;color:#64748b;margin:16px 0 8px">${post.category} ¬∑ ${post.date} ¬∑ ${post.readTime}</div>
<h1 style="font-size:36px;line-height:1.2;margin-bottom:24px">${esc(post.title)}</h1>
<div class="blog-content">${post.content}</div>
<div class="blog-cta">
<h3 style="font-size:22px;margin-bottom:8px">Ready to Get More Google Reviews?</h3>
<p style="color:#64748b;margin-bottom:16px">Set up your branded review page in 2 minutes. Free forever for 1 location.</p>
<a href="/signup" class="btn btn-primary" style="padding:14px 36px;font-size:16px">Start Free ‚Äî No Credit Card</span>
</div>
</div>
${footer()}</body></html>`);
});

// ===== SITEMAP =====
app.get('/sitemap.xml', (req, res) => {
  const urls = [
    { loc: '/', priority: '1.0' },
    { loc: '/blog', priority: '0.8' },
    { loc: '/signup', priority: '0.9' },
    { loc: '/login', priority: '0.5' },
    ...BLOG_POSTS.map(p => ({ loc: '/blog/' + p.slug, priority: '0.7', lastmod: p.date }))
  ];
  const xml = `<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n${urls.map(u => 
    `<url><loc>${BASE_URL}${u.loc}</loc>${u.lastmod ? `<lastmod>${u.lastmod}</lastmod>` : ''}<priority>${u.priority}</priority></url>`
  ).join('\n')}\n</urlset>`;
  res.type('application/xml').send(xml);
});

app.get('/robots.txt', (req, res) => {
  res.type('text/plain').send(`User-agent: *\nAllow: /\nSitemap: ${BASE_URL}/sitemap.xml`);
});


// ===== PROPOSAL TEMPLATE LIBRARY =====
const PROPOSAL_TEMPLATES = require('./proposal-templates');

app.get('/api/proposal-templates', (req, res) => {
  const templates = PROPOSAL_TEMPLATES.map(t => ({
    id: t.id, title: t.title, description: t.description,
    industry: t.industry, icon: t.icon, color: t.color, preview: t.preview
  }));
  res.json({ templates });
});

app.get('/api/proposal-templates/:id', (req, res) => {
  const t = PROPOSAL_TEMPLATES.find(x => x.id === req.params.id);
  if (!t) return res.status(404).json({ error: 'Template not found' });
  res.json({ template: t });
});

app.post('/api/proposals/from-template/:id', requireAuth, (req, res) => {
  const t = PROPOSAL_TEMPLATES.find(x => x.id === req.params.id);
  if (!t) return res.status(404).json({ error: 'Template not found' });
  const user = getUser(req);
  const id = uuidv4();
  const shareToken = uuidv4().slice(0,8);
  let introText = t.intro_text;
  if (t.sections.scope) introText += '\n\n--- SCOPE OF WORK ---\n\n' + t.sections.scope;
  if (t.sections.timeline) introText += '\n\n--- TIMELINE ---\n\n' + t.sections.timeline;
  try {
    db.prepare('INSERT INTO proposals (id, user_id, share_token, title, client_name, client_email, client_company, intro_text, terms_text, currency, discount_percent, tax_percent) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)').run(id, user.id, shareToken, t.title, '', '', '', introText, t.terms_text, 'USD', 0, 0);
    if (t.line_items && t.line_items.length) {
      const ins = db.prepare('INSERT INTO line_items (id, proposal_id, description, quantity, unit_price, sort_order) VALUES (?, ?, ?, ?, ?, ?)');
      t.line_items.forEach(function(item, i) { ins.run(uuidv4(), id, item.description, item.quantity || 1, item.unit_price || 0, i); });
    }
    res.json({ ok: true, proposalId: id });
  } catch(e) { res.status(500).json({ error: e.message }); }
});

app.get('/proposal-templates', requireAuth, (req, res) => {
  const user = getUser(req);
  let html = '<div style="display:flex;align-items:center;gap:16px;margin-bottom:8px"><a href="/dashboard" style="color:#64748b;text-decoration:none;font-size:14px">&larr; Dashboard</span><h1 style="font-size:28px">&#x1f4c4; Proposal Template Library</h1></div>';
  html += '<p style="color:#64748b;margin-bottom:24px">Start with a professional template and customize it for your client. Each template includes intro text, scope, timeline, pricing, and terms.</p>';
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px">';
  PROPOSAL_TEMPLATES.forEach(function(t) {
    var total = t.line_items.reduce(function(s, i) { return s + (i.quantity * i.unit_price); }, 0);
    html += '<div class="card" style="border-top:4px solid ' + t.color + ';display:flex;flex-direction:column">';
    html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><span style="font-size:32px">' + t.icon + '</span><div><h3 style="font-size:18px;margin-bottom:2px">' + esc(t.title) + '</h3>';
    html += '<span style="font-size:12px;background:' + t.color + '15;color:' + t.color + ';padding:2px 8px;border-radius:12px;font-weight:600">' + esc(t.industry) + '</span></div></div>';
    html += '<p style="color:#64748b;font-size:14px;margin-bottom:16px;flex:1">' + esc(t.description) + '</p>';
    html += '<div style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:#475569"><strong>Preview:</strong> ' + esc(t.preview) + '</div>';
    html += '<div style="font-size:13px;color:#64748b;margin-bottom:12px"><strong>Sections:</strong> Intro &middot; Scope &middot; Timeline &middot; Pricing &middot; Terms<br><strong>Line items:</strong> ' + t.line_items.length + ' items &middot; Starting at $' + total.toLocaleString() + '</div>';
    html += '<details style="margin-bottom:16px"><summary style="cursor:pointer;font-size:13px;color:#2563eb;font-weight:600">Preview line items</summary><div style="margin-top:8px;font-size:13px">';
    t.line_items.forEach(function(i) { html += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f1f5f9"><span>' + esc(i.description) + '</span><span style="color:#64748b">' + i.quantity + ' x $' + i.unit_price.toLocaleString() + '</span></div>'; });
    html += '</div></details>';
    html += '<button onclick="useTemplate(\'' + t.id + '\')" class="btn btn-primary" style="width:100%;background:' + t.color + '">Use This Template</button></div>';
  });
  html += '</div><script>async function useTemplate(id){if(!confirm("Create a new proposal from this template?"))return;var btn=event.target;btn.disabled=true;btn.textContent="Creating...";try{var r=await fetch("/api/proposals/from-template/"+id,{method:"POST"});var data=await r.json();if(data.ok){alert("Proposal created! Find it in your dashboard.");window.location.href="/dashboard";}else{alert("Error: "+(data.error||"Unknown"));btn.disabled=false;btn.textContent="Use This Template";}}catch(e){alert("Error: "+e.message);btn.disabled=false;btn.textContent="Use This Template";}}</script>';
  res.send(dashLayout(user, '<div style="max-width:1000px;margin:0 auto">' + html + '</div>'));
});

// Load proposal routes with payment integration
require('./proposals')(app, db, stripe, { uuidv4, requireAuth, getUser, esc, css, dashLayout, notFoundPage, footer, BASE_URL });

// ===== RESPONSE TEMPLATE LIBRARY =====
const DEFAULT_RESPONSE_TEMPLATES = [
  { category: 'positive', title: 'Warm Thank You', body: 'Thank you so much for your wonderful review! We truly appreciate you taking the time to share your experience. It means the world to our team, and we look forward to serving you again soon!' },
  { category: 'positive', title: 'Highlight the Team', body: "What a fantastic review \u2014 thank you! We'll make sure the team sees this. Your kind words are what keep us motivated to deliver our best every day. See you next time!" },
  { category: 'positive', title: 'Loyal Customer Appreciation', body: "Thank you for being such a loyal customer and for this amazing review! It's customers like you that make what we do so rewarding. We can't wait to welcome you back!" },
  { category: 'negative', title: 'Sincere Apology', body: "We're truly sorry to hear about your experience. This is not the standard we hold ourselves to, and we take your feedback very seriously. Please reach out to us directly so we can make this right." },
  { category: 'negative', title: 'Acknowledge & Resolve', body: "Thank you for bringing this to our attention. We sincerely apologize for the inconvenience. We'd love the opportunity to make things right \u2014 please contact us and we'll personally ensure a better experience." },
  { category: 'negative', title: 'Empathetic Response', body: "We completely understand your frustration, and we're sorry we fell short. Your feedback helps us improve. We'd like to learn more and resolve this for you." },
  { category: 'neutral', title: 'Grateful & Encouraging', body: "Thank you for your feedback! We're glad you had a good experience and we're always striving to make it even better. If there's anything specific we can improve, we'd love to hear!" },
  { category: 'neutral', title: 'Invite Back', body: "Thanks for sharing your thoughts! We appreciate your honest feedback. We're constantly working to improve, and we hope to exceed your expectations on your next visit." },
  { category: 'apology', title: 'Professional Apology', body: "Please accept our sincerest apologies. We hold ourselves to the highest standards and clearly fell short. We've taken immediate steps to address the issues you mentioned and would be grateful for another chance to serve you." },
  { category: 'apology', title: 'Service Recovery', body: "We owe you an apology. Your experience does not reflect who we are, and we're deeply sorry. We've already begun addressing the issues you raised. Please allow us to make it up to you." },
  { category: 'follow-up', title: 'Check-In After Resolution', body: "Hi! We wanted to follow up on your recent feedback. We've made the changes you suggested and would love for you to give us another try. We're confident you'll notice the difference!" },
  { category: 'follow-up', title: 'Thank You for Second Chance', body: "Thank you for giving us another opportunity! We hope your recent visit was much better. Your feedback truly helped us improve, and we're grateful for your patience." },
];

// Seed default templates if empty
(function seedResponseTemplates() {
  const count = db.prepare('SELECT COUNT(*) as c FROM response_templates WHERE is_default=1').get().c;
  if (count === 0) {
    const ins = db.prepare('INSERT INTO response_templates (id,user_id,category,title,body,is_default) VALUES (?,?,?,?,?,1)');
    DEFAULT_RESPONSE_TEMPLATES.forEach(t => ins.run(uuidv4(), null, t.category, t.title, t.body));
  }
})();

// Response Templates Page
app.get('/response-templates', requireAuth, (req, res) => {
  const user = getUser(req);
  const category = req.query.category || 'all';
  
  let templates;
  if (category === 'all') {
    templates = db.prepare('SELECT * FROM response_templates WHERE (user_id IS NULL OR user_id = ?) ORDER BY category, is_default DESC, created_at DESC').all(user.id);
  } else {
    templates = db.prepare('SELECT * FROM response_templates WHERE (user_id IS NULL OR user_id = ?) AND category = ? ORDER BY is_default DESC, created_at DESC').all(user.id, category);
  }

  const categories = [
    { id: 'all', label: 'All Templates', icon: '\ud83d\udccb', color: '#6366f1' },
    { id: 'positive', label: 'Positive', icon: '\ud83d\ude0a', color: '#22c55e' },
    { id: 'negative', label: 'Negative', icon: '\ud83d\ude1f', color: '#ef4444' },
    { id: 'neutral', label: 'Neutral', icon: '\ud83d\ude10', color: '#f59e0b' },
    { id: 'apology', label: 'Apology', icon: '\ud83d\ude4f', color: '#8b5cf6' },
    { id: 'follow-up', label: 'Follow-up', icon: '\ud83d\udd04', color: '#06b6d4' },
  ];

  const catColors = { positive: '#22c55e', negative: '#ef4444', neutral: '#f59e0b', apology: '#8b5cf6', 'follow-up': '#06b6d4' };

  let html = '<div style="max-width:900px;margin:0 auto">';
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">';
  html += '<div><h1 style="font-size:28px;margin:0">\ud83d\udcdd Response Template Library</h1><p style="color:#64748b;margin:4px 0 0">Professional templates for responding to customer reviews</p></div>';
  html += `<button onclick="document.getElementById('newTplModal').style.display='flex'" class="btn btn-primary">+ Create Template</button></div>`;

  // Category filter pills
  html += '<div style="display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap">';
  categories.forEach(c => {
    const active = category === c.id;
    html += `<a href="/response-templates?category=${c.id}" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:100px;font-size:14px;font-weight:500;text-decoration:none;border:2px solid ${active ? c.color : '#e2e8f0'};background:${active ? c.color + '15' : '#fff'};color:${active ? c.color : '#64748b'}">${c.icon} ${c.label}</span>`;
  });
  html += '</div>';

  // Template cards
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:16px">';
  templates.forEach(t => {
    const color = catColors[t.category] || '#6366f1';
    const isCustom = t.user_id !== null;
    html += `<div class="card" style="position:relative;border-left:4px solid ${color};transition:transform 0.15s" onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform='none'">`;
    html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">';
    html += `<div><span style="display:inline-block;padding:2px 10px;border-radius:100px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;background:${color}18;color:${color}">${esc(t.category)}</span>`;
    if (isCustom) html += ' <span style="display:inline-block;padding:2px 8px;border-radius:100px;font-size:11px;background:#f1f5f9;color:#64748b">Custom</span>';
    html += '</div>';
    if (isCustom) html += `<button onclick="deleteTpl('${t.id}')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:16px" title="Delete">\ud83d\uddd1</button>`;
    html += '</div>';
    html += `<h3 style="font-size:16px;margin:8px 0">${esc(t.title)}</h3>`;
    html += `<p style="color:#64748b;font-size:14px;line-height:1.6;margin-bottom:12px">${esc(t.body).substring(0, 180)}${t.body.length > 180 ? '...' : ''}</p>`;
    html += '<div style="display:flex;gap:8px">';
    html += `<button onclick="copyTpl(this, '${t.id}')" class="btn btn-primary btn-sm" style="font-size:13px">\ud83d\udccb Copy</button>`;
    html += `<button onclick="expandTpl('${t.id}')" class="btn btn-sm" style="font-size:13px;background:#f1f5f9;border:1px solid #e2e8f0;color:#334155">\ud83d\udc41 Preview</button>`;
    html += '</div></div>';
  });
  if (templates.length === 0) {
    html += '<div class="card" style="text-align:center;padding:40px;grid-column:1/-1"><p style="color:#64748b">No templates in this category yet.</p></div>';
  }
  html += '</div>';

  // New template modal
  html += `<div id="newTplModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:24px" onclick="if(event.target===this)this.style.display='none'">
<div style="background:#fff;border-radius:16px;padding:32px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="font-size:22px;margin:0">Create Custom Template</h2><button onclick="document.getElementById('newTplModal').style.display='none'" style="background:none;border:none;font-size:24px;cursor:pointer;color:#64748b">&times;</button></div>
<form id="newTplForm" onsubmit="saveTpl(event)">
<div class="form-group"><label>Category</label><select name="category" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px"><option value="positive">Positive</option><option value="negative">Negative</option><option value="neutral">Neutral</option><option value="apology">Apology</option><option value="follow-up">Follow-up</option></select></div>
<div class="form-group"><label>Template Name</label><input name="title" required placeholder="e.g. My Thank You Response" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px"></div>
<div class="form-group"><label>Response Text</label><textarea name="body" required rows="6" placeholder="Write your template response..." style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;resize:vertical"></textarea></div>
<button type="submit" class="btn btn-primary" style="width:100%;padding:12px">Save Template</button>
</form></div></div>`;

  // Preview modal
  html += `<div id="previewModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:24px" onclick="if(event.target===this)this.style.display='none'">
<div style="background:#fff;border-radius:16px;padding:32px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2 id="previewTitle" style="font-size:20px;margin:0"></h2><button onclick="document.getElementById('previewModal').style.display='none'" style="background:none;border:none;font-size:24px;cursor:pointer;color:#64748b">&times;</button></div>
<div id="previewBody" style="white-space:pre-wrap;line-height:1.7;color:#334155;font-size:15px;background:#f8fafc;padding:20px;border-radius:12px"></div>
<button onclick="navigator.clipboard.writeText(document.getElementById('previewBody').textContent);this.textContent='\u2713 Copied!';setTimeout(()=>this.textContent='Copy to Clipboard',2000)" class="btn btn-primary" style="width:100%;margin-top:16px;padding:12px">Copy to Clipboard</button>
</div></div>`;

  // JS
  html += '<scr' + 'ipt>';
  html += 'const tplData = ' + JSON.stringify(templates.map(t => ({ id: t.id, title: t.title, body: t.body }))) + ';';
  html += `
function copyTpl(btn, id) { const t = tplData.find(x=>x.id===id); if(t){navigator.clipboard.writeText(t.body);btn.textContent="\u2713 Copied!";setTimeout(()=>btn.textContent="\ud83d\udccb Copy",2000);} }
function expandTpl(id) { const t = tplData.find(x=>x.id===id); if(t){document.getElementById("previewTitle").textContent=t.title;document.getElementById("previewBody").textContent=t.body;document.getElementById("previewModal").style.display="flex";} }
async function saveTpl(e) { e.preventDefault(); const f=new FormData(e.target); const r=await fetch("/api/response-templates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:f.get("category"),title:f.get("title"),body:f.get("body")})}); const d=await r.json(); if(d.ok) location.reload(); else alert(d.error||"Error saving"); }
async function deleteTpl(id) { if(!confirm("Delete this template?")) return; const r=await fetch("/api/response-templates/"+id,{method:"DELETE"}); const d=await r.json(); if(d.ok) location.reload(); else alert(d.error||"Error"); }
`;
  html += '</scr' + 'ipt>';

  html += '</div>';
  res.send(dashLayout(user, html));
});

// API: Create response template
app.post('/api/response-templates', requireAuth, (req, res) => {
  const user = getUser(req);
  const { category, title, body } = req.body;
  if (!category || !title || !body) return res.json({ error: 'All fields required' });
  const id = uuidv4();
  db.prepare('INSERT INTO response_templates (id,user_id,category,title,body,is_default) VALUES (?,?,?,?,?,0)').run(id, user.id, category, title, body);
  res.json({ ok: true, id });
});

// API: Delete response template (only custom ones)
app.delete('/api/response-templates/:id', requireAuth, (req, res) => {
  const user = getUser(req);
  const r = db.prepare('DELETE FROM response_templates WHERE id=? AND user_id=? AND is_default=0').run(req.params.id, user.id);
  res.json({ ok: r.changes > 0 });
});

// API: Get templates for picker
app.get('/api/response-templates', requireAuth, (req, res) => {
  const user = getUser(req);
  const cat = req.query.category;
  let templates;
  if (cat && cat !== 'all') {
    templates = db.prepare('SELECT id,category,title,body FROM response_templates WHERE (user_id IS NULL OR user_id=?) AND category=? ORDER BY is_default DESC').all(user.id, cat);
  } else {
    templates = db.prepare('SELECT id,category,title,body FROM response_templates WHERE (user_id IS NULL OR user_id=?) ORDER BY category').all(user.id);
  }
  res.json(templates);
});

app.use((req, res) => { res.status(404).send(notFoundPage()); });


// ===== CAMPAIGNS API =====
app.get('/api/campaigns', requireAuth, (req, res) => {
  const campaigns = db.prepare('SELECT * FROM campaigns WHERE user_id = ? ORDER BY created_at DESC').all(req.session.userId);
  res.json({ campaigns });
});

app.post('/api/campaigns', requireAuth, (req, res) => {
  const { customer_name, contact, channel, template_id, message } = req.body;
  if (!customer_name || !contact) return res.status(400).json({ error: 'Customer name and contact required' });
  const id = uuidv4();
  const user = db.prepare('SELECT * FROM users WHERE id = ?').get(req.session.userId);
  const locations = db.prepare('SELECT * FROM locations WHERE user_id = ?').all(req.session.userId);
  const reviewLink = locations.length > 0 ? `${BASE_URL}/r/${locations[0].slug}` : `${BASE_URL}/review/${req.session.userId}`;
  db.prepare('INSERT INTO campaigns (id, user_id, customer_name, contact, channel, template_id, message, review_link, status) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)').run(id, req.session.userId, customer_name, contact, channel || 'email', template_id || 'friendly', message || '', reviewLink, 'sent');
  res.json({ campaign: { id, customer_name, contact, channel, template_id, message, review_link: reviewLink, status: 'sent', clicked: 0 }, message: 'Review request queued for delivery' });
});

app.get('/campaigns', requireAuth, (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.listen(PORT, '0.0.0.0', () => console.log(`ReviewFlow running on port ${PORT} ‚Äî ${BASE_URL}`));
