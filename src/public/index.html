<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProposalDash ‚Äî Win More Clients with Professional Proposals</title>
<meta name="description" content="Create, send, and track professional proposals in minutes. Built for freelancers and agencies.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÑ</text></svg>">
<style>
:root {
  --primary: #2563eb;
  --primary-dark: #1d4ed8;
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #1e293b;
  --text-light: #64748b;
  --border: #e2e8f0;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --radius: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
a { color: var(--primary); text-decoration: none; }
button, .btn { cursor: pointer; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; padding: 10px 20px; transition: all 0.15s; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--border); color: var(--text); }
.btn-secondary:hover { background: #cbd5e1; }
.btn-danger { background: var(--danger); color: white; }
.btn-success { background: var(--success); color: white; }
.btn-sm { padding: 6px 14px; font-size: 0.85rem; }
.btn-lg { padding: 14px 32px; font-size: 1.1rem; }
input, textarea, select { border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; font-size: 0.95rem; width: 100%; font-family: inherit; }
input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
textarea { resize: vertical; min-height: 80px; }
.card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
.hidden { display: none !important; }
.badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
.badge-draft { background: #f1f5f9; color: #64748b; }
.badge-sent { background: #dbeafe; color: #2563eb; }
.badge-accepted { background: #d1fae5; color: #059669; }
.badge-declined { background: #fee2e2; color: #dc2626; }
.badge-archived { background: #f1f5f9; color: #94a3b8; }

/* Nav */
nav { background: white; border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; justify-content: space-between; height: 64px; position: sticky; top: 0; z-index: 100; }
nav .logo { font-size: 1.3rem; font-weight: 800; color: var(--text); display: flex; align-items: center; gap: 8px; }
nav .logo span { color: var(--primary); }
nav .nav-links { display: flex; align-items: center; gap: 16px; }
nav .nav-links a { color: var(--text-light); font-weight: 500; font-size: 0.9rem; }
nav .nav-links a:hover { color: var(--primary); }

/* Layout */
.container { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }
.page { min-height: calc(100vh - 64px); }

/* Landing */
.hero { text-align: center; padding: 80px 24px 60px; max-width: 800px; margin: 0 auto; }
.hero h1 { font-size: 3rem; font-weight: 800; line-height: 1.1; margin-bottom: 20px; }
.hero h1 span { color: var(--primary); }
.hero p { font-size: 1.25rem; color: var(--text-light); margin-bottom: 32px; }
.hero-cta { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
.features { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; max-width: 1000px; margin: 0 auto; padding: 40px 24px 80px; }
.feature-card { text-align: center; padding: 32px 24px; }
.feature-card .icon { font-size: 2.5rem; margin-bottom: 16px; }
.feature-card h3 { margin-bottom: 8px; }
.feature-card p { color: var(--text-light); font-size: 0.95rem; }

/* Pricing */
.pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; max-width: 800px; margin: 40px auto; padding: 0 24px; }
.pricing-card { text-align: center; padding: 40px 32px; position: relative; }
.pricing-card.popular { border-color: var(--primary); box-shadow: 0 4px 24px rgba(37,99,235,0.15); }
.pricing-card .pop-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 4px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.pricing-card h3 { font-size: 1.3rem; margin-bottom: 8px; }
.pricing-card .price { font-size: 3rem; font-weight: 800; margin: 16px 0 4px; }
.pricing-card .price span { font-size: 1rem; color: var(--text-light); font-weight: 400; }
.pricing-card ul { list-style: none; margin: 24px 0; text-align: left; }
.pricing-card ul li { padding: 8px 0; color: var(--text-light); }
.pricing-card ul li::before { content: '‚úì'; color: var(--success); font-weight: 700; margin-right: 10px; }

/* Dashboard */
.dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
.dash-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
.stat-card { text-align: center; }
.stat-card .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); }
.stat-card .stat-label { color: var(--text-light); font-size: 0.85rem; }
.proposals-list { display: flex; flex-direction: column; gap: 12px; }
.proposal-row { display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 16px; align-items: center; padding: 16px 20px; cursor: pointer; transition: box-shadow 0.15s; }
.proposal-row:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
.proposal-row .title { font-weight: 600; }
.proposal-row .client { color: var(--text-light); font-size: 0.9rem; }
.proposal-row .amount { font-weight: 700; }
.proposal-row .views { color: var(--text-light); font-size: 0.85rem; }

/* Editor */
.editor-grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
@media (max-width: 900px) { .editor-grid { grid-template-columns: 1fr; } }
.editor-section { margin-bottom: 20px; }
.editor-section label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
.line-items-table { width: 100%; border-collapse: collapse; margin: 12px 0; }
.line-items-table th { text-align: left; padding: 8px; font-size: 0.8rem; color: var(--text-light); border-bottom: 2px solid var(--border); }
.line-items-table td { padding: 6px 8px; }
.line-items-table input { padding: 8px 10px; }
.line-items-table .qty { width: 70px; }
.line-items-table .price { width: 100px; }
.line-items-table .line-total { font-weight: 600; min-width: 80px; text-align: right; }
.totals-section { text-align: right; padding: 16px 0; }
.totals-section .total-row { display: flex; justify-content: flex-end; gap: 24px; padding: 4px 0; }
.totals-section .grand-total { font-size: 1.3rem; font-weight: 800; color: var(--primary); border-top: 2px solid var(--border); padding-top: 8px; margin-top: 8px; }

/* Preview panel */
.preview-panel { position: sticky; top: 88px; }
.preview-panel h3 { margin-bottom: 12px; }
.share-link { display: flex; gap: 8px; margin: 12px 0; }
.share-link input { flex: 1; background: var(--bg); }
.action-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }

/* Public proposal */
.public-proposal { max-width: 800px; margin: 40px auto; }
.public-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
.sender-info h2 { font-size: 1.5rem; }
.sender-info p { color: var(--text-light); }
.proposal-meta { text-align: right; }
.proposal-meta h1 { font-size: 2rem; margin-bottom: 8px; }
.public-section { margin: 24px 0; }
.public-section h3 { margin-bottom: 12px; color: var(--text-light); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
.accept-section { text-align: center; padding: 32px; margin-top: 32px; background: #f0fdf4; border-radius: var(--radius); }
.signature-pad { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; margin: 16px auto; max-width: 400px; }
.signature-pad input { text-align: center; font-size: 1.5rem; font-family: 'Brush Script MT', cursive; border: none; }

/* Toast */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--text); color: white; padding: 12px 24px; border-radius: 8px; font-weight: 500; z-index: 1000; animation: slideIn 0.3s; }
@keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Responsive */
@media (max-width: 768px) {
  .hero h1 { font-size: 2rem; }
  .proposal-row { grid-template-columns: 1fr; gap: 4px; }
  nav { padding: 0 16px; }
}
</style>
</head>
<body>

<nav>
  <a href="/" class="logo">üìÑ Proposal<span>Dash</span></a>
  <div class="nav-links" id="navLinks"></div>
</nav>

<div id="app"></div>

<script>
// State
let currentUser = null;
let currentPage = '';
let proposals = [];

// API helpers
async function api(url, opts = {}) {
  const res = await fetch(url, {
    headers: { 'Content-Type': 'application/json', ...opts.headers },
    ...opts
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

function toast(msg, duration = 3000) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), duration);
}

function formatMoney(amount, currency = 'USD') {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount);
}

// Router
function navigate(path) {
  history.pushState(null, '', path);
  route();
}

window.addEventListener('popstate', route);

function route() {
  const path = location.pathname;
  
  // Public proposal view
  if (path.startsWith('/p/')) {
    return renderPublicProposal(path.split('/p/')[1]);
  }
  
  if (!currentUser) {
    if (path === '/register') return renderRegister();
    if (path === '/login') return renderLogin();
    if (path === '/pricing') return renderPricing();
    return renderLanding();
  }
  
  if (path === '/dashboard') return renderDashboard();
  if (path === '/pricing') return renderPricing();
  if (path === '/settings') return renderSettings();
  if (path.startsWith('/edit/')) return renderEditor(path.split('/edit/')[1]);
  if (path === '/new') return renderEditor(null);
  
  return renderDashboard();
}

function renderNav() {
  const nav = document.getElementById('navLinks');
  if (currentUser) {
    nav.innerHTML = `
      <a href="/dashboard" onclick="event.preventDefault();navigate('/dashboard')">Dashboard</a>
      <a href="/pricing" onclick="event.preventDefault();navigate('/pricing')">Pricing</a>
      <a href="/settings" onclick="event.preventDefault();navigate('/settings')">Settings</a>
      <span style="color:var(--text-light);font-size:0.85rem">${currentUser.name}</span>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Log out</button>
    `;
  } else {
    nav.innerHTML = `
      <a href="/pricing" onclick="event.preventDefault();navigate('/pricing')">Pricing</a>
      <a href="/login" onclick="event.preventDefault();navigate('/login')">Log in</a>
      <button class="btn btn-primary btn-sm" onclick="navigate('/register')">Get Started Free</button>
    `;
  }
}

// Auth
async function checkAuth() {
  try {
    const data = await api('/api/auth/me');
    currentUser = data.user;
  } catch { currentUser = null; }
  renderNav();
  route();
}

async function logout() {
  await api('/api/auth/logout', { method: 'POST' });
  currentUser = null;
  renderNav();
  navigate('/');
}

// Pages
function renderLanding() {
  document.getElementById('app').innerHTML = `
    <div class="hero">
      <h1>Win More Clients with <span>Professional Proposals</span></h1>
      <p>Create beautiful, trackable proposals in minutes ‚Äî not hours. Know when clients view them. Get signatures instantly. Close deals faster.</p>
      <div class="hero-cta">
        <button class="btn btn-primary btn-lg" onclick="navigate('/register')">Start Free ‚Äî No Credit Card</button>
        <button class="btn btn-secondary btn-lg" onclick="navigate('/pricing')">See Pricing</button>
      </div>
    </div>
    <div class="features">
      <div class="card feature-card">
        <div class="icon">‚ö°</div>
        <h3>Create in Minutes</h3>
        <p>Professional proposals with your branding, line items, terms ‚Äî ready to send in under 5 minutes.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">üëÅÔ∏è</div>
        <h3>Track Views</h3>
        <p>Know exactly when your client opens the proposal. Follow up at the perfect moment.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">‚úçÔ∏è</div>
        <h3>E-Signatures</h3>
        <p>Clients accept and sign right in the browser. No printing, scanning, or back-and-forth.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">üí∞</div>
        <h3>Get Paid Faster</h3>
        <p>Clear pricing, professional presentation, instant acceptance ‚Äî shorten your sales cycle.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">üé®</div>
        <h3>Your Brand</h3>
        <p>Custom colors, your company name and details. Every proposal looks like it came from a design team.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">üìä</div>
        <h3>Dashboard</h3>
        <p>See all proposals at a glance ‚Äî draft, sent, viewed, accepted. Always know where you stand.</p>
      </div>
    </div>
    <div style="text-align:center;padding:40px 24px 80px">
      <h2 style="margin-bottom:8px">Ready to look more professional?</h2>
      <p style="color:var(--text-light);margin-bottom:24px">Join freelancers and agencies who close more deals with ProposalDash.</p>
      <button class="btn btn-primary btn-lg" onclick="navigate('/register')">Get Started Free</button>
    </div>
  `;
}

function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container" style="max-width:420px;padding-top:60px">
      <div class="card">
        <h2 style="margin-bottom:20px;text-align:center">Welcome back</h2>
        <form id="loginForm">
          <div class="editor-section"><label>Email</label><input type="email" id="loginEmail" required></div>
          <div class="editor-section"><label>Password</label><input type="password" id="loginPass" required></div>
          <button type="submit" class="btn btn-primary" style="width:100%">Log in</button>
        </form>
        <p style="text-align:center;margin-top:16px;color:var(--text-light)">No account? <a href="/register" onclick="event.preventDefault();navigate('/register')">Sign up free</a></p>
      </div>
    </div>
  `;
  document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    try {
      const data = await api('/api/auth/login', { method: 'POST', body: JSON.stringify({ email: document.getElementById('loginEmail').value, password: document.getElementById('loginPass').value }) });
      currentUser = data.user;
      renderNav();
      navigate('/dashboard');
      toast('Welcome back!');
    } catch (err) { toast(err.message); }
  };
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container" style="max-width:420px;padding-top:60px">
      <div class="card">
        <h2 style="margin-bottom:20px;text-align:center">Create your account</h2>
        <form id="regForm">
          <div class="editor-section"><label>Full Name</label><input id="regName" required></div>
          <div class="editor-section"><label>Company (optional)</label><input id="regCompany"></div>
          <div class="editor-section"><label>Email</label><input type="email" id="regEmail" required></div>
          <div class="editor-section"><label>Password</label><input type="password" id="regPass" required minlength="6"></div>
          <button type="submit" class="btn btn-primary" style="width:100%">Create Account</button>
        </form>
        <p style="text-align:center;margin-top:16px;color:var(--text-light)">Have an account? <a href="/login" onclick="event.preventDefault();navigate('/login')">Log in</a></p>
      </div>
    </div>
  `;
  document.getElementById('regForm').onsubmit = async (e) => {
    e.preventDefault();
    try {
      const data = await api('/api/auth/register', { method: 'POST', body: JSON.stringify({
        name: document.getElementById('regName').value,
        company: document.getElementById('regCompany').value,
        email: document.getElementById('regEmail').value,
        password: document.getElementById('regPass').value
      })});
      currentUser = data.user;
      renderNav();
      navigate('/dashboard');
      toast('Welcome to ProposalDash!');
    } catch (err) { toast(err.message); }
  };
}

async function renderDashboard() {
  try {
    const data = await api('/api/proposals');
    proposals = data.proposals;
  } catch (err) { proposals = []; }

  const totalValue = proposals.reduce((s, p) => s + (p.subtotal || 0), 0);
  const accepted = proposals.filter(p => p.status === 'accepted');
  const acceptedValue = accepted.reduce((s, p) => s + (p.subtotal || 0), 0);
  const totalViews = proposals.reduce((s, p) => s + (p.view_count || 0), 0);

  document.getElementById('app').innerHTML = `
    <div class="container page">
      <div class="dash-header">
        <div>
          <h1>Dashboard</h1>
          <p style="color:var(--text-light)">${currentUser.plan === 'pro' ? '‚≠ê Pro Plan' : 'Free Plan ‚Äî <a href="/pricing" onclick="event.preventDefault();navigate(\'/pricing\')">Upgrade</a>'}</p>
        </div>
        <button class="btn btn-primary" onclick="navigate('/new')">+ New Proposal</button>
      </div>
      <div class="dash-stats">
        <div class="card stat-card"><div class="stat-value">${proposals.length}</div><div class="stat-label">Total Proposals</div></div>
        <div class="card stat-card"><div class="stat-value">${formatMoney(totalValue)}</div><div class="stat-label">Total Value</div></div>
        <div class="card stat-card"><div class="stat-value">${accepted.length}</div><div class="stat-label">Accepted</div></div>
        <div class="card stat-card"><div class="stat-value">${totalViews}</div><div class="stat-label">Total Views</div></div>
      </div>
      ${proposals.length === 0 ? `
        <div class="card" style="text-align:center;padding:60px">
          <div style="font-size:3rem;margin-bottom:16px">üìÑ</div>
          <h2>Create your first proposal</h2>
          <p style="color:var(--text-light);margin:8px 0 24px">It takes less than 5 minutes to create a professional proposal.</p>
          <button class="btn btn-primary btn-lg" onclick="navigate('/new')">+ New Proposal</button>
        </div>
      ` : `
        <div class="proposals-list">
          ${proposals.map(p => `
            <div class="card proposal-row" onclick="navigate('/edit/${p.id}')">
              <div>
                <div class="title">${esc(p.title)}</div>
                <div class="client">${esc(p.client_name || p.client_company || 'No client')}</div>
              </div>
              <span class="badge badge-${p.status}">${p.status}</span>
              <span class="amount">${formatMoney(p.subtotal || 0)}</span>
              <span class="views">üëÅ ${p.view_count || 0}</span>
              <span style="color:var(--text-light);font-size:0.8rem">${new Date(p.created_at).toLocaleDateString()}</span>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;

  // Check for upgrade success
  if (location.search.includes('upgraded=true')) {
    toast('üéâ Welcome to Pro!');
    history.replaceState(null, '', '/dashboard');
    // Refresh user
    checkAuth();
  }
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

async function renderEditor(proposalId) {
  let proposal = null;
  if (proposalId) {
    try {
      const data = await api(`/api/proposals/${proposalId}`);
      proposal = data.proposal;
    } catch { return navigate('/dashboard'); }
  }

  const p = proposal || { title: '', client_name: '', client_email: '', client_company: '', intro_text: '', terms_text: '', currency: 'USD', discount_percent: 0, tax_percent: 0, valid_until: '', status: 'draft', line_items: [], share_token: '' };
  if (!p.line_items.length) p.line_items = [{ description: '', quantity: 1, unit_price: 0 }];

  const isNew = !proposalId;
  const baseUrl = location.origin;

  document.getElementById('app').innerHTML = `
    <div class="container page">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
        <h1>${isNew ? 'New Proposal' : 'Edit Proposal'}</h1>
        <button class="btn btn-secondary btn-sm" onclick="navigate('/dashboard')">‚Üê Back</button>
      </div>
      <div class="editor-grid">
        <div>
          <div class="card" style="margin-bottom:20px">
            <div class="editor-section"><label>Proposal Title</label><input id="ed-title" value="${esc(p.title)}" placeholder="e.g. Website Redesign for Acme Corp"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
              <div class="editor-section"><label>Client Name</label><input id="ed-cname" value="${esc(p.client_name)}"></div>
              <div class="editor-section"><label>Client Email</label><input id="ed-cemail" type="email" value="${esc(p.client_email)}"></div>
              <div class="editor-section"><label>Client Company</label><input id="ed-ccompany" value="${esc(p.client_company)}"></div>
            </div>
            <div class="editor-section"><label>Introduction</label><textarea id="ed-intro" placeholder="Describe the project scope and why you're the right fit...">${esc(p.intro_text)}</textarea></div>
          </div>

          <div class="card" style="margin-bottom:20px">
            <h3 style="margin-bottom:12px">Line Items</h3>
            <table class="line-items-table">
              <thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr></thead>
              <tbody id="lineItems"></tbody>
            </table>
            <button class="btn btn-secondary btn-sm" onclick="addLineItem()">+ Add Item</button>
            <div class="totals-section" id="totals"></div>
          </div>

          <div class="card">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
              <div class="editor-section"><label>Discount %</label><input id="ed-discount" type="number" min="0" max="100" value="${p.discount_percent}"></div>
              <div class="editor-section"><label>Tax %</label><input id="ed-tax" type="number" min="0" max="100" value="${p.tax_percent}"></div>
              <div class="editor-section"><label>Valid Until</label><input id="ed-valid" type="date" value="${p.valid_until || ''}"></div>
            </div>
            <div class="editor-section"><label>Terms & Conditions</label><textarea id="ed-terms" placeholder="Payment terms, delivery timeline, etc.">${esc(p.terms_text)}</textarea></div>
          </div>
        </div>

        <div class="preview-panel">
          <div class="card">
            <h3>Actions</h3>
            ${!isNew ? `
              <div style="margin:12px 0">
                <label style="font-size:0.85rem;color:var(--text-light)">Status</label>
                <span class="badge badge-${p.status}" style="margin-left:8px">${p.status}</span>
                ${p.view_count ? `<span style="margin-left:8px;color:var(--text-light);font-size:0.85rem">üëÅ ${p.view_count} views</span>` : ''}
              </div>
              <div class="share-link">
                <input readonly value="${baseUrl}/p/${p.share_token}" id="shareUrl">
                <button class="btn btn-secondary btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('shareUrl').value);toast('Link copied!')">Copy</button>
              </div>
            ` : ''}
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="saveProposal('${proposalId || ''}')">üíæ Save${isNew ? ' as Draft' : ''}</button>
              ${!isNew && p.status === 'draft' ? `<button class="btn btn-success" onclick="sendProposal('${proposalId}')">üì§ Mark as Sent</button>` : ''}
              ${!isNew ? `<button class="btn btn-secondary" onclick="window.open('/p/${p.share_token}','_blank')">üëÅ Preview</button>` : ''}
              ${!isNew ? `<button class="btn btn-secondary" onclick="duplicateProposal('${proposalId}')">üìã Duplicate</button>` : ''}
              ${!isNew ? `<button class="btn btn-danger btn-sm" onclick="deleteProposal('${proposalId}')" style="margin-top:8px">Delete</button>` : ''}
            </div>
          </div>
          ${!isNew && p.accepted_at ? `
            <div class="card" style="margin-top:16px;background:#f0fdf4">
              <h3 style="color:var(--success)">‚úÖ Accepted</h3>
              <p style="font-size:0.9rem;color:var(--text-light)">Signed: ${p.accepted_signature || 'N/A'}</p>
              <p style="font-size:0.85rem;color:var(--text-light)">${new Date(p.accepted_at).toLocaleString()}</p>
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  // Render line items
  window._lineItems = p.line_items.map(li => ({ ...li }));
  renderLineItems();
}

function renderLineItems() {
  const tbody = document.getElementById('lineItems');
  tbody.innerHTML = window._lineItems.map((item, i) => `
    <tr>
      <td><input value="${esc(item.description)}" onchange="window._lineItems[${i}].description=this.value;updateTotals()" placeholder="Service or product..."></td>
      <td><input class="qty" type="number" min="0" step="0.5" value="${item.quantity}" onchange="window._lineItems[${i}].quantity=parseFloat(this.value)||0;updateTotals()"></td>
      <td><input class="price" type="number" min="0" step="0.01" value="${item.unit_price}" onchange="window._lineItems[${i}].unit_price=parseFloat(this.value)||0;updateTotals()"></td>
      <td class="line-total">${formatMoney(item.quantity * item.unit_price)}</td>
      <td><button class="btn btn-secondary btn-sm" onclick="removeLineItem(${i})" style="padding:4px 8px">‚úï</button></td>
    </tr>
  `).join('');
  updateTotals();
}

function addLineItem() {
  window._lineItems.push({ description: '', quantity: 1, unit_price: 0 });
  renderLineItems();
}

function removeLineItem(i) {
  if (window._lineItems.length <= 1) return;
  window._lineItems.splice(i, 1);
  renderLineItems();
}

function updateTotals() {
  const subtotal = window._lineItems.reduce((s, li) => s + li.quantity * li.unit_price, 0);
  const discount = parseFloat(document.getElementById('ed-discount')?.value || 0);
  const tax = parseFloat(document.getElementById('ed-tax')?.value || 0);
  const discountAmt = subtotal * (discount / 100);
  const afterDiscount = subtotal - discountAmt;
  const taxAmt = afterDiscount * (tax / 100);
  const total = afterDiscount + taxAmt;

  const el = document.getElementById('totals');
  if (el) el.innerHTML = `
    <div class="total-row"><span>Subtotal:</span><span>${formatMoney(subtotal)}</span></div>
    ${discount > 0 ? `<div class="total-row"><span>Discount (${discount}%):</span><span>-${formatMoney(discountAmt)}</span></div>` : ''}
    ${tax > 0 ? `<div class="total-row"><span>Tax (${tax}%):</span><span>+${formatMoney(taxAmt)}</span></div>` : ''}
    <div class="total-row grand-total"><span>Total:</span><span>${formatMoney(total)}</span></div>
  `;
}

async function saveProposal(id) {
  const body = {
    title: document.getElementById('ed-title').value || 'Untitled Proposal',
    client_name: document.getElementById('ed-cname').value,
    client_email: document.getElementById('ed-cemail').value,
    client_company: document.getElementById('ed-ccompany').value,
    intro_text: document.getElementById('ed-intro').value,
    terms_text: document.getElementById('ed-terms').value,
    discount_percent: parseFloat(document.getElementById('ed-discount').value) || 0,
    tax_percent: parseFloat(document.getElementById('ed-tax').value) || 0,
    valid_until: document.getElementById('ed-valid').value || null,
    line_items: window._lineItems
  };

  try {
    if (id) {
      await api(`/api/proposals/${id}`, { method: 'PUT', body: JSON.stringify(body) });
      toast('Saved!');
      renderEditor(id);
    } else {
      const data = await api('/api/proposals', { method: 'POST', body: JSON.stringify(body) });
      toast('Proposal created!');
      navigate('/edit/' + data.proposal.id);
    }
  } catch (err) { toast(err.message); }
}

async function sendProposal(id) {
  try {
    await api(`/api/proposals/${id}`, { method: 'PUT', body: JSON.stringify({ status: 'sent' }) });
    toast('Proposal marked as sent!');
    renderEditor(id);
  } catch (err) { toast(err.message); }
}

async function duplicateProposal(id) {
  try {
    const data = await api(`/api/proposals/${id}/duplicate`, { method: 'POST' });
    toast('Duplicated!');
    navigate('/edit/' + data.proposal.id);
  } catch (err) { toast(err.message); }
}

async function deleteProposal(id) {
  if (!confirm('Delete this proposal?')) return;
  try {
    await api(`/api/proposals/${id}`, { method: 'DELETE' });
    toast('Deleted');
    navigate('/dashboard');
  } catch (err) { toast(err.message); }
}

// Public proposal view
async function renderPublicProposal(token) {
  try {
    const data = await api(`/api/proposals/public/${token}`);
    const p = data.proposal;
    const s = data.sender;
    const subtotal = p.line_items.reduce((sum, li) => sum + li.quantity * li.unit_price, 0);
    const discountAmt = subtotal * ((p.discount_percent || 0) / 100);
    const afterDiscount = subtotal - discountAmt;
    const taxAmt = afterDiscount * ((p.tax_percent || 0) / 100);
    const total = afterDiscount + taxAmt;

    document.getElementById('app').innerHTML = `
      <div class="container public-proposal">
        <div class="card" style="padding:40px">
          <div class="public-header">
            <div class="sender-info">
              <h2 style="color:${s.brand_color || 'var(--primary)'}">${esc(s.company || s.name)}</h2>
              <p>${esc(s.name)}${s.company ? ' ¬∑ ' + esc(s.company) : ''}</p>
              <p>${esc(s.email)}</p>
            </div>
            <div class="proposal-meta">
              <h1>${esc(p.title)}</h1>
              <p style="color:var(--text-light)">Prepared for <strong>${esc(p.client_name || p.client_company || 'Client')}</strong></p>
              ${p.valid_until ? `<p style="color:var(--text-light);font-size:0.85rem">Valid until ${new Date(p.valid_until).toLocaleDateString()}</p>` : ''}
              <span class="badge badge-${p.status}" style="margin-top:8px">${p.status}</span>
            </div>
          </div>

          ${p.intro_text ? `<div class="public-section"><h3>Overview</h3><p style="white-space:pre-wrap">${esc(p.intro_text)}</p></div>` : ''}

          <div class="public-section">
            <h3>Pricing</h3>
            <table class="line-items-table" style="margin-bottom:16px">
              <thead><tr><th>Description</th><th style="width:80px">Qty</th><th style="width:100px">Rate</th><th style="width:100px;text-align:right">Amount</th></tr></thead>
              <tbody>
                ${p.line_items.map(li => `
                  <tr>
                    <td>${esc(li.description)}</td>
                    <td>${li.quantity}</td>
                    <td>${formatMoney(li.unit_price, p.currency)}</td>
                    <td style="text-align:right;font-weight:600">${formatMoney(li.quantity * li.unit_price, p.currency)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="totals-section">
              <div class="total-row"><span>Subtotal:</span><span>${formatMoney(subtotal, p.currency)}</span></div>
              ${p.discount_percent > 0 ? `<div class="total-row"><span>Discount (${p.discount_percent}%):</span><span>-${formatMoney(discountAmt, p.currency)}</span></div>` : ''}
              ${p.tax_percent > 0 ? `<div class="total-row"><span>Tax (${p.tax_percent}%):</span><span>+${formatMoney(taxAmt, p.currency)}</span></div>` : ''}
              <div class="total-row grand-total"><span>Total:</span><span>${formatMoney(total, p.currency)}</span></div>
            </div>
          </div>

          ${p.terms_text ? `<div class="public-section"><h3>Terms & Conditions</h3><p style="white-space:pre-wrap">${esc(p.terms_text)}</p></div>` : ''}

          ${p.status === 'sent' ? `
            <div class="accept-section">
              <h2>Accept This Proposal</h2>
              <p style="color:var(--text-light)">Type your name below to sign and accept.</p>
              <div class="signature-pad">
                <input id="sig-input" placeholder="Your full name" style="font-size:1.8rem;font-style:italic">
              </div>
              <button class="btn btn-success btn-lg" onclick="acceptProposal('${token}')">‚úçÔ∏è Accept & Sign</button>
            </div>
          ` : ''}

          ${p.status === 'accepted' ? `
            <div class="accept-section">
              <h2>‚úÖ Proposal Accepted</h2>
              <p style="color:var(--text-light)">Signed by: <strong>${esc(p.accepted_signature)}</strong></p>
              <p style="color:var(--text-light);font-size:0.85rem">${new Date(p.accepted_at).toLocaleString()}</p>
            </div>
          ` : ''}
        </div>
        <p style="text-align:center;margin:24px 0;color:var(--text-light);font-size:0.85rem">Powered by <a href="/">ProposalDash</a></p>
      </div>
    `;
  } catch (err) {
    document.getElementById('app').innerHTML = `<div class="container" style="text-align:center;padding-top:80px"><h1>Proposal Not Found</h1><p style="color:var(--text-light)">This proposal may have been removed or the link is incorrect.</p></div>`;
  }
}

async function acceptProposal(token) {
  const sig = document.getElementById('sig-input').value.trim();
  if (!sig) return toast('Please type your name to sign');
  try {
    await api(`/api/proposals/public/${token}/accept`, { method: 'POST', body: JSON.stringify({ signature: sig }) });
    toast('Proposal accepted!');
    renderPublicProposal(token);
  } catch (err) { toast(err.message); }
}

function renderPricing() {
  document.getElementById('app').innerHTML = `
    <div class="container page" style="text-align:center;padding-top:60px">
      <h1>Simple Pricing</h1>
      <p style="color:var(--text-light);margin-top:8px">Start free, upgrade when you need more.</p>
      <div class="pricing-grid">
        <div class="card pricing-card">
          <h3>Free</h3>
          <div class="price">$0<span>/mo</span></div>
          <ul>
            <li>5 active proposals</li>
            <li>Shareable links</li>
            <li>View tracking</li>
            <li>E-signatures</li>
            <li>ProposalDash branding</li>
          </ul>
          <button class="btn btn-secondary" style="width:100%" onclick="navigate(currentUser ? '/dashboard' : '/register')">${currentUser ? 'Current Plan' : 'Get Started'}</button>
        </div>
        <div class="card pricing-card popular">
          <div class="pop-badge">Most Popular</div>
          <h3>Pro</h3>
          <div class="price">$19<span>/mo</span></div>
          <ul>
            <li>Unlimited proposals</li>
            <li>Custom branding</li>
            <li>Remove ProposalDash branding</li>
            <li>Priority support</li>
            <li>Proposal templates</li>
            <li>Analytics dashboard</li>
          </ul>
          <button class="btn btn-primary" style="width:100%" onclick="upgradeToPro()">
            ${currentUser?.plan === 'pro' ? '‚úì Current Plan' : 'Upgrade to Pro'}
          </button>
        </div>
      </div>
    </div>
  `;
}

async function upgradeToPro() {
  if (!currentUser) return navigate('/register');
  if (currentUser.plan === 'pro') return toast('You\'re already on Pro!');
  try {
    const data = await api('/api/stripe/checkout', { method: 'POST' });
    window.location.href = data.url;
  } catch (err) { toast(err.message); }
}

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container page" style="max-width:600px">
      <h1 style="margin-bottom:24px">Settings</h1>
      <div class="card">
        <form id="settingsForm">
          <div class="editor-section"><label>Name</label><input id="set-name" value="${esc(currentUser.name)}"></div>
          <div class="editor-section"><label>Company</label><input id="set-company" value="${esc(currentUser.company || '')}"></div>
          <div class="editor-section"><label>Brand Color</label><input id="set-color" type="color" value="${currentUser.brand_color || '#2563eb'}" style="width:60px;height:40px;padding:2px"></div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
      <div class="card" style="margin-top:20px">
        <h3>Account</h3>
        <p style="color:var(--text-light);margin:8px 0">Email: ${esc(currentUser.email)}</p>
        <p style="color:var(--text-light)">Plan: <strong>${currentUser.plan === 'pro' ? '‚≠ê Pro' : 'Free'}</strong> ${currentUser.plan !== 'pro' ? '<a href="/pricing" onclick="event.preventDefault();navigate(\'/pricing\')">Upgrade</a>' : ''}</p>
        <p style="color:var(--text-light);font-size:0.85rem;margin-top:8px">Member since ${new Date(currentUser.created_at).toLocaleDateString()}</p>
      </div>
    </div>
  `;
  document.getElementById('settingsForm').onsubmit = async (e) => {
    e.preventDefault();
    try {
      await api('/api/auth/me', { method: 'PUT', body: JSON.stringify({
        name: document.getElementById('set-name').value,
        company: document.getElementById('set-company').value,
        brand_color: document.getElementById('set-color').value
      })});
      const data = await api('/api/auth/me');
      currentUser = data.user;
      renderNav();
      toast('Settings saved!');
    } catch (err) { toast(err.message); }
  };
}

// Boot
checkAuth();
</script>
</body>
</html>
