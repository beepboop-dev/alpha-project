<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProposalDash ‚Äî Win More Clients with Professional Proposals</title>
<meta name="description" content="Create, send, and track professional proposals in minutes. Built for freelancers and agencies. Free to start.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÑ</text></svg>">
<style>
:root {
  --primary: #2563eb;
  --primary-dark: #1d4ed8;
  --primary-light: #eff6ff;
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #1e293b;
  --text-light: #64748b;
  --border: #e2e8f0;
  --success: #10b981;
  --success-light: #d1fae5;
  --warning: #f59e0b;
  --danger: #ef4444;
  --radius: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; -webkit-font-smoothing: antialiased; }
a { color: var(--primary); text-decoration: none; }
a:hover { text-decoration: underline; }
button, .btn { cursor: pointer; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; padding: 10px 20px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
button:disabled, .btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
.btn-secondary { background: var(--border); color: var(--text); }
.btn-secondary:hover:not(:disabled) { background: #cbd5e1; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover:not(:disabled) { background: #dc2626; }
.btn-success { background: var(--success); color: white; }
.btn-success:hover:not(:disabled) { background: #059669; }
.btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
.btn-outline:hover:not(:disabled) { background: var(--primary-light); }
.btn-sm { padding: 6px 14px; font-size: 0.85rem; }
.btn-lg { padding: 14px 32px; font-size: 1.1rem; }
.btn-xl { padding: 18px 40px; font-size: 1.2rem; border-radius: 12px; }
input, textarea, select { border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; font-size: 0.95rem; width: 100%; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s; }
input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
input.error, textarea.error { border-color: var(--danger); }
.field-error { color: var(--danger); font-size: 0.8rem; margin-top: 4px; }
textarea { resize: vertical; min-height: 80px; }
.card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
.hidden { display: none !important; }
.badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-draft { background: #f1f5f9; color: #64748b; }
.badge-sent { background: #dbeafe; color: #2563eb; }
.badge-accepted { background: #d1fae5; color: #059669; }
.badge-declined { background: #fee2e2; color: #dc2626; }
.badge-archived { background: #f1f5f9; color: #94a3b8; }
.sample-badge { background: #fef3c7; color: #92400e; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; }

/* Nav */
nav { background: white; border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; justify-content: space-between; height: 64px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px); background: rgba(255,255,255,0.95); }
nav .logo { font-size: 1.3rem; font-weight: 800; color: var(--text); display: flex; align-items: center; gap: 8px; text-decoration: none; }
nav .logo span { color: var(--primary); }
nav .nav-links { display: flex; align-items: center; gap: 16px; }
nav .nav-links a { color: var(--text-light); font-weight: 500; font-size: 0.9rem; text-decoration: none; }
nav .nav-links a:hover { color: var(--primary); }
.mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; padding: 4px; }

/* Layout */
.container { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }
.page { min-height: calc(100vh - 64px); }

/* Loading spinner */
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-state { text-align: center; padding: 60px; color: var(--text-light); }

/* Landing Hero */
.hero { text-align: center; padding: 80px 24px 40px; max-width: 820px; margin: 0 auto; }
.hero h1 { font-size: 3.2rem; font-weight: 800; line-height: 1.1; margin-bottom: 20px; letter-spacing: -0.02em; }
.hero h1 span { background: linear-gradient(135deg, var(--primary), #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.hero p { font-size: 1.3rem; color: var(--text-light); margin-bottom: 36px; max-width: 600px; margin-left: auto; margin-right: auto; }
.hero-cta { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-bottom: 24px; }
.hero-social-proof { display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--text-light); font-size: 0.9rem; margin-top: 16px; }
.hero-avatars { display: flex; }
.hero-avatars span { width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; margin-left: -8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }

/* Feature sections */
.features { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; max-width: 1000px; margin: 0 auto; padding: 40px 24px 60px; }
.feature-card { text-align: center; padding: 32px 24px; transition: transform 0.2s, box-shadow 0.2s; }
.feature-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
.feature-card .icon { font-size: 2.5rem; margin-bottom: 16px; }
.feature-card h3 { margin-bottom: 8px; font-size: 1.1rem; }
.feature-card p { color: var(--text-light); font-size: 0.95rem; }

/* How it works */
.how-it-works { background: white; padding: 80px 24px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
.how-it-works h2 { text-align: center; font-size: 2rem; margin-bottom: 48px; }
.steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 32px; max-width: 900px; margin: 0 auto; }
.step { text-align: center; }
.step-num { width: 48px; height: 48px; border-radius: 50%; background: var(--primary); color: white; font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
.step h3 { margin-bottom: 8px; }
.step p { color: var(--text-light); font-size: 0.95rem; }

/* Competitor comparison */
.comparison { padding: 80px 24px; max-width: 900px; margin: 0 auto; }
.comparison h2 { text-align: center; font-size: 2rem; margin-bottom: 12px; }
.comparison .subtitle { text-align: center; color: var(--text-light); margin-bottom: 40px; }
.comparison-table { width: 100%; border-collapse: collapse; }
.comparison-table th, .comparison-table td { padding: 14px 16px; text-align: center; border-bottom: 1px solid var(--border); }
.comparison-table th:first-child, .comparison-table td:first-child { text-align: left; font-weight: 500; }
.comparison-table thead th { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; }
.comparison-table .highlight { background: var(--primary-light); font-weight: 700; }
.comparison-table .highlight-head { background: var(--primary); color: white; border-radius: 8px 8px 0 0; }
.check { color: var(--success); font-weight: 700; }
.cross { color: var(--text-light); }

/* FAQ */
.faq { background: white; padding: 80px 24px; border-top: 1px solid var(--border); }
.faq h2 { text-align: center; font-size: 2rem; margin-bottom: 40px; }
.faq-list { max-width: 700px; margin: 0 auto; }
.faq-item { border-bottom: 1px solid var(--border); }
.faq-q { padding: 20px 0; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.faq-q:hover { color: var(--primary); }
.faq-q::after { content: '+'; font-size: 1.5rem; color: var(--text-light); transition: transform 0.2s; }
.faq-item.open .faq-q::after { transform: rotate(45deg); }
.faq-a { padding: 0 0 20px; color: var(--text-light); display: none; line-height: 1.7; }
.faq-item.open .faq-a { display: block; }

/* CTA */
.bottom-cta { text-align: center; padding: 80px 24px; background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 50%, #7c3aed 100%); color: white; }
.bottom-cta h2 { font-size: 2.2rem; margin-bottom: 12px; }
.bottom-cta p { opacity: 0.9; margin-bottom: 32px; font-size: 1.1rem; }
.bottom-cta .btn { background: white; color: var(--primary); }
.bottom-cta .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }

/* Footer */
.footer { text-align: center; padding: 32px 24px; color: var(--text-light); font-size: 0.85rem; border-top: 1px solid var(--border); }

/* Pricing */
.pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; max-width: 800px; margin: 40px auto; padding: 0 24px; }
.pricing-card { text-align: center; padding: 40px 32px; position: relative; transition: transform 0.2s; }
.pricing-card:hover { transform: translateY(-4px); }
.pricing-card.popular { border-color: var(--primary); border-width: 2px; box-shadow: 0 4px 24px rgba(37,99,235,0.15); }
.pricing-card .pop-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 4px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.pricing-card h3 { font-size: 1.3rem; margin-bottom: 8px; }
.pricing-card .price { font-size: 3rem; font-weight: 800; margin: 16px 0 4px; }
.pricing-card .price span { font-size: 1rem; color: var(--text-light); font-weight: 400; }
.pricing-card .price-note { font-size: 0.85rem; color: var(--text-light); margin-bottom: 16px; }
.pricing-card ul { list-style: none; margin: 24px 0; text-align: left; }
.pricing-card ul li { padding: 8px 0; color: var(--text-light); }
.pricing-card ul li::before { content: '‚úì'; color: var(--success); font-weight: 700; margin-right: 10px; }

/* Dashboard */
.dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
.dash-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
.stat-card { text-align: center; padding: 20px; }
.stat-card .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); }
.stat-card .stat-label { color: var(--text-light); font-size: 0.85rem; margin-top: 4px; }
.proposals-list { display: flex; flex-direction: column; gap: 12px; }
.proposal-row { display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 16px; align-items: center; padding: 16px 20px; cursor: pointer; transition: box-shadow 0.2s, transform 0.15s; }
.proposal-row:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); transform: translateY(-1px); }
.proposal-row .title { font-weight: 600; }
.proposal-row .client { color: var(--text-light); font-size: 0.9rem; }
.proposal-row .amount { font-weight: 700; }
.proposal-row .views { color: var(--text-light); font-size: 0.85rem; }

/* Empty state */
.empty-state { text-align: center; padding: 80px 24px; }
.empty-state .empty-icon { font-size: 4rem; margin-bottom: 16px; }
.empty-state h2 { margin-bottom: 8px; }
.empty-state p { color: var(--text-light); margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto; }

/* Editor */
.editor-grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
.editor-section { margin-bottom: 20px; }
.editor-section label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
.editor-section .hint { font-size: 0.8rem; color: var(--text-light); margin-top: 4px; }
.line-items-table { width: 100%; border-collapse: collapse; margin: 12px 0; }
.line-items-table th { text-align: left; padding: 8px; font-size: 0.8rem; color: var(--text-light); border-bottom: 2px solid var(--border); }
.line-items-table td { padding: 6px 8px; }
.line-items-table input { padding: 8px 10px; }
.line-items-table .qty { width: 70px; }
.line-items-table .price { width: 100px; }
.line-items-table .line-total { font-weight: 600; min-width: 80px; text-align: right; }
.totals-section { text-align: right; padding: 16px 0; }
.totals-section .total-row { display: flex; justify-content: flex-end; gap: 24px; padding: 4px 0; font-size: 0.95rem; }
.totals-section .grand-total { font-size: 1.3rem; font-weight: 800; color: var(--primary); border-top: 2px solid var(--border); padding-top: 8px; margin-top: 8px; }

/* Preview panel */
.preview-panel { position: sticky; top: 88px; }
.preview-panel h3 { margin-bottom: 12px; }
.share-link { display: flex; gap: 8px; margin: 12px 0; }
.share-link input { flex: 1; background: var(--bg); font-size: 0.85rem; }
.action-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }

/* Email modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 24px; }
.modal { background: white; border-radius: 16px; padding: 32px; max-width: 480px; width: 100%; max-height: 90vh; overflow-y: auto; }
.modal h2 { margin-bottom: 16px; }
.modal .close-btn { float: right; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); padding: 0; }

/* Public proposal */
.public-proposal { max-width: 800px; margin: 40px auto; }
.public-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
.sender-info h2 { font-size: 1.5rem; }
.sender-info p { color: var(--text-light); }
.proposal-meta { text-align: right; }
.proposal-meta h1 { font-size: 2rem; margin-bottom: 8px; }
.public-section { margin: 24px 0; }
.public-section h3 { margin-bottom: 12px; color: var(--text-light); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
.accept-section { text-align: center; padding: 32px; margin-top: 32px; background: #f0fdf4; border-radius: var(--radius); }
.signature-pad { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; margin: 16px auto; max-width: 400px; }
.signature-pad input { text-align: center; font-size: 1.5rem; font-family: 'Brush Script MT', 'Segoe Script', cursive; border: none; background: transparent; }
.signature-pad input:focus { box-shadow: none; }

/* Toast */
.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
.toast { background: var(--text); color: white; padding: 12px 24px; border-radius: 10px; font-weight: 500; animation: slideIn 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px; }
.toast-error { background: var(--danger); }
.toast-success { background: var(--success); }
@keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }

/* Responsive */
@media (max-width: 900px) {
  .editor-grid { grid-template-columns: 1fr; }
  .preview-panel { position: static; }
}
@media (max-width: 768px) {
  .hero h1 { font-size: 2.2rem; }
  .hero p { font-size: 1.1rem; }
  .proposal-row { grid-template-columns: 1fr auto; gap: 8px; }
  .proposal-row .views, .proposal-row .date-col { display: none; }
  nav { padding: 0 16px; }
  nav .nav-links { gap: 10px; }
  nav .nav-links a { font-size: 0.8rem; }
  .comparison-table { font-size: 0.85rem; }
  .comparison-table th, .comparison-table td { padding: 10px 8px; }
  .steps { grid-template-columns: 1fr; }
  .editor-section .three-col { grid-template-columns: 1fr !important; }
  .container { padding: 20px 16px; }
  .dash-stats { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 480px) {
  .hero h1 { font-size: 1.8rem; }
  .hero-cta { flex-direction: column; align-items: center; }
  .hero-cta .btn { width: 100%; max-width: 300px; }
  .pricing-grid { grid-template-columns: 1fr; }
  nav .nav-links .hide-mobile { display: none; }
}

/* Print styles for PDF */
@media print {
  nav, .action-buttons, .accept-section, .toast-container, .no-print { display: none !important; }
  body { background: white; }
  .card { border: none; box-shadow: none; }
  .public-proposal { margin: 0; }
}
</style>
</head>
<body>

<nav>
  <a href="/" class="logo" onclick="event.preventDefault();navigate('/')">üìÑ Proposal<span>Dash</span></a>
  <div class="nav-links" id="navLinks"></div>
</nav>

<div id="app"><div class="loading-state"><div class="spinner"></div></div></div>
<div class="toast-container" id="toastContainer"></div>

<script>
// State
let currentUser = null;
let currentPage = '';
let proposals = [];
let _saving = false;

// API helpers
async function api(url, opts = {}) {
  try {
    const res = await fetch(url, {
      headers: { 'Content-Type': 'application/json', ...opts.headers },
      ...opts
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Something went wrong');
    return data;
  } catch (e) {
    if (e.message === 'Failed to fetch') throw new Error('Network error. Please check your connection.');
    throw e;
  }
}

function toast(msg, type = '', duration = 3500) {
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = 'toast' + (type ? ' toast-' + type : '');
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => { el.style.animation = 'slideOut 0.3s forwards'; setTimeout(() => el.remove(), 300); }, duration);
}

function formatMoney(amount, currency = 'USD') {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount || 0);
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function truncate(s, len = 50) { return s && s.length > len ? s.slice(0, len) + '‚Ä¶' : s; }

// Router
function navigate(path) {
  history.pushState(null, '', path);
  route();
}
window.addEventListener('popstate', route);

function route() {
  const path = location.pathname;
  if (path.startsWith('/p/')) return renderPublicProposal(path.split('/p/')[1]);
  if (!currentUser) {
    if (path === '/register') return renderRegister();
    if (path === '/login') return renderLogin();
    if (path === '/pricing') return renderPricing();
    return renderLanding();
  }
  if (path === '/dashboard' || path === '/') return renderDashboard();
  if (path === '/pricing') return renderPricing();
  if (path === '/settings') return renderSettings();
  if (path.startsWith('/edit/')) return renderEditor(path.split('/edit/')[1]);
  if (path === '/new') return renderEditor(null);
  return renderDashboard();
}

function renderNav() {
  const nav = document.getElementById('navLinks');
  if (currentUser) {
    nav.innerHTML = `
      <a href="/dashboard" onclick="event.preventDefault();navigate('/dashboard')">Dashboard</a>
      <a href="/pricing" onclick="event.preventDefault();navigate('/pricing')" class="hide-mobile">Pricing</a>
      <a href="/settings" onclick="event.preventDefault();navigate('/settings')">Settings</a>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Log out</button>
    `;
  } else {
    nav.innerHTML = `
      <a href="/pricing" onclick="event.preventDefault();navigate('/pricing')" class="hide-mobile">Pricing</a>
      <a href="/login" onclick="event.preventDefault();navigate('/login')">Log in</a>
      <button class="btn btn-primary btn-sm" onclick="navigate('/register')">Get Started Free</button>
    `;
  }
}

// Auth
async function checkAuth() {
  try {
    const data = await api('/api/auth/me');
    currentUser = data.user;
  } catch { currentUser = null; }
  renderNav();
  route();
}

async function logout() {
  await api('/api/auth/logout', { method: 'POST' });
  currentUser = null;
  renderNav();
  navigate('/');
}

// ========================= LANDING PAGE =========================
function renderLanding() {
  document.getElementById('app').innerHTML = `
    <div class="hero">
      <h1>Win More Clients with <span>Professional Proposals</span></h1>
      <p>Create beautiful, trackable proposals in minutes ‚Äî not hours. Know when clients view them. Get e-signatures instantly.</p>
      <div class="hero-cta">
        <button class="btn btn-primary btn-xl" onclick="navigate('/register')">Start Free ‚Äî No Credit Card</button>
        <button class="btn btn-outline btn-lg" onclick="navigate('/pricing')">See Pricing ‚Üí</button>
      </div>
      <div class="hero-social-proof">
        <div class="hero-avatars">
          <span style="background:#dbeafe">üë©‚Äçüíº</span>
          <span style="background:#d1fae5">üë®‚Äçüíª</span>
          <span style="background:#fef3c7">üë©‚Äçüé®</span>
          <span style="background:#ede9fe">üë®‚Äçüîß</span>
        </div>
        <span>Trusted by freelancers & agencies worldwide</span>
      </div>
    </div>

    <div class="features">
      <div class="card feature-card">
        <div class="icon">‚ö°</div>
        <h3>Create in Under 5 Minutes</h3>
        <p>Professional proposals with your branding, line items, and terms ‚Äî ready to send before your coffee gets cold.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">üëÅÔ∏è</div>
        <h3>Know When They Look</h3>
        <p>Real-time view tracking. Know exactly when your client opens the proposal so you can follow up at the perfect moment.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">‚úçÔ∏è</div>
        <h3>E-Signatures Built In</h3>
        <p>Clients accept and sign right in the browser. No printing, scanning, or back-and-forth emails.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">üì±</div>
        <h3>Works Everywhere</h3>
        <p>Beautiful on desktop, tablet, and phone. Your clients can view and sign proposals from any device.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">üé®</div>
        <h3>Your Brand, Your Way</h3>
        <p>Custom colors and company details. Every proposal looks like it came from a professional design team.</p>
      </div>
      <div class="card feature-card">
        <div class="icon">üìä</div>
        <h3>Dashboard Analytics</h3>
        <p>Total value, acceptance rate, views ‚Äî always know where every proposal stands at a glance.</p>
      </div>
    </div>

    <div class="how-it-works">
      <h2>How It Works</h2>
      <div class="steps">
        <div class="step">
          <div class="step-num">1</div>
          <h3>Create Your Proposal</h3>
          <p>Add your client details, line items, pricing, terms, and introduction. Use our clean editor ‚Äî no templates to wrestle with.</p>
        </div>
        <div class="step">
          <div class="step-num">2</div>
          <h3>Share the Link</h3>
          <p>Every proposal gets a unique, beautiful shareable link. Send it via email, message, or however you communicate.</p>
        </div>
        <div class="step">
          <div class="step-num">3</div>
          <h3>Get Signed & Paid</h3>
          <p>Your client views the proposal, signs it electronically, and you're notified instantly. Time to celebrate! üéâ</p>
        </div>
      </div>
    </div>

    <div class="comparison">
      <h2>Why ProposalDash?</h2>
      <p class="subtitle">Professional proposal tools shouldn't cost a fortune.</p>
      <div style="overflow-x:auto">
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Feature</th>
              <th>PandaDoc</th>
              <th>Proposify</th>
              <th class="highlight-head">ProposalDash</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Starting Price</td><td>$35/mo</td><td>$49/mo</td><td class="highlight">Free / $19/mo</td></tr>
            <tr><td>Proposal Creation</td><td class="check">‚úì</td><td class="check">‚úì</td><td class="highlight check">‚úì</td></tr>
            <tr><td>E-Signatures</td><td class="check">‚úì</td><td class="check">‚úì</td><td class="highlight check">‚úì (Free!)</td></tr>
            <tr><td>View Tracking</td><td class="check">‚úì</td><td class="check">‚úì</td><td class="highlight check">‚úì (Free!)</td></tr>
            <tr><td>Shareable Links</td><td class="check">‚úì</td><td class="check">‚úì</td><td class="highlight check">‚úì</td></tr>
            <tr><td>PDF Export</td><td class="check">‚úì</td><td class="check">‚úì</td><td class="highlight check">‚úì</td></tr>
            <tr><td>No Credit Card to Start</td><td class="cross">‚úó</td><td class="cross">‚úó</td><td class="highlight check">‚úì</td></tr>
            <tr><td>Setup Time</td><td>30+ min</td><td>20+ min</td><td class="highlight">Under 2 min</td></tr>
            <tr><td>Learning Curve</td><td>Steep</td><td>Moderate</td><td class="highlight">None</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="faq">
      <h2>Frequently Asked Questions</h2>
      <div class="faq-list">
        <div class="faq-item">
          <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Is ProposalDash really free?</div>
          <div class="faq-a">Yes! The free plan includes up to 5 active proposals with full features: view tracking, e-signatures, shareable links, and PDF export. No credit card required. The Pro plan ($19/mo) unlocks unlimited proposals and custom branding.</div>
        </div>
        <div class="faq-item">
          <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Are the e-signatures legally binding?</div>
          <div class="faq-a">Our e-signatures capture the signer's name, timestamp, and IP address ‚Äî meeting the requirements for electronic signatures under ESIGN Act and eIDAS. For high-value contracts, we recommend consulting with your legal advisor.</div>
        </div>
        <div class="faq-item">
          <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Can I cancel my Pro plan anytime?</div>
          <div class="faq-a">Absolutely. No long-term contracts. Cancel anytime from your Settings page and you'll keep Pro features until the end of your billing period. Your proposals and data are always yours.</div>
        </div>
        <div class="faq-item">
          <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">What happens when a client views my proposal?</div>
          <div class="faq-a">Your dashboard updates in real-time with view counts and timestamps. You'll always know when a client has seen your proposal, helping you time your follow-ups perfectly.</div>
        </div>
        <div class="faq-item">
          <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Can I export proposals as PDF?</div>
          <div class="faq-a">Yes! Every proposal can be exported as a clean, professional PDF ‚Äî perfect for email attachments or your records. Available on both free and Pro plans.</div>
        </div>
        <div class="faq-item">
          <div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Do I need any technical skills?</div>
          <div class="faq-a">Not at all. If you can fill out a form, you can create a proposal. No design skills, no templates to customize, no learning curve. We even create sample proposals when you sign up so you can see how it works.</div>
        </div>
      </div>
    </div>

    <div class="bottom-cta">
      <h2>Ready to close more deals?</h2>
      <p>Join freelancers and agencies who look more professional with ProposalDash.</p>
      <button class="btn btn-xl" onclick="navigate('/register')">Get Started Free ‚Üí</button>
    </div>

    <div class="footer">
      <p>¬© ${new Date().getFullYear()} ProposalDash. Built for freelancers, by freelancers.</p>
    </div>
  `;
}

// ========================= AUTH PAGES =========================
function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container" style="max-width:420px;padding-top:60px">
      <div class="card">
        <h2 style="margin-bottom:20px;text-align:center">Welcome back</h2>
        <form id="loginForm">
          <div class="editor-section"><label>Email</label><input type="email" id="loginEmail" required placeholder="you@company.com"></div>
          <div class="editor-section"><label>Password</label><input type="password" id="loginPass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
          <div id="loginError" class="field-error" style="margin-bottom:12px"></div>
          <button type="submit" class="btn btn-primary" style="width:100%" id="loginBtn">Log in</button>
        </form>
        <p style="text-align:center;margin-top:16px;color:var(--text-light)">No account? <a href="/register" onclick="event.preventDefault();navigate('/register')">Sign up free</a></p>
      </div>
    </div>
  `;
  document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    const errEl = document.getElementById('loginError');
    errEl.textContent = '';
    btn.disabled = true; btn.textContent = 'Logging in...';
    try {
      const data = await api('/api/auth/login', { method: 'POST', body: JSON.stringify({ email: document.getElementById('loginEmail').value, password: document.getElementById('loginPass').value }) });
      currentUser = data.user;
      renderNav();
      navigate('/dashboard');
      toast('Welcome back!', 'success');
    } catch (err) {
      errEl.textContent = err.message;
      btn.disabled = false; btn.textContent = 'Log in';
    }
  };
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container" style="max-width:420px;padding-top:60px">
      <div class="card">
        <h2 style="margin-bottom:4px;text-align:center">Create your account</h2>
        <p style="text-align:center;color:var(--text-light);margin-bottom:24px">Free forever. No credit card required.</p>
        <form id="regForm">
          <div class="editor-section"><label>Full Name *</label><input id="regName" required placeholder="Jane Smith" minlength="2"></div>
          <div class="editor-section"><label>Company <span style="font-weight:400;color:var(--text-light)">(optional)</span></label><input id="regCompany" placeholder="Acme Agency"></div>
          <div class="editor-section"><label>Email *</label><input type="email" id="regEmail" required placeholder="jane@acme.com"></div>
          <div class="editor-section"><label>Password *</label><input type="password" id="regPass" required minlength="6" placeholder="At least 6 characters"><div class="hint">Minimum 6 characters</div></div>
          <div id="regError" class="field-error" style="margin-bottom:12px"></div>
          <button type="submit" class="btn btn-primary" style="width:100%" id="regBtn">Create Account</button>
        </form>
        <p style="text-align:center;margin-top:16px;color:var(--text-light)">Already have an account? <a href="/login" onclick="event.preventDefault();navigate('/login')">Log in</a></p>
      </div>
    </div>
  `;
  document.getElementById('regForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('regBtn');
    const errEl = document.getElementById('regError');
    errEl.textContent = '';
    btn.disabled = true; btn.textContent = 'Creating account...';
    try {
      const data = await api('/api/auth/register', { method: 'POST', body: JSON.stringify({
        name: document.getElementById('regName').value,
        company: document.getElementById('regCompany').value,
        email: document.getElementById('regEmail').value,
        password: document.getElementById('regPass').value
      })});
      currentUser = data.user;
      renderNav();
      navigate('/dashboard');
      toast('Welcome to ProposalDash! We created some sample proposals to get you started.', 'success', 5000);
    } catch (err) {
      errEl.textContent = err.message;
      btn.disabled = false; btn.textContent = 'Create Account';
    }
  };
}

// ========================= DASHBOARD =========================
async function renderDashboard() {
  document.getElementById('app').innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  try {
    const data = await api('/api/proposals');
    proposals = data.proposals;
  } catch (err) { proposals = []; toast(err.message, 'error'); }

  const realProposals = proposals.filter(p => !p.is_sample);
  const totalValue = proposals.reduce((s, p) => s + (p.subtotal || 0), 0);
  const accepted = proposals.filter(p => p.status === 'accepted');
  const acceptedValue = accepted.reduce((s, p) => s + (p.subtotal || 0), 0);
  const totalViews = proposals.reduce((s, p) => s + (p.view_count || 0), 0);
  const winRate = proposals.filter(p => p.status === 'sent' || p.status === 'accepted').length > 0
    ? Math.round(accepted.length / proposals.filter(p => p.status === 'sent' || p.status === 'accepted').length * 100) : 0;

  document.getElementById('app').innerHTML = `
    <div class="container page">
      <div class="dash-header">
        <div>
          <h1>Dashboard</h1>
          <p style="color:var(--text-light)">${currentUser.plan === 'pro' ? '‚≠ê Pro Plan' : `Free Plan (${realProposals.filter(p=>p.status!=='archived').length}/5 proposals) ¬∑ <a href="/pricing" onclick="event.preventDefault();navigate('/pricing')">Upgrade</a>`}</p>
        </div>
        <button class="btn btn-primary" onclick="navigate('/new')">+ New Proposal</button>
      </div>
      <div class="dash-stats">
        <div class="card stat-card"><div class="stat-value">${proposals.length}</div><div class="stat-label">Total Proposals</div></div>
        <div class="card stat-card"><div class="stat-value">${formatMoney(totalValue)}</div><div class="stat-label">Total Value</div></div>
        <div class="card stat-card"><div class="stat-value">${accepted.length}</div><div class="stat-label">Accepted</div></div>
        <div class="card stat-card"><div class="stat-value">${totalViews}</div><div class="stat-label">Total Views</div></div>
      </div>
      ${proposals.length === 0 ? `
        <div class="card empty-state">
          <div class="empty-icon">üìÑ</div>
          <h2>Create your first proposal</h2>
          <p>It takes less than 5 minutes to create a professional proposal that wins clients.</p>
          <button class="btn btn-primary btn-lg" onclick="navigate('/new')">+ New Proposal</button>
        </div>
      ` : `
        <div class="proposals-list">
          ${proposals.map(p => `
            <div class="card proposal-row" onclick="navigate('/edit/${p.id}')">
              <div>
                <div class="title">${esc(truncate(p.title, 60))}${p.is_sample ? '<span class="sample-badge">Sample</span>' : ''}</div>
                <div class="client">${esc(p.client_name || p.client_company || 'No client specified')}</div>
              </div>
              <span class="badge badge-${p.status}">${p.status}</span>
              <span class="amount">${formatMoney(p.subtotal || 0)}</span>
              <span class="views">üëÅ ${p.view_count || 0}</span>
              <span class="date-col" style="color:var(--text-light);font-size:0.8rem">${new Date(p.created_at).toLocaleDateString()}</span>
            </div>
          `).join('')}
        </div>
      `}
    </div>
  `;

  if (location.search.includes('upgraded=true')) {
    toast('üéâ Welcome to Pro! Enjoy unlimited proposals.', 'success', 5000);
    history.replaceState(null, '', '/dashboard');
    checkAuth();
  }
}

// ========================= EDITOR =========================
async function renderEditor(proposalId) {
  document.getElementById('app').innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  let proposal = null;
  if (proposalId) {
    try {
      const data = await api(`/api/proposals/${proposalId}`);
      proposal = data.proposal;
    } catch { toast('Proposal not found', 'error'); return navigate('/dashboard'); }
  }

  const p = proposal || { title: '', client_name: '', client_email: '', client_company: '', intro_text: '', terms_text: '', currency: 'USD', discount_percent: 0, tax_percent: 0, valid_until: '', status: 'draft', line_items: [], share_token: '', is_sample: 0 };
  if (!p.line_items.length) p.line_items = [{ description: '', quantity: 1, unit_price: 0 }];

  const isNew = !proposalId;
  const baseUrl = location.origin;

  document.getElementById('app').innerHTML = `
    <div class="container page">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px">
        <div>
          <h1>${isNew ? 'New Proposal' : 'Edit Proposal'}${p.is_sample ? ' <span class="sample-badge" style="font-size:0.7rem">Sample</span>' : ''}</h1>
          ${!isNew ? `<p style="color:var(--text-light);font-size:0.85rem">Last updated ${new Date(p.updated_at || p.created_at).toLocaleString()}</p>` : ''}
        </div>
        <button class="btn btn-secondary btn-sm" onclick="navigate('/dashboard')">‚Üê Back to Dashboard</button>
      </div>
      <div class="editor-grid">
        <div>
          <div class="card" style="margin-bottom:20px">
            <div class="editor-section"><label>Proposal Title *</label><input id="ed-title" value="${esc(p.title)}" placeholder="e.g. Website Redesign for Acme Corp" maxlength="200"></div>
            <div class="three-col" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
              <div class="editor-section"><label>Client Name</label><input id="ed-cname" value="${esc(p.client_name)}" placeholder="Jane Smith" maxlength="200"></div>
              <div class="editor-section"><label>Client Email</label><input id="ed-cemail" type="email" value="${esc(p.client_email)}" placeholder="jane@example.com" maxlength="200"></div>
              <div class="editor-section"><label>Client Company</label><input id="ed-ccompany" value="${esc(p.client_company)}" placeholder="Acme Corp" maxlength="200"></div>
            </div>
            <div class="editor-section"><label>Introduction</label><textarea id="ed-intro" placeholder="Describe the project scope and why you're the right fit..." maxlength="5000" rows="4">${esc(p.intro_text)}</textarea><div class="hint"><span id="introCount">${(p.intro_text||'').length}</span>/5000 characters</div></div>
          </div>

          <div class="card" style="margin-bottom:20px">
            <h3 style="margin-bottom:12px">Line Items</h3>
            <div style="overflow-x:auto">
              <table class="line-items-table">
                <thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr></thead>
                <tbody id="lineItems"></tbody>
              </table>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="addLineItem()">+ Add Item</button>
            <div class="totals-section" id="totals"></div>
          </div>

          <div class="card">
            <div class="three-col" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
              <div class="editor-section"><label>Discount %</label><input id="ed-discount" type="number" min="0" max="100" step="0.1" value="${p.discount_percent}" onchange="updateTotals()"></div>
              <div class="editor-section"><label>Tax %</label><input id="ed-tax" type="number" min="0" max="100" step="0.1" value="${p.tax_percent}" onchange="updateTotals()"></div>
              <div class="editor-section"><label>Valid Until</label><input id="ed-valid" type="date" value="${p.valid_until || ''}"></div>
            </div>
            <div class="editor-section"><label>Terms & Conditions</label><textarea id="ed-terms" placeholder="Payment terms, delivery timeline, revisions policy..." maxlength="5000" rows="4">${esc(p.terms_text)}</textarea></div>
          </div>
        </div>

        <div class="preview-panel">
          <div class="card">
            <h3>Actions</h3>
            ${!isNew ? `
              <div style="margin:12px 0">
                <label style="font-size:0.85rem;color:var(--text-light)">Status</label>
                <span class="badge badge-${p.status}" style="margin-left:8px">${p.status}</span>
                ${p.view_count ? `<span style="margin-left:8px;color:var(--text-light);font-size:0.85rem">üëÅ ${p.view_count} view${p.view_count !== 1 ? 's' : ''}</span>` : ''}
                ${p.last_viewed_at ? `<div style="font-size:0.8rem;color:var(--text-light);margin-top:4px">Last viewed: ${new Date(p.last_viewed_at).toLocaleString()}</div>` : ''}
              </div>
              <div class="share-link">
                <input readonly value="${baseUrl}/p/${p.share_token}" id="shareUrl">
                <button class="btn btn-secondary btn-sm" onclick="copyShareLink()">üìã Copy</button>
              </div>
            ` : ''}
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="saveProposal('${proposalId || ''}')" id="saveBtn">üíæ Save${isNew ? ' as Draft' : ''}</button>
              ${!isNew && p.status === 'draft' ? `<button class="btn btn-success" onclick="sendProposal('${proposalId}')">üì§ Mark as Sent</button>` : ''}
              ${!isNew ? `<button class="btn btn-secondary" onclick="window.open('/p/${p.share_token}','_blank')">üëÅ Preview</button>` : ''}
              ${!isNew ? `<button class="btn btn-secondary" onclick="downloadPDF('${proposalId}')">üì• Export PDF</button>` : ''}
              ${!isNew ? `<button class="btn btn-secondary" onclick="showEmailModal('${p.share_token}','${esc(p.title)}','${esc(p.client_email)}')">üìß Send via Email</button>` : ''}
              ${!isNew ? `<button class="btn btn-secondary" onclick="duplicateProposal('${proposalId}')">üìã Duplicate</button>` : ''}
              ${!isNew && p.status !== 'archived' ? `<button class="btn btn-secondary btn-sm" onclick="archiveProposal('${proposalId}')" style="margin-top:4px">üì¶ Archive</button>` : ''}
              ${!isNew ? `<button class="btn btn-danger btn-sm" onclick="deleteProposal('${proposalId}')" style="margin-top:4px">üóë Delete</button>` : ''}
            </div>
          </div>
          ${!isNew && p.accepted_at ? `
            <div class="card" style="margin-top:16px;background:#f0fdf4;border-color:#bbf7d0">
              <h3 style="color:var(--success)">‚úÖ Accepted</h3>
              <p style="font-size:0.95rem;margin-top:8px">Signed by: <strong style="font-family:'Brush Script MT','Segoe Script',cursive;font-size:1.2rem">${esc(p.accepted_signature)}</strong></p>
              <p style="font-size:0.85rem;color:var(--text-light);margin-top:4px">${new Date(p.accepted_at).toLocaleString()}</p>
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  // Character counter
  const introEl = document.getElementById('ed-intro');
  if (introEl) introEl.addEventListener('input', () => { document.getElementById('introCount').textContent = introEl.value.length; });

  window._lineItems = p.line_items.map(li => ({ ...li }));
  renderLineItems();
}

function renderLineItems() {
  const tbody = document.getElementById('lineItems');
  tbody.innerHTML = window._lineItems.map((item, i) => `
    <tr>
      <td><input value="${esc(item.description)}" onchange="window._lineItems[${i}].description=this.value;updateTotals()" placeholder="Service or product..." maxlength="500"></td>
      <td><input class="qty" type="number" min="0" step="0.5" value="${item.quantity}" onchange="window._lineItems[${i}].quantity=Math.max(0,parseFloat(this.value)||0);updateTotals()"></td>
      <td><input class="price" type="number" min="0" step="0.01" value="${item.unit_price}" onchange="window._lineItems[${i}].unit_price=Math.max(0,parseFloat(this.value)||0);updateTotals()"></td>
      <td class="line-total">${formatMoney(item.quantity * item.unit_price)}</td>
      <td><button class="btn btn-secondary btn-sm" onclick="removeLineItem(${i})" style="padding:4px 8px" ${window._lineItems.length <= 1 ? 'disabled title="Need at least one item"' : ''}>‚úï</button></td>
    </tr>
  `).join('');
  updateTotals();
}

function addLineItem() {
  if (window._lineItems.length >= 50) return toast('Maximum 50 line items', 'error');
  window._lineItems.push({ description: '', quantity: 1, unit_price: 0 });
  renderLineItems();
  // Focus the new description input
  const inputs = document.querySelectorAll('#lineItems tr:last-child input');
  if (inputs[0]) inputs[0].focus();
}

function removeLineItem(i) {
  if (window._lineItems.length <= 1) return;
  window._lineItems.splice(i, 1);
  renderLineItems();
}

function updateTotals() {
  const subtotal = window._lineItems.reduce((s, li) => s + (li.quantity || 0) * (li.unit_price || 0), 0);
  const discount = Math.max(0, Math.min(100, parseFloat(document.getElementById('ed-discount')?.value || 0)));
  const tax = Math.max(0, Math.min(100, parseFloat(document.getElementById('ed-tax')?.value || 0)));
  const discountAmt = subtotal * (discount / 100);
  const afterDiscount = subtotal - discountAmt;
  const taxAmt = afterDiscount * (tax / 100);
  const total = afterDiscount + taxAmt;

  const el = document.getElementById('totals');
  if (el) el.innerHTML = `
    <div class="total-row"><span>Subtotal:</span><span>${formatMoney(subtotal)}</span></div>
    ${discount > 0 ? `<div class="total-row"><span>Discount (${discount}%):</span><span style="color:var(--danger)">-${formatMoney(discountAmt)}</span></div>` : ''}
    ${tax > 0 ? `<div class="total-row"><span>Tax (${tax}%):</span><span>+${formatMoney(taxAmt)}</span></div>` : ''}
    <div class="total-row grand-total"><span>Total:</span><span>${formatMoney(total)}</span></div>
  `;
}

function copyShareLink() {
  const url = document.getElementById('shareUrl').value;
  navigator.clipboard.writeText(url).then(() => toast('Link copied to clipboard!', 'success')).catch(() => {
    document.getElementById('shareUrl').select();
    document.execCommand('copy');
    toast('Link copied!', 'success');
  });
}

async function saveProposal(id) {
  if (_saving) return;
  const title = document.getElementById('ed-title').value.trim();
  if (!title) { toast('Please enter a proposal title', 'error'); document.getElementById('ed-title').focus(); return; }
  
  // Validate line items have at least one with description
  const hasValidItem = window._lineItems.some(li => li.description && li.description.trim());
  if (!hasValidItem) { toast('Please add at least one line item with a description', 'error'); return; }

  _saving = true;
  const btn = document.getElementById('saveBtn');
  const origText = btn.textContent;
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Saving...';

  const body = {
    title,
    client_name: document.getElementById('ed-cname').value,
    client_email: document.getElementById('ed-cemail').value,
    client_company: document.getElementById('ed-ccompany').value,
    intro_text: document.getElementById('ed-intro').value,
    terms_text: document.getElementById('ed-terms').value,
    discount_percent: parseFloat(document.getElementById('ed-discount').value) || 0,
    tax_percent: parseFloat(document.getElementById('ed-tax').value) || 0,
    valid_until: document.getElementById('ed-valid').value || null,
    line_items: window._lineItems
  };

  try {
    if (id) {
      await api(`/api/proposals/${id}`, { method: 'PUT', body: JSON.stringify(body) });
      toast('Saved!', 'success');
      renderEditor(id);
    } else {
      const data = await api('/api/proposals', { method: 'POST', body: JSON.stringify(body) });
      toast('Proposal created!', 'success');
      navigate('/edit/' + data.proposal.id);
    }
  } catch (err) { toast(err.message, 'error'); btn.disabled = false; btn.textContent = origText; }
  _saving = false;
}

async function sendProposal(id) {
  if (!confirm('Mark this proposal as sent? The client will be able to view and sign it.')) return;
  try {
    await api(`/api/proposals/${id}`, { method: 'PUT', body: JSON.stringify({ status: 'sent' }) });
    toast('Proposal marked as sent!', 'success');
    renderEditor(id);
  } catch (err) { toast(err.message, 'error'); }
}

async function archiveProposal(id) {
  try {
    await api(`/api/proposals/${id}`, { method: 'PUT', body: JSON.stringify({ status: 'archived' }) });
    toast('Proposal archived', 'success');
    renderEditor(id);
  } catch (err) { toast(err.message, 'error'); }
}

async function duplicateProposal(id) {
  try {
    const data = await api(`/api/proposals/${id}/duplicate`, { method: 'POST' });
    toast('Duplicated!', 'success');
    navigate('/edit/' + data.proposal.id);
  } catch (err) { toast(err.message, 'error'); }
}

async function deleteProposal(id) {
  if (!confirm('Are you sure you want to delete this proposal? This cannot be undone.')) return;
  try {
    await api(`/api/proposals/${id}`, { method: 'DELETE' });
    toast('Proposal deleted', 'success');
    navigate('/dashboard');
  } catch (err) { toast(err.message, 'error'); }
}

// ========================= PDF EXPORT =========================
async function downloadPDF(proposalId) {
  toast('Generating PDF...', '', 2000);
  try {
    const data = await api(`/api/proposals/${proposalId}/pdf-data`);
    const p = data.proposal;
    const s = data.sender;
    generatePDFHTML(p, s);
  } catch (err) { toast('Failed to generate PDF: ' + err.message, 'error'); }
}

function generatePDFHTML(p, s) {
  const subtotal = p.line_items.reduce((sum, li) => sum + li.quantity * li.unit_price, 0);
  const discountAmt = subtotal * ((p.discount_percent || 0) / 100);
  const afterDiscount = subtotal - discountAmt;
  const taxAmt = afterDiscount * ((p.tax_percent || 0) / 100);
  const total = afterDiscount + taxAmt;

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(p.title)} - Proposal</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; color: #1e293b; line-height: 1.6; padding: 40px; max-width: 800px; margin: 0 auto; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; border-bottom: 3px solid ${s.brand_color || '#2563eb'}; padding-bottom: 24px; }
  .sender h2 { color: ${s.brand_color || '#2563eb'}; font-size: 1.4rem; }
  .sender p { color: #64748b; font-size: 0.9rem; }
  .meta { text-align: right; }
  .meta h1 { font-size: 1.8rem; margin-bottom: 4px; }
  .meta p { color: #64748b; font-size: 0.9rem; }
  .status { display: inline-block; padding: 3px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background: ${p.status === 'accepted' ? '#d1fae5' : p.status === 'sent' ? '#dbeafe' : '#f1f5f9'}; color: ${p.status === 'accepted' ? '#059669' : p.status === 'sent' ? '#2563eb' : '#64748b'}; margin-top: 8px; }
  .section { margin: 24px 0; }
  .section h3 { color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 10px 12px; font-size: 0.8rem; color: #64748b; border-bottom: 2px solid #e2e8f0; }
  td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }
  .text-right { text-align: right; }
  .fw-bold { font-weight: 600; }
  .totals { text-align: right; margin-top: 16px; }
  .totals .row { display: flex; justify-content: flex-end; gap: 32px; padding: 4px 0; }
  .totals .grand { font-size: 1.3rem; font-weight: 800; color: ${s.brand_color || '#2563eb'}; border-top: 2px solid #e2e8f0; padding-top: 8px; margin-top: 8px; }
  .terms { white-space: pre-wrap; color: #475569; }
  .accepted { text-align: center; padding: 24px; background: #f0fdf4; border-radius: 12px; margin-top: 32px; }
  .accepted h3 { color: #059669; }
  .signature { font-family: 'Brush Script MT', 'Segoe Script', cursive; font-size: 1.5rem; margin: 8px 0; }
  .footer { text-align: center; margin-top: 48px; padding-top: 16px; border-top: 1px solid #e2e8f0; color: #94a3b8; font-size: 0.8rem; }
  @media print { body { padding: 20px; } .no-print { display: none; } }
</style></head><body>
<div class="no-print" style="text-align:center;margin-bottom:24px;padding:12px;background:#eff6ff;border-radius:8px">
  <button onclick="window.print()" style="background:${s.brand_color || '#2563eb'};color:white;border:none;padding:10px 24px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer">‚¨á Download as PDF (Print ‚Üí Save as PDF)</button>
</div>
<div class="header">
  <div class="sender">
    <h2>${esc(s.company || s.name)}</h2>
    <p>${esc(s.name)}</p>
    <p>${esc(s.email)}</p>
  </div>
  <div class="meta">
    <h1>${esc(p.title)}</h1>
    <p>Prepared for <strong>${esc(p.client_name || p.client_company || 'Client')}</strong></p>
    ${p.client_company && p.client_name ? `<p>${esc(p.client_company)}</p>` : ''}
    ${p.valid_until ? `<p>Valid until ${new Date(p.valid_until).toLocaleDateString()}</p>` : ''}
    <span class="status">${p.status}</span>
  </div>
</div>
${p.intro_text ? `<div class="section"><h3>Overview</h3><p style="white-space:pre-wrap;color:#475569">${esc(p.intro_text)}</p></div>` : ''}
<div class="section">
  <h3>Pricing</h3>
  <table><thead><tr><th>Description</th><th style="width:70px">Qty</th><th style="width:100px">Rate</th><th style="width:100px" class="text-right">Amount</th></tr></thead><tbody>
  ${p.line_items.map(li => `<tr><td>${esc(li.description)}</td><td>${li.quantity}</td><td>${formatMoney(li.unit_price, p.currency)}</td><td class="text-right fw-bold">${formatMoney(li.quantity * li.unit_price, p.currency)}</td></tr>`).join('')}
  </tbody></table>
  <div class="totals">
    <div class="row"><span>Subtotal:</span><span>${formatMoney(subtotal, p.currency)}</span></div>
    ${p.discount_percent > 0 ? `<div class="row"><span>Discount (${p.discount_percent}%):</span><span>-${formatMoney(discountAmt, p.currency)}</span></div>` : ''}
    ${p.tax_percent > 0 ? `<div class="row"><span>Tax (${p.tax_percent}%):</span><span>+${formatMoney(taxAmt, p.currency)}</span></div>` : ''}
    <div class="row grand"><span>Total:</span><span>${formatMoney(total, p.currency)}</span></div>
  </div>
</div>
${p.terms_text ? `<div class="section"><h3>Terms & Conditions</h3><p class="terms">${esc(p.terms_text)}</p></div>` : ''}
${p.accepted_at ? `<div class="accepted"><h3>‚úÖ Proposal Accepted</h3><div class="signature">${esc(p.accepted_signature)}</div><p style="color:#64748b;font-size:0.85rem">${new Date(p.accepted_at).toLocaleString()}</p></div>` : ''}
<div class="footer">Generated by ProposalDash ¬∑ ${new Date().toLocaleDateString()}</div>
</body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
}

// ========================= EMAIL MODAL =========================
function showEmailModal(shareToken, title, clientEmail) {
  const baseUrl = location.origin;
  const link = baseUrl + '/p/' + shareToken;
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = `
    <div class="modal">
      <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      <h2>üìß Send Proposal via Email</h2>
      <p style="color:var(--text-light);margin-bottom:20px">Copy the message below and send it to your client via your email app.</p>
      <div class="editor-section">
        <label>To</label>
        <input id="emailTo" value="${esc(clientEmail)}" placeholder="client@example.com">
      </div>
      <div class="editor-section">
        <label>Subject</label>
        <input id="emailSubject" value="Proposal: ${esc(title)}" readonly>
      </div>
      <div class="editor-section">
        <label>Message</label>
        <textarea id="emailBody" rows="8" readonly style="font-size:0.9rem">Hi ${clientEmail ? clientEmail.split('@')[0] : 'there'},

I've prepared a proposal for you. You can view it, review the details, and accept it directly online:

${link}

Please let me know if you have any questions!

Best regards,
${currentUser?.name || ''}</textarea>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="copyEmailContent()">üìã Copy Message</button>
        <a href="mailto:${esc(clientEmail)}?subject=${encodeURIComponent('Proposal: ' + title)}&body=${encodeURIComponent('Hi,\n\nI\'ve prepared a proposal for you:\n\n' + link + '\n\nPlease let me know if you have any questions!\n\nBest regards,\n' + (currentUser?.name || ''))}" class="btn btn-secondary" target="_blank">üìß Open in Email App</a>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

function copyEmailContent() {
  const body = document.getElementById('emailBody').value;
  navigator.clipboard.writeText(body).then(() => toast('Message copied!', 'success')).catch(() => toast('Please select and copy manually', 'error'));
}

// ========================= PUBLIC PROPOSAL =========================
async function renderPublicProposal(token) {
  document.getElementById('app').innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  try {
    const data = await api(`/api/proposals/public/${token}`);
    const p = data.proposal;
    const s = data.sender;
    const subtotal = p.line_items.reduce((sum, li) => sum + li.quantity * li.unit_price, 0);
    const discountAmt = subtotal * ((p.discount_percent || 0) / 100);
    const afterDiscount = subtotal - discountAmt;
    const taxAmt = afterDiscount * ((p.tax_percent || 0) / 100);
    const total = afterDiscount + taxAmt;

    document.getElementById('app').innerHTML = `
      <div class="container public-proposal">
        <div class="card" style="padding:40px">
          <div class="public-header">
            <div class="sender-info">
              <h2 style="color:${s.brand_color || 'var(--primary)'}">${esc(s.company || s.name)}</h2>
              <p>${esc(s.name)}${s.company ? ' ¬∑ ' + esc(s.company) : ''}</p>
              <p style="font-size:0.9rem">${esc(s.email)}</p>
            </div>
            <div class="proposal-meta">
              <h1>${esc(p.title)}</h1>
              <p style="color:var(--text-light)">Prepared for <strong>${esc(p.client_name || p.client_company || 'You')}</strong></p>
              ${p.client_company && p.client_name ? `<p style="color:var(--text-light);font-size:0.9rem">${esc(p.client_company)}</p>` : ''}
              ${p.valid_until ? `<p style="color:var(--text-light);font-size:0.85rem">Valid until ${new Date(p.valid_until).toLocaleDateString()}</p>` : ''}
              <span class="badge badge-${p.status}" style="margin-top:8px">${p.status}</span>
            </div>
          </div>

          ${p.intro_text ? `<div class="public-section"><h3>Overview</h3><p style="white-space:pre-wrap">${esc(p.intro_text)}</p></div>` : ''}

          <div class="public-section">
            <h3>Pricing</h3>
            <div style="overflow-x:auto">
              <table class="line-items-table" style="margin-bottom:16px">
                <thead><tr><th>Description</th><th style="width:70px">Qty</th><th style="width:100px">Rate</th><th style="width:100px;text-align:right">Amount</th></tr></thead>
                <tbody>
                  ${p.line_items.map(li => `
                    <tr>
                      <td>${esc(li.description)}</td>
                      <td>${li.quantity}</td>
                      <td>${formatMoney(li.unit_price, p.currency)}</td>
                      <td style="text-align:right;font-weight:600">${formatMoney(li.quantity * li.unit_price, p.currency)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            <div class="totals-section">
              <div class="total-row"><span>Subtotal:</span><span>${formatMoney(subtotal, p.currency)}</span></div>
              ${p.discount_percent > 0 ? `<div class="total-row"><span>Discount (${p.discount_percent}%):</span><span style="color:var(--danger)">-${formatMoney(discountAmt, p.currency)}</span></div>` : ''}
              ${p.tax_percent > 0 ? `<div class="total-row"><span>Tax (${p.tax_percent}%):</span><span>+${formatMoney(taxAmt, p.currency)}</span></div>` : ''}
              <div class="total-row grand-total"><span>Total:</span><span>${formatMoney(total, p.currency)}</span></div>
            </div>
          </div>

          ${p.terms_text ? `<div class="public-section"><h3>Terms & Conditions</h3><p style="white-space:pre-wrap">${esc(p.terms_text)}</p></div>` : ''}

          ${p.status === 'sent' ? `
            <div class="accept-section">
              <h2 style="margin-bottom:8px">Accept This Proposal</h2>
              <p style="color:var(--text-light)">By typing your name below, you agree to the terms above and accept this proposal.</p>
              <div class="signature-pad">
                <input id="sig-input" placeholder="Type your full name" style="font-size:1.8rem;font-style:italic">
              </div>
              <div id="acceptError" class="field-error" style="margin-bottom:12px"></div>
              <button class="btn btn-success btn-lg" onclick="acceptProposal('${token}')" id="acceptBtn">‚úçÔ∏è Accept & Sign</button>
            </div>
          ` : ''}

          ${p.status === 'accepted' ? `
            <div class="accept-section">
              <h2>‚úÖ Proposal Accepted</h2>
              <p style="font-family:'Brush Script MT','Segoe Script',cursive;font-size:1.8rem;margin:12px 0">${esc(p.accepted_signature)}</p>
              <p style="color:var(--text-light);font-size:0.85rem">${new Date(p.accepted_at).toLocaleString()}</p>
            </div>
          ` : ''}

          ${p.status === 'draft' ? `
            <div style="text-align:center;padding:24px;background:#fef3c7;border-radius:var(--radius);margin-top:24px">
              <p style="color:#92400e;font-weight:600">‚ö†Ô∏è This proposal is still a draft and not yet available for acceptance.</p>
            </div>
          ` : ''}
        </div>

        <div class="no-print" style="text-align:center;margin:24px 0">
          <button class="btn btn-secondary" onclick="publicDownloadPDF('${token}')">üì• Download as PDF</button>
        </div>

        <p style="text-align:center;margin:24px 0;color:var(--text-light);font-size:0.85rem">Powered by <a href="/">ProposalDash</a> ‚Äî Professional proposals for freelancers</p>
      </div>
    `;
  } catch (err) {
    document.getElementById('app').innerHTML = `
      <div class="container" style="text-align:center;padding-top:80px">
        <div style="font-size:4rem;margin-bottom:16px">üîç</div>
        <h1>Proposal Not Found</h1>
        <p style="color:var(--text-light);margin:12px 0 24px">This proposal may have been removed or the link is incorrect.</p>
        <a href="/" class="btn btn-primary">Go to ProposalDash</a>
      </div>
    `;
  }
}

async function acceptProposal(token) {
  const sig = document.getElementById('sig-input').value.trim();
  const errEl = document.getElementById('acceptError');
  errEl.textContent = '';
  if (!sig) { errEl.textContent = 'Please type your full name to sign'; document.getElementById('sig-input').focus(); return; }
  if (sig.length < 2) { errEl.textContent = 'Please enter your full name'; return; }
  
  const btn = document.getElementById('acceptBtn');
  btn.disabled = true; btn.textContent = 'Accepting...';
  try {
    await api(`/api/proposals/public/${token}/accept`, { method: 'POST', body: JSON.stringify({ signature: sig }) });
    toast('üéâ Proposal accepted! Thank you.', 'success', 5000);
    renderPublicProposal(token);
  } catch (err) {
    errEl.textContent = err.message;
    btn.disabled = false; btn.textContent = '‚úçÔ∏è Accept & Sign';
  }
}

async function publicDownloadPDF(token) {
  try {
    const data = await api(`/api/proposals/public/${token}/pdf-data`);
    generatePDFHTML(data.proposal, data.sender);
  } catch (err) { toast('Failed to generate PDF', 'error'); }
}

// ========================= PRICING =========================
function renderPricing() {
  document.getElementById('app').innerHTML = `
    <div class="container page" style="text-align:center;padding-top:60px">
      <h1 style="font-size:2.2rem">Simple, Transparent Pricing</h1>
      <p style="color:var(--text-light);margin-top:8px;font-size:1.1rem">Start free, upgrade when you need more. No hidden fees.</p>
      <div class="pricing-grid">
        <div class="card pricing-card">
          <h3>Free</h3>
          <div class="price">$0<span>/mo</span></div>
          <div class="price-note">Free forever</div>
          <ul>
            <li>5 active proposals</li>
            <li>Shareable links</li>
            <li>View tracking</li>
            <li>E-signatures</li>
            <li>PDF export</li>
            <li>ProposalDash branding</li>
          </ul>
          <button class="btn ${currentUser?.plan === 'free' ? 'btn-secondary' : 'btn-outline'}" style="width:100%" onclick="navigate(currentUser ? '/dashboard' : '/register')">
            ${currentUser?.plan === 'free' ? '‚úì Current Plan' : currentUser ? 'Current Plan' : 'Get Started Free'}
          </button>
        </div>
        <div class="card pricing-card popular">
          <div class="pop-badge">Most Popular</div>
          <h3>Pro</h3>
          <div class="price">$19<span>/mo</span></div>
          <div class="price-note">Save $456/yr vs PandaDoc</div>
          <ul>
            <li><strong>Unlimited</strong> proposals</li>
            <li>Custom branding</li>
            <li>Remove ProposalDash branding</li>
            <li>Priority support</li>
            <li>Proposal templates</li>
            <li>Advanced analytics</li>
            <li>Email notifications</li>
          </ul>
          <button class="btn btn-primary" style="width:100%" onclick="upgradeToPro()">
            ${currentUser?.plan === 'pro' ? '‚úì Current Plan' : 'Upgrade to Pro ‚Üí'}
          </button>
        </div>
      </div>
      <p style="color:var(--text-light);margin-top:32px;font-size:0.9rem">üí≥ Secure payment via Stripe. Cancel anytime. 7-day money-back guarantee.</p>
    </div>
  `;
}

async function upgradeToPro() {
  if (!currentUser) return navigate('/register');
  if (currentUser.plan === 'pro') return toast("You're already on Pro!", 'success');
  try {
    const data = await api('/api/stripe/checkout', { method: 'POST' });
    window.location.href = data.url;
  } catch (err) { toast(err.message, 'error'); }
}

// ========================= SETTINGS =========================
function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container page" style="max-width:600px">
      <h1 style="margin-bottom:24px">Settings</h1>
      <div class="card">
        <h3 style="margin-bottom:16px">Profile</h3>
        <form id="settingsForm">
          <div class="editor-section"><label>Name</label><input id="set-name" value="${esc(currentUser.name)}" minlength="2" required></div>
          <div class="editor-section"><label>Company</label><input id="set-company" value="${esc(currentUser.company || '')}" placeholder="Your company name"></div>
          <div class="editor-section">
            <label>Brand Color</label>
            <div style="display:flex;align-items:center;gap:12px">
              <input id="set-color" type="color" value="${currentUser.brand_color || '#2563eb'}" style="width:60px;height:40px;padding:2px;cursor:pointer">
              <span style="color:var(--text-light);font-size:0.85rem">Used in your proposals and client-facing pages</span>
            </div>
          </div>
          <div id="settingsError" class="field-error" style="margin-bottom:12px"></div>
          <button type="submit" class="btn btn-primary" id="settingsBtn">Save Changes</button>
        </form>
      </div>

      <div class="card" style="margin-top:20px">
        <h3 style="margin-bottom:12px">Email Notifications</h3>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:normal">
          <input type="checkbox" id="set-email-notif" ${currentUser.email_notifications ? 'checked' : ''} onchange="toggleEmailNotifications(this.checked)" style="width:auto">
          <span>Notify me when a client views or accepts a proposal</span>
        </label>
        <p style="color:var(--text-light);font-size:0.85rem;margin-top:8px">Email notifications will be sent to ${esc(currentUser.email)}</p>
      </div>

      <div class="card" style="margin-top:20px">
        <h3 style="margin-bottom:12px">Account</h3>
        <p style="color:var(--text-light);margin:4px 0">üìß ${esc(currentUser.email)}</p>
        <p style="color:var(--text-light);margin:4px 0">üìã Plan: <strong>${currentUser.plan === 'pro' ? '‚≠ê Pro' : 'Free'}</strong>
          ${currentUser.plan !== 'pro' ? `‚Äî <a href="/pricing" onclick="event.preventDefault();navigate('/pricing')">Upgrade to Pro</a>` : ''}
        </p>
        <p style="color:var(--text-light);font-size:0.85rem;margin-top:8px">Member since ${new Date(currentUser.created_at).toLocaleDateString()}</p>
      </div>
    </div>
  `;
  document.getElementById('settingsForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('settingsBtn');
    const errEl = document.getElementById('settingsError');
    errEl.textContent = '';
    btn.disabled = true; btn.textContent = 'Saving...';
    try {
      await api('/api/auth/me', { method: 'PUT', body: JSON.stringify({
        name: document.getElementById('set-name').value,
        company: document.getElementById('set-company').value,
        brand_color: document.getElementById('set-color').value
      })});
      const data = await api('/api/auth/me');
      currentUser = data.user;
      renderNav();
      toast('Settings saved!', 'success');
      btn.disabled = false; btn.textContent = 'Save Changes';
    } catch (err) {
      errEl.textContent = err.message;
      btn.disabled = false; btn.textContent = 'Save Changes';
    }
  };
}

async function toggleEmailNotifications(enabled) {
  try {
    await api('/api/auth/me', { method: 'PUT', body: JSON.stringify({ email_notifications: enabled }) });
    currentUser.email_notifications = enabled ? 1 : 0;
    toast(enabled ? 'Email notifications enabled' : 'Email notifications disabled', 'success');
  } catch (err) { toast(err.message, 'error'); }
}

// ========================= BOOT =========================
checkAuth();
</script>
</body>
</html>
