<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ReviewFlow ‚Äî Manage Reviews, Grow Your Reputation</title>
<meta name="description" content="Monitor, respond to, and grow your online reviews across all platforms. AI-powered review management for local businesses.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÑ</text></svg>">
<style>
:root{--primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#eff6ff;--bg:#f8fafc;--card:#fff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}
a{color:var(--primary);text-decoration:none}a:hover{text-decoration:underline}
button,.btn{cursor:pointer;border:none;border-radius:8px;font-size:.95rem;font-weight:600;padding:10px 20px;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:6px}
button:disabled{opacity:.6;cursor:not-allowed}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover:not(:disabled){background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,.3)}
.btn-secondary{background:var(--border);color:var(--text)}.btn-secondary:hover:not(:disabled){background:#cbd5e1}
.btn-danger{background:var(--danger);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}.btn-outline:hover:not(:disabled){background:var(--primary-light)}
.btn-sm{padding:6px 14px;font-size:.85rem}.btn-lg{padding:14px 32px;font-size:1.1rem}.btn-xl{padding:18px 40px;font-size:1.2rem;border-radius:12px}
input,textarea,select{border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:.95rem;width:100%;font-family:inherit;transition:border-color .2s,box-shadow .2s}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
textarea{resize:vertical;min-height:80px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px}
.hidden{display:none!important}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.badge-draft{background:#f1f5f9;color:#64748b}.badge-sent{background:#dbeafe;color:#2563eb}.badge-accepted{background:#d1fae5;color:#059669}.badge-declined{background:#fee2e2;color:#dc2626}.badge-archived{background:#f1f5f9;color:#94a3b8}
.sample-badge{background:#fef3c7;color:#92400e;font-size:.7rem;padding:2px 8px;border-radius:10px;margin-left:8px}
.field-error{color:var(--danger);font-size:.8rem;margin-top:4px}
nav{background:#fff;border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;backdrop-filter:blur(8px);background:rgba(255,255,255,.95)}
nav .logo{font-size:1.3rem;font-weight:800;color:var(--text);display:flex;align-items:center;gap:8px;text-decoration:none}nav .logo span{color:var(--primary)}
nav .nav-links{display:flex;align-items:center;gap:16px}nav .nav-links a{color:var(--text-light);font-weight:500;font-size:.9rem;text-decoration:none}nav .nav-links a:hover{color:var(--primary)}
.container{max-width:1200px;margin:0 auto;padding:32px 24px}.page{min-height:calc(100vh - 64px)}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-state{text-align:center;padding:60px;color:var(--text-light)}
.hero{text-align:center;padding:80px 24px 40px;max-width:820px;margin:0 auto}
.hero h1{font-size:3.2rem;font-weight:800;line-height:1.1;margin-bottom:20px;letter-spacing:-.02em}
.hero h1 span{background:linear-gradient(135deg,var(--primary),#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero p{font-size:1.3rem;color:var(--text-light);margin-bottom:36px;max-width:600px;margin-left:auto;margin-right:auto}
.hero-cta{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:24px}
.hero-social-proof{display:flex;align-items:center;justify-content:center;gap:8px;color:var(--text-light);font-size:.9rem;margin-top:16px}
.hero-avatars{display:flex}.hero-avatars span{width:32px;height:32px;border-radius:50%;border:2px solid #fff;margin-left:-8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.features{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;max-width:1000px;margin:0 auto;padding:40px 24px 60px}
.feature-card{text-align:center;padding:32px 24px;transition:transform .2s,box-shadow .2s}.feature-card:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,.08)}
.feature-card .icon{font-size:2.5rem;margin-bottom:16px}.feature-card h3{margin-bottom:8px;font-size:1.1rem}.feature-card p{color:var(--text-light);font-size:.95rem}
.how-it-works{background:#fff;padding:80px 24px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.how-it-works h2{text-align:center;font-size:2rem;margin-bottom:48px}
.steps{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:32px;max-width:900px;margin:0 auto}
.step{text-align:center}.step-num{width:48px;height:48px;border-radius:50%;background:var(--primary);color:#fff;font-weight:800;font-size:1.2rem;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.step h3{margin-bottom:8px}.step p{color:var(--text-light);font-size:.95rem}
.bottom-cta{text-align:center;padding:80px 24px;background:linear-gradient(135deg,#1e3a8a 0%,#2563eb 50%,#7c3aed 100%);color:#fff}
.bottom-cta h2{font-size:2.2rem;margin-bottom:12px}.bottom-cta p{opacity:.9;margin-bottom:32px;font-size:1.1rem}
.bottom-cta .btn{background:#fff;color:var(--primary)}.bottom-cta .btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.3)}
.footer{text-align:center;padding:32px 24px;color:var(--text-light);font-size:.85rem;border-top:1px solid var(--border)}
.faq{background:#fff;padding:80px 24px;border-top:1px solid var(--border)}.faq h2{text-align:center;font-size:2rem;margin-bottom:40px}
.faq-list{max-width:700px;margin:0 auto}.faq-item{border-bottom:1px solid var(--border)}
.faq-q{padding:20px 0;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center}.faq-q:hover{color:var(--primary)}
.faq-q::after{content:'+';font-size:1.5rem;color:var(--text-light);transition:transform .2s}.faq-item.open .faq-q::after{transform:rotate(45deg)}
.faq-a{padding:0 0 20px;color:var(--text-light);display:none;line-height:1.7}.faq-item.open .faq-a{display:block}
.pricing-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;max-width:800px;margin:40px auto;padding:0 24px}
.pricing-card{text-align:center;padding:40px 32px;position:relative;transition:transform .2s}.pricing-card:hover{transform:translateY(-4px)}
.pricing-card.popular{border-color:var(--primary);border-width:2px;box-shadow:0 4px 24px rgba(37,99,235,.15)}
.pricing-card .pop-badge{position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:4px 16px;border-radius:20px;font-size:.8rem;font-weight:600}
.pricing-card h3{font-size:1.3rem;margin-bottom:8px}.pricing-card .price{font-size:3rem;font-weight:800;margin:16px 0 4px}.pricing-card .price span{font-size:1rem;color:var(--text-light);font-weight:400}
.pricing-card .price-note{font-size:.85rem;color:var(--text-light);margin-bottom:16px}
.pricing-card ul{list-style:none;margin:24px 0;text-align:left}.pricing-card ul li{padding:8px 0;color:var(--text-light)}.pricing-card ul li::before{content:'‚úì';color:var(--success);font-weight:700;margin-right:10px}
.dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.dash-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:32px}
.stat-card{text-align:center;padding:20px}.stat-card .stat-value{font-size:2rem;font-weight:800;color:var(--primary)}.stat-card .stat-label{color:var(--text-light);font-size:.85rem;margin-top:4px}
.proposals-list{display:flex;flex-direction:column;gap:12px}
.proposal-row{display:grid;grid-template-columns:1fr auto auto auto auto;gap:16px;align-items:center;padding:16px 20px;cursor:pointer;transition:box-shadow .2s,transform .15s}
.proposal-row:hover{box-shadow:0 2px 12px rgba(0,0,0,.06);transform:translateY(-1px)}
.proposal-row .title{font-weight:600}.proposal-row .client{color:var(--text-light);font-size:.9rem}.proposal-row .amount{font-weight:700}.proposal-row .views{color:var(--text-light);font-size:.85rem}
.empty-state{text-align:center;padding:80px 24px}.empty-state .empty-icon{font-size:4rem;margin-bottom:16px}.empty-state h2{margin-bottom:8px}.empty-state p{color:var(--text-light);margin-bottom:24px;max-width:400px;margin-left:auto;margin-right:auto}
.editor-grid{display:grid;grid-template-columns:1fr 380px;gap:24px}
.editor-section{margin-bottom:20px}.editor-section label{display:block;font-weight:600;margin-bottom:6px;font-size:.9rem}.editor-section .hint{font-size:.8rem;color:var(--text-light);margin-top:4px}
.line-items-table{width:100%;border-collapse:collapse;margin:12px 0}.line-items-table th{text-align:left;padding:8px;font-size:.8rem;color:var(--text-light);border-bottom:2px solid var(--border)}
.line-items-table td{padding:6px 8px}.line-items-table input{padding:8px 10px}.line-items-table .qty{width:70px}.line-items-table .price{width:100px}.line-items-table .line-total{font-weight:600;min-width:80px;text-align:right}
.totals-section{text-align:right;padding:16px 0}.totals-section .total-row{display:flex;justify-content:flex-end;gap:24px;padding:4px 0;font-size:.95rem}
.totals-section .grand-total{font-size:1.3rem;font-weight:800;color:var(--primary);border-top:2px solid var(--border);padding-top:8px;margin-top:8px}
.preview-panel{position:sticky;top:88px}.preview-panel h3{margin-bottom:12px}
.share-link{display:flex;gap:8px;margin:12px 0}.share-link input{flex:1;background:var(--bg);font-size:.85rem}
.action-buttons{display:flex;flex-direction:column;gap:8px;margin-top:16px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px}
.modal{background:#fff;border-radius:16px;padding:32px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto}
.modal h2{margin-bottom:16px}.modal .close-btn{float:right;background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-light);padding:0}
.public-proposal{max-width:800px;margin:40px auto}
.public-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;flex-wrap:wrap;gap:16px}
.sender-info h2{font-size:1.5rem}.sender-info p{color:var(--text-light)}
.proposal-meta{text-align:right}.proposal-meta h1{font-size:2rem;margin-bottom:8px}
.public-section{margin:24px 0}.public-section h3{margin-bottom:12px;color:var(--text-light);font-size:.9rem;text-transform:uppercase;letter-spacing:1px}
.accept-section{text-align:center;padding:32px;margin-top:32px;background:#f0fdf4;border-radius:var(--radius)}
.signature-pad{border:2px dashed var(--border);border-radius:8px;padding:20px;margin:16px auto;max-width:400px}
.signature-pad input{text-align:center;font-size:1.5rem;font-family:'Brush Script MT','Segoe Script',cursive;border:none;background:transparent}
.signature-pad input:focus{box-shadow:none}
.template-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin:24px 0}
.template-card{padding:24px;cursor:pointer;transition:all .2s;border:2px solid transparent;position:relative}
.template-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.08)}
.template-card .template-icon{font-size:2.5rem;margin-bottom:12px}.template-card h3{margin-bottom:6px;font-size:1.05rem}
.template-card p{color:var(--text-light);font-size:.85rem;line-height:1.5}
.template-card .template-value{margin-top:10px;font-weight:700;color:var(--primary);font-size:.9rem}
.template-card .template-items{margin-top:6px;font-size:.8rem;color:var(--text-light)}
.template-card .template-sections{margin-top:8px;font-size:.8rem;color:var(--text-light)}.template-card .template-sections span{display:inline-block;background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:4px;margin:2px;font-size:.7rem;font-weight:600}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.analytics-card{text-align:center;padding:24px 16px}.analytics-card .analytics-value{font-size:2.2rem;font-weight:800}.analytics-card .analytics-label{color:var(--text-light);font-size:.85rem;margin-top:4px}
.analytics-card.primary .analytics-value{color:var(--primary)}.analytics-card.success .analytics-value{color:var(--success)}.analytics-card.warning .analytics-value{color:var(--warning)}
.pipeline-bar{display:flex;height:32px;border-radius:8px;overflow:hidden;margin:16px 0;background:var(--bg)}
.pipeline-segment{display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:600;color:#fff;min-width:2px;transition:width .5s}
.pipeline-legend{display:flex;gap:20px;flex-wrap:wrap;margin:8px 0 24px}.pipeline-legend-item{display:flex;align-items:center;gap:6px;font-size:.85rem;color:var(--text-light)}
.pipeline-legend-item .dot{width:12px;height:12px;border-radius:3px}
.activity-list{list-style:none}.activity-list li{padding:12px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:.9rem}.activity-list li:last-child{border-bottom:none}
.top-proposals-table{width:100%;border-collapse:collapse}.top-proposals-table th{text-align:left;padding:10px 12px;font-size:.8rem;color:var(--text-light);border-bottom:2px solid var(--border)}
.top-proposals-table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:.9rem}
.status-breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin:16px 0}
.status-item{text-align:center;padding:16px 8px;border-radius:8px}.status-item .count{font-size:1.5rem;font-weight:800}.status-item .label{font-size:.8rem;color:var(--text-light);margin-top:2px}
.toast-container{position:fixed;bottom:24px;right:24px;z-index:1000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--text);color:#fff;padding:12px 24px;border-radius:10px;font-weight:500;animation:slideIn .3s;box-shadow:0 4px 12px rgba(0,0,0,.15);max-width:400px}
.toast-error{background:var(--danger)}.toast-success{background:var(--success)}
@keyframes slideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes slideOut{from{transform:translateY(0);opacity:1}to{transform:translateY(20px);opacity:0}}
@media(max-width:900px){.editor-grid{grid-template-columns:1fr}.preview-panel{position:static}}
@media(max-width:768px){.hero h1{font-size:2.2rem}.hero p{font-size:1.1rem}.proposal-row{grid-template-columns:1fr auto;gap:8px}.proposal-row .views,.proposal-row .date-col{display:none}nav{padding:0 16px}nav .nav-links{gap:10px}nav .nav-links a{font-size:.8rem}.steps{grid-template-columns:1fr}.editor-section .three-col{grid-template-columns:1fr!important}.container{padding:20px 16px}.dash-stats{grid-template-columns:repeat(2,1fr)}.analytics-grid{grid-template-columns:repeat(2,1fr)}div[style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr!important}}
@media(max-width:480px){.hero h1{font-size:1.8rem}.hero-cta{flex-direction:column;align-items:center}.hero-cta .btn{width:100%;max-width:300px}.pricing-grid{grid-template-columns:1fr}nav .nav-links .hide-mobile{display:none}}
@media print{nav,.action-buttons,.accept-section,.toast-container,.no-print{display:none!important}body{background:#fff}.card{border:none;box-shadow:none}.public-proposal{margin:0}}
</style>
</head>
<body>
<nav>
  <a href="/" class="logo" onclick="event.preventDefault();navigate('/')">‚≠ê Review<span>Flow</span></a>
  <div class="nav-links" id="navLinks"></div>
</nav>
<div id="app"><div class="loading-state"><div class="spinner"></div></div></div>
<div class="toast-container" id="toastContainer"></div>

<script>
let currentUser=null,proposals=[],_saving=false;
async function api(url,opts={}){const res=await fetch(url,{headers:{'Content-Type':'application/json',...opts.headers},...opts});const data=await res.json();if(!res.ok)throw new Error(data.error||'Something went wrong');return data}
function toast(msg,type='',duration=3500){const c=document.getElementById('toastContainer'),el=document.createElement('div');el.className='toast'+(type?' toast-'+type:'');el.textContent=msg;c.appendChild(el);setTimeout(()=>{el.style.animation='slideOut .3s forwards';setTimeout(()=>el.remove(),300)},duration)}
function formatMoney(a,c='USD'){return new Intl.NumberFormat('en-US',{style:'currency',currency:c}).format(a||0)}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function truncate(s,l=50){return s&&s.length>l?s.slice(0,l)+'‚Ä¶':s}
function navigate(p){history.pushState(null,'',p);route()}
window.addEventListener('popstate',route);
function route(){const p=location.pathname;if(p.startsWith('/p/'))return renderPublicProposal(p.split('/p/')[1]);if(!currentUser){if(p==='/register')return renderRegister();if(p==='/login')return renderLogin();if(p==='/pricing')return renderPricing();return renderLanding()}if(p==='/dashboard'||p==='/')return renderDashboard();if(p==='/pricing')return renderPricing();if(p==='/settings')return renderSettings();if(p.startsWith('/edit/'))return renderEditor(p.split('/edit/')[1]);if(p==='/new')return renderTemplateSelector();if(p==='/new-from-template')return renderEditor(null);if(p==='/analytics')return renderAnalytics();if(p==='/review-analytics')return renderReviewAnalytics();return renderDashboard()}
function renderNav(){const n=document.getElementById('navLinks');n.innerHTML=currentUser?`<a href="/dashboard" onclick="event.preventDefault();navigate('/dashboard')">Dashboard</a><a href="/analytics" onclick="event.preventDefault();navigate('/analytics')">Proposals</a><a href="/review-analytics" onclick="event.preventDefault();navigate('/review-analytics')">Reviews</a><a href="/pricing" onclick="event.preventDefault();navigate('/pricing')" class="hide-mobile">Pricing</a><a href="/settings" onclick="event.preventDefault();navigate('/settings')">Settings</a><button class="btn btn-secondary btn-sm" onclick="logout()">Log out</button>`:`<a href="/pricing" onclick="event.preventDefault();navigate('/pricing')" class="hide-mobile">Pricing</a><a href="/login" onclick="event.preventDefault();navigate('/login')">Log in</a><button class="btn btn-primary btn-sm" onclick="navigate('/register')">Get Started Free</button>`}
async function checkAuth(){try{const d=await api('/api/auth/me');currentUser=d.user}catch{currentUser=null}renderNav();route()}
async function logout(){await api('/api/auth/logout',{method:'POST'});currentUser=null;renderNav();navigate('/')}

// ========================= TEMPLATE LIBRARY (5 INDUSTRY TEMPLATES) =========================
const PROPOSAL_TEMPLATES = {
  blank: { name: 'Blank Proposal', icon: 'üìÑ', description: 'Start from scratch with a completely blank proposal.', data: { title: '', intro_text: '', terms_text: '', line_items: [{ description: '', quantity: 1, unit_price: 0 }], discount_percent: 0, tax_percent: 0 } },
  consulting: {
    name: 'Consulting Proposal', icon: 'üíº', description: 'Management & strategy consulting engagements. Includes assessment, strategy, and advisory phases.',
    data: {
      title: 'Strategic Consulting Engagement',
      intro_text: 'Thank you for the opportunity to present this consulting proposal. Based on our initial discovery conversation, we have identified key areas where our expertise can drive meaningful impact for your organization.\n\nOur approach is collaborative and results-driven. We combine deep industry knowledge with proven methodologies to deliver actionable recommendations that create lasting value. Our team has successfully completed 200+ engagements across diverse industries.',
      terms_text: '‚Ä¢ Engagement begins upon signed agreement and 50% deposit\n‚Ä¢ Remaining 25% due at Phase 2 start, final 25% upon completion\n‚Ä¢ All deliverables include one round of revisions\n‚Ä¢ Travel expenses (if applicable) billed at cost with prior approval\n‚Ä¢ Confidentiality agreement included\n‚Ä¢ Weekly progress updates via email and bi-weekly calls\n‚Ä¢ Final presentation to executive stakeholders included\n‚Ä¢ This proposal is valid for 30 days from date of issue',
      line_items: [
        { description: 'Current State Assessment & Stakeholder Interviews (Phase 1)', quantity: 1, unit_price: 5000 },
        { description: 'Data Analysis & Competitive Landscape Research', quantity: 1, unit_price: 3500 },
        { description: 'Strategic Recommendations Report (Executive & Board versions)', quantity: 1, unit_price: 6000 },
        { description: 'Implementation Roadmap with 30/60/90-day Milestones', quantity: 1, unit_price: 3000 },
        { description: 'Executive Workshop ‚Äî Half-day Strategy Session', quantity: 1, unit_price: 4000 },
        { description: 'Monthly Advisory & Progress Reviews (3 months)', quantity: 3, unit_price: 2500 }
      ],
      discount_percent: 0, tax_percent: 0
    }
  },
  freelance: {
    name: 'Freelance Project', icon: 'üéØ', description: 'Web design, development, and creative projects. Perfect for independent professionals.',
    data: {
      title: 'Freelance Project Proposal',
      intro_text: 'Thank you for considering me for this project! I\'m excited about the opportunity to bring your vision to life.\n\nBased on our conversation, I understand your goals and have put together a clear scope of work below. I pride myself on transparent communication, meeting deadlines, and delivering work that exceeds expectations. My approach ensures you\'re involved at every key milestone so the final result is exactly what you need.',
      terms_text: '‚Ä¢ 30% deposit to begin work, 40% at design approval, 30% at launch\n‚Ä¢ Includes 3 rounds of design revisions per deliverable\n‚Ä¢ Timeline assumes client feedback within 2 business days\n‚Ä¢ Additional revisions or scope changes billed at $125/hour\n‚Ä¢ All source files and assets delivered upon final payment\n‚Ä¢ 14-day post-launch support for bug fixes included\n‚Ä¢ This proposal is valid for 14 days',
      line_items: [
        { description: 'Discovery & Requirements Gathering', quantity: 1, unit_price: 800 },
        { description: 'Wireframes & Information Architecture', quantity: 1, unit_price: 1200 },
        { description: 'Visual Design (Homepage + Key Pages)', quantity: 5, unit_price: 900 },
        { description: 'Responsive Frontend Development', quantity: 1, unit_price: 4500 },
        { description: 'CMS Integration & Content Setup', quantity: 1, unit_price: 1500 },
        { description: 'Testing, QA & Launch Support', quantity: 1, unit_price: 800 }
      ],
      discount_percent: 0, tax_percent: 0
    }
  },
  agency: {
    name: 'Agency Retainer', icon: 'üè¢', description: 'Marketing, branding & digital agency services. Monthly retainer with comprehensive deliverables.',
    data: {
      title: 'Digital Marketing Agency Retainer Proposal',
      intro_text: 'We\'re thrilled to present our comprehensive marketing strategy for your brand. After analyzing your current digital presence and competitive landscape, we\'ve identified significant opportunities for growth.\n\nOur agency combines creative excellence with data-driven strategy to deliver campaigns that don\'t just look great ‚Äî they perform. With dedicated account management and transparent monthly reporting, you\'ll always know exactly how your investment is performing.',
      terms_text: '‚Ä¢ 6-month initial commitment, month-to-month thereafter\n‚Ä¢ Monthly retainer billed on the 1st of each month, net 15\n‚Ä¢ One-time onboarding fee due upon contract signing\n‚Ä¢ Ad spend budgets billed separately and managed transparently\n‚Ä¢ 30-day cancellation notice required after initial term\n‚Ä¢ All created content and assets become client property\n‚Ä¢ Monthly strategy call and performance report included\n‚Ä¢ Quarterly strategy review and planning session included',
      line_items: [
        { description: 'One-Time: Brand Audit & Strategy Onboarding', quantity: 1, unit_price: 3500 },
        { description: 'Monthly: Social Media Management (4 platforms, 20 posts/mo)', quantity: 1, unit_price: 2800 },
        { description: 'Monthly: Content Marketing (6 blog posts + SEO)', quantity: 6, unit_price: 350 },
        { description: 'Monthly: Paid Ads Management (Google + Meta)', quantity: 1, unit_price: 2000 },
        { description: 'Monthly: Email Marketing (4 campaigns)', quantity: 4, unit_price: 400 },
        { description: 'Monthly: Analytics Reporting & Strategy Optimization', quantity: 1, unit_price: 750 },
        { description: 'Monthly: Dedicated Account Manager', quantity: 1, unit_price: 500 }
      ],
      discount_percent: 0, tax_percent: 0
    }
  },
  saas: {
    name: 'SaaS Implementation', icon: '‚òÅÔ∏è', description: 'Software platform onboarding & enterprise deals. Covers licensing, setup, and support.',
    data: {
      title: 'SaaS Platform Implementation Proposal',
      intro_text: 'We\'re excited to propose our platform solution to transform how your team handles [workflow/process]. After our discovery call, we\'re confident our platform will address your key pain points.\n\nKey benefits for your organization:\n‚Ä¢ Reduce manual processes by up to 70%\n‚Ä¢ Unified dashboard replacing 4+ disconnected tools\n‚Ä¢ Enterprise-grade security (SOC 2 Type II, GDPR compliant)\n‚Ä¢ Full deployment in 6 weeks with dedicated onboarding support\n‚Ä¢ 99.9% uptime SLA with real-time monitoring',
      terms_text: '‚Ä¢ Annual subscription with 10% discount vs monthly billing\n‚Ä¢ Implementation fee is one-time, due upon contract signing\n‚Ä¢ Subscription begins on go-live date\n‚Ä¢ 99.9% uptime SLA with service credits for downtime\n‚Ä¢ 30-day free trial period ‚Äî cancel for full refund if unsatisfied\n‚Ä¢ Dedicated Customer Success Manager for first 12 months\n‚Ä¢ Quarterly business reviews included\n‚Ä¢ Data export available at any time in standard formats',
      line_items: [
        { description: 'Annual Platform License (50 seats)', quantity: 50, unit_price: 240 },
        { description: 'One-Time: Implementation & Configuration', quantity: 1, unit_price: 5000 },
        { description: 'One-Time: Data Migration from Legacy System', quantity: 1, unit_price: 3000 },
        { description: 'One-Time: SSO/SAML Integration Setup', quantity: 1, unit_price: 1500 },
        { description: 'Training Sessions (Admin + End User)', quantity: 4, unit_price: 500 },
        { description: 'Premium Support Add-on (24/7, dedicated TAM) ‚Äî Annual', quantity: 1, unit_price: 6000 }
      ],
      discount_percent: 5, tax_percent: 0
    }
  },
  construction: {
    name: 'Construction Project', icon: 'üèóÔ∏è', description: 'Renovation, building & contractor bids. Detailed scope with materials, labor, and timeline.',
    data: {
      title: 'Construction Project Proposal & Estimate',
      intro_text: 'We are pleased to submit this proposal for the renovation/construction project at your property. Our team conducted a thorough site assessment and has prepared a comprehensive scope of work.\n\nWith over 15 years of experience and full licensing and insurance, we are committed to delivering quality craftsmanship on time and within budget. All work will be performed in compliance with local building codes and permit requirements.\n\nLicense #: [Your License Number]\nInsured: General Liability & Workers\' Compensation',
      terms_text: '‚Ä¢ Payment schedule: 10% deposit, 25% at framing, 25% at rough mechanical, 25% at drywall, 15% at completion\n‚Ä¢ All work performed per local building codes and permit requirements\n‚Ä¢ Permits and inspections included in project cost\n‚Ä¢ Work hours: Mon-Fri 7:00 AM - 5:00 PM (Saturday by arrangement)\n‚Ä¢ Change orders priced at Time & Materials + 15% markup\n‚Ä¢ 2-year workmanship warranty on all labor\n‚Ä¢ 10-year warranty on structural work\n‚Ä¢ Materials carry manufacturer warranties (transferred to client)\n‚Ä¢ Client walkthrough and punch list at project completion\n‚Ä¢ This proposal is valid for 30 days',
      line_items: [
        { description: 'Demolition, Site Prep & Debris Removal', quantity: 1, unit_price: 4500 },
        { description: 'Structural Framing & Carpentry', quantity: 1, unit_price: 18000 },
        { description: 'Electrical (Panel Upgrade + New Circuits)', quantity: 1, unit_price: 8500 },
        { description: 'Plumbing (Fixtures + Rough-In)', quantity: 1, unit_price: 7000 },
        { description: 'HVAC System Installation', quantity: 1, unit_price: 9500 },
        { description: 'Drywall, Insulation & Interior Finishing', quantity: 1, unit_price: 12000 },
        { description: 'Flooring (Hardwood, 800 sq ft)', quantity: 800, unit_price: 12 },
        { description: 'Painting (Interior, 2 coats)', quantity: 1, unit_price: 4500 },
        { description: 'Permits, Inspections & Project Management', quantity: 1, unit_price: 3500 },
        { description: 'Contingency Reserve (10%)', quantity: 1, unit_price: 7700 }
      ],
      discount_percent: 0, tax_percent: 8.25
    }
  }
};

function getTemplateValue(t){return t.data.line_items.reduce((s,li)=>s+li.quantity*li.unit_price,0)}

// ========================= LANDING =========================
function renderLanding(){document.getElementById('app').innerHTML=`
<div class="hero">
  <h1>Manage Reviews, <span>Grow Your Reputation</span></h1>
  <p>Monitor reviews from Google, Yelp, and Facebook in one dashboard. Respond with AI-powered suggestions. Track your reputation growth over time.</p>
  <div class="hero-cta"><button class="btn btn-primary btn-xl" onclick="navigate('/register')">Start Free ‚Äî No Credit Card</button><button class="btn btn-outline btn-lg" onclick="navigate('/pricing')">See Pricing ‚Üí</button></div>
  <div class="hero-social-proof"><div class="hero-avatars"><span style="background:#dbeafe">üë©‚Äçüíº</span><span style="background:#d1fae5">üë®‚Äçüíª</span><span style="background:#fef3c7">üë©‚Äçüé®</span><span style="background:#ede9fe">üë®‚Äçüîß</span></div><span>Trusted by local businesses everywhere</span></div>
</div>
<div class="features">
  <div class="card feature-card"><div class="icon">‚≠ê</div><h3>All Reviews in One Place</h3><p>Google, Yelp, Facebook, and more ‚Äî see every review across all platforms in a single dashboard.</p></div>
  <div class="card feature-card"><div class="icon">ü§ñ</div><h3>AI Response Suggestions</h3><p>Get smart reply suggestions for every review. Respond professionally in seconds, not minutes.</p></div>
  <div class="card feature-card"><div class="icon">üìà</div><h3>Reputation Analytics</h3><p>Track rating trends, review volume, and response rates. See your reputation grow over time.</p></div>
  <div class="card feature-card"><div class="icon">üîî</div><h3>Instant Notifications</h3><p>Get alerted the moment a new review comes in. Never miss a chance to respond quickly.</p></div>
  <div class="card feature-card"><div class="icon">üì±</div><h3>Works Everywhere</h3><p>Beautiful on desktop, tablet, and phone. Manage reviews from any device, anywhere.</p></div>
  <div class="card feature-card"><div class="icon">üí¨</div><h3>Review Request Campaigns</h3><p>Send SMS and email requests to happy customers. Grow your 5-star reviews automatically.</p></div>
</div>
<div class="how-it-works"><h2>How It Works</h2><div class="steps">
  <div class="step"><div class="step-num">1</div><h3>Connect Your Profiles</h3><p>Link your Google, Yelp, and Facebook business profiles in seconds.</p></div>
  <div class="step"><div class="step-num">2</div><h3>Monitor & Respond</h3><p>See all reviews in one dashboard. Use AI suggestions to respond quickly and professionally.</p></div>
  <div class="step"><div class="step-num">3</div><h3>Grow Your Rating</h3><p>Send review requests, track trends, and watch your reputation soar. üéâ</p></div>
</div></div>
<div class="faq"><h2>Frequently Asked Questions</h2><div class="faq-list">
  <div class="faq-item"><div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Is ReviewFlow really free?</div><div class="faq-a">Yes! The free plan lets you monitor reviews from up to 3 locations with full features: AI responses, analytics, and notifications. No credit card required.</div></div>
  <div class="faq-item"><div class="faq-q" onclick="this.parentElement.classList.toggle('open')">What review platforms do you support?</div><div class="faq-a">We support Google Business, Yelp, Facebook, Trustpilot, and more. Connect any platform and see all your reviews in one unified dashboard.</div></div>
  <div class="faq-item"><div class="faq-q" onclick="this.parentElement.classList.toggle('open')">How does the AI response feature work?</div><div class="faq-a">Our AI analyzes each review and generates professional, personalized response suggestions. You can edit and post them with one click.</div></div>
  <div class="faq-item"><div class="faq-q" onclick="this.parentElement.classList.toggle('open')">Can I request reviews from customers?</div><div class="faq-a">Yes! Send review requests via SMS or email. Customize the message and landing page to match your brand.</div></div>
</div></div>
<div class="bottom-cta"><h2>Ready to grow your reputation?</h2><p>Join thousands of local businesses using ReviewFlow to get more 5-star reviews.</p><button class="btn btn-xl" onclick="navigate('/register')">Get Started Free ‚Üí</button></div>
<div class="footer"><p>¬© ${new Date().getFullYear()} ReviewFlow. Built for freelancers, by freelancers.</p></div>`}

// ========================= AUTH =========================
function renderLogin(){document.getElementById('app').innerHTML=`<div class="container" style="max-width:420px;padding-top:60px"><div class="card"><h2 style="margin-bottom:20px;text-align:center">Welcome back</h2><form id="loginForm"><div class="editor-section"><label>Email</label><input type="email" id="loginEmail" required placeholder="you@company.com"></div><div class="editor-section"><label>Password</label><input type="password" id="loginPass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><div id="loginError" class="field-error" style="margin-bottom:12px"></div><button type="submit" class="btn btn-primary" style="width:100%" id="loginBtn">Log in</button></form><p style="text-align:center;margin-top:16px;color:var(--text-light)">No account? <a href="/register" onclick="event.preventDefault();navigate('/register')">Sign up free</a></p></div></div>`;document.getElementById('loginForm').onsubmit=async e=>{e.preventDefault();const b=document.getElementById('loginBtn'),er=document.getElementById('loginError');er.textContent='';b.disabled=true;b.textContent='Logging in...';try{const d=await api('/api/auth/login',{method:'POST',body:JSON.stringify({email:document.getElementById('loginEmail').value,password:document.getElementById('loginPass').value})});currentUser=d.user;renderNav();navigate('/dashboard');toast('Welcome back!','success')}catch(err){er.textContent=err.message;b.disabled=false;b.textContent='Log in'}}}
function renderRegister(){document.getElementById('app').innerHTML=`<div class="container" style="max-width:420px;padding-top:60px"><div class="card"><h2 style="margin-bottom:4px;text-align:center">Create your account</h2><p style="text-align:center;color:var(--text-light);margin-bottom:24px">Free forever. No credit card required.</p><form id="regForm"><div class="editor-section"><label>Full Name *</label><input id="regName" required placeholder="Jane Smith" minlength="2"></div><div class="editor-section"><label>Company <span style="font-weight:400;color:var(--text-light)">(optional)</span></label><input id="regCompany" placeholder="Acme Agency"></div><div class="editor-section"><label>Email *</label><input type="email" id="regEmail" required placeholder="jane@acme.com"></div><div class="editor-section"><label>Password *</label><input type="password" id="regPass" required minlength="6" placeholder="At least 6 characters"><div class="hint">Minimum 6 characters</div></div><div id="regError" class="field-error" style="margin-bottom:12px"></div><button type="submit" class="btn btn-primary" style="width:100%" id="regBtn">Create Account</button></form><p style="text-align:center;margin-top:16px;color:var(--text-light)">Already have an account? <a href="/login" onclick="event.preventDefault();navigate('/login')">Log in</a></p></div></div>`;document.getElementById('regForm').onsubmit=async e=>{e.preventDefault();const b=document.getElementById('regBtn'),er=document.getElementById('regError');er.textContent='';b.disabled=true;b.textContent='Creating account...';try{const d=await api('/api/auth/register',{method:'POST',body:JSON.stringify({name:document.getElementById('regName').value,company:document.getElementById('regCompany').value,email:document.getElementById('regEmail').value,password:document.getElementById('regPass').value})});currentUser=d.user;renderNav();navigate('/dashboard');toast('Welcome to ReviewFlow! Sample proposals created to get you started.','success',5000)}catch(err){er.textContent=err.message;b.disabled=false;b.textContent='Create Account'}}}

// ========================= DASHBOARD =========================
async function renderDashboard(){document.getElementById('app').innerHTML='<div class="loading-state"><div class="spinner"></div></div>';try{const d=await api('/api/proposals');proposals=d.proposals}catch(err){proposals=[];toast(err.message,'error')}
const rp=proposals.filter(p=>!p.is_sample),tv=proposals.reduce((s,p)=>s+(p.subtotal||0),0),ac=proposals.filter(p=>p.status==='accepted'),views=proposals.reduce((s,p)=>s+(p.view_count||0),0);
document.getElementById('app').innerHTML=`<div class="container page"><div class="dash-header"><div><h1>Dashboard</h1><p style="color:var(--text-light)">${currentUser.plan==='pro'?'‚≠ê Pro Plan':`Free Plan (${rp.filter(p=>p.status!=='archived').length}/5 proposals) ¬∑ <a href="/pricing" onclick="event.preventDefault();navigate('/pricing')">Upgrade</a>`}</p></div><div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="navigate('/new')">+ New Proposal</button></div></div>
<div class="dash-stats"><div class="card stat-card"><div class="stat-value">${proposals.length}</div><div class="stat-label">Total Proposals</div></div><div class="card stat-card"><div class="stat-value">${formatMoney(tv)}</div><div class="stat-label">Total Value</div></div><div class="card stat-card"><div class="stat-value">${ac.length}</div><div class="stat-label">Accepted</div></div><div class="card stat-card"><div class="stat-value">${views}</div><div class="stat-label">Total Views</div></div></div>
${proposals.length===0?`<div class="card empty-state"><div class="empty-icon">üìÑ</div><h2>Create your first proposal</h2><p>Choose from 5 professional templates to get started in minutes.</p><button class="btn btn-primary btn-lg" onclick="navigate('/new')">+ New Proposal</button></div>`:`<div class="proposals-list">${proposals.map(p=>`<div class="card proposal-row" onclick="navigate('/edit/${p.id}')"><div><div class="title">${esc(truncate(p.title,60))}${p.is_sample?'<span class="sample-badge">Sample</span>':''}</div><div class="client">${esc(p.client_name||p.client_company||'No client specified')}</div></div><span class="badge badge-${p.status}">${p.status}</span><span class="amount">${formatMoney(p.subtotal||0)}</span><span class="views">üëÅ ${p.view_count||0}</span><span class="date-col" style="color:var(--text-light);font-size:.8rem">${new Date(p.created_at).toLocaleDateString()}</span></div>`).join('')}</div>`}</div>`}

// ========================= TEMPLATE SELECTOR =========================
function renderTemplateSelector(){document.getElementById('app').innerHTML=`<div class="container page"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:12px"><div><h1>Choose a Template</h1><p style="color:var(--text-light);margin-top:4px">Pick an industry template with pre-filled sections, or start blank.</p></div><button class="btn btn-secondary btn-sm" onclick="navigate('/dashboard')">‚Üê Back</button></div>
<div class="template-grid">${Object.entries(PROPOSAL_TEMPLATES).map(([k,t])=>`<div class="card template-card" onclick="useTemplate('${k}')"><div class="template-icon">${t.icon}</div><h3>${t.name}</h3><p>${t.description}</p>${k!=='blank'?`<div class="template-value">Starting at ${formatMoney(getTemplateValue(t))}</div><div class="template-items">${t.data.line_items.length} line items ¬∑ Pre-filled intro & terms</div>`:'<div class="template-value" style="color:var(--text-light)">Empty canvas</div>'}</div>`).join('')}</div></div>`}

function useTemplate(k){const t=PROPOSAL_TEMPLATES[k];if(!t)return;window._pendingTemplate=JSON.parse(JSON.stringify(t.data));navigate('/new-from-template')}

// ========================= EDITOR =========================
async function renderEditor(id){document.getElementById('app').innerHTML='<div class="loading-state"><div class="spinner"></div></div>';let proposal=null;if(id){try{const d=await api(`/api/proposals/${id}`);proposal=d.proposal}catch{toast('Proposal not found','error');return navigate('/dashboard')}}
const td=window._pendingTemplate||null;window._pendingTemplate=null;const p=proposal||{title:td?.title||'',client_name:'',client_email:'',client_company:'',intro_text:td?.intro_text||'',terms_text:td?.terms_text||'',currency:'USD',discount_percent:td?.discount_percent||0,tax_percent:td?.tax_percent||0,valid_until:'',status:'draft',line_items:td?.line_items||[],share_token:'',is_sample:0};
if(!p.line_items.length)p.line_items=[{description:'',quantity:1,unit_price:0}];const isNew=!id,base=location.origin;
document.getElementById('app').innerHTML=`<div class="container page"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px"><div><h1>${isNew?'New Proposal':'Edit Proposal'}${p.is_sample?' <span class="sample-badge" style="font-size:.7rem">Sample</span>':''}</h1>${!isNew?`<p style="color:var(--text-light);font-size:.85rem">Last updated ${new Date(p.updated_at||p.created_at).toLocaleString()}</p>`:''}</div><button class="btn btn-secondary btn-sm" onclick="navigate('/dashboard')">‚Üê Back</button></div>
<div class="editor-grid"><div><div class="card" style="margin-bottom:20px"><div class="editor-section"><label>Proposal Title *</label><input id="ed-title" value="${esc(p.title)}" placeholder="e.g. Website Redesign for Acme Corp" maxlength="200"></div>
<div class="three-col" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px"><div class="editor-section"><label>Client Name</label><input id="ed-cname" value="${esc(p.client_name)}" placeholder="Jane Smith"></div><div class="editor-section"><label>Client Email</label><input id="ed-cemail" type="email" value="${esc(p.client_email)}" placeholder="jane@example.com"></div><div class="editor-section"><label>Client Company</label><input id="ed-ccompany" value="${esc(p.client_company)}" placeholder="Acme Corp"></div></div>
<div class="editor-section"><label>Introduction / Scope</label><textarea id="ed-intro" placeholder="Describe the project scope..." maxlength="5000" rows="5">${esc(p.intro_text)}</textarea></div></div>
<div class="card" style="margin-bottom:20px"><h3 style="margin-bottom:12px">Line Items</h3><div style="overflow-x:auto"><table class="line-items-table"><thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr></thead><tbody id="lineItems"></tbody></table></div><button class="btn btn-secondary btn-sm" onclick="addLineItem()">+ Add Item</button><div class="totals-section" id="totals"></div></div>
<div class="card"><div class="three-col" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px"><div class="editor-section"><label>Discount %</label><input id="ed-discount" type="number" min="0" max="100" step="0.1" value="${p.discount_percent}" onchange="updateTotals()"></div><div class="editor-section"><label>Tax %</label><input id="ed-tax" type="number" min="0" max="100" step="0.1" value="${p.tax_percent}" onchange="updateTotals()"></div><div class="editor-section"><label>Valid Until</label><input id="ed-valid" type="date" value="${p.valid_until||''}"></div></div>
<div class="editor-section"><label>Terms & Conditions</label><textarea id="ed-terms" placeholder="Payment terms, delivery timeline..." maxlength="5000" rows="5">${esc(p.terms_text)}</textarea></div></div></div>
<div class="preview-panel"><div class="card"><h3>Actions</h3>${!isNew?`<div style="margin:12px 0"><label style="font-size:.85rem;color:var(--text-light)">Status</label><span class="badge badge-${p.status}" style="margin-left:8px">${p.status}</span>${p.view_count?`<span style="margin-left:8px;color:var(--text-light);font-size:.85rem">üëÅ ${p.view_count} view${p.view_count!==1?'s':''}</span>`:''}</div><div class="share-link"><input readonly value="${base}/p/${p.share_token}" id="shareUrl"><button class="btn btn-secondary btn-sm" onclick="copyShareLink()">üìã</button></div>`:''}<div class="action-buttons"><button class="btn btn-primary" onclick="saveProposal('${id||''}')" id="saveBtn">üíæ Save${isNew?' as Draft':''}</button>${!isNew&&p.status==='draft'?`<button class="btn btn-success" onclick="sendProposal('${id}')">üì§ Mark as Sent</button>`:''} ${!isNew?`<button class="btn btn-secondary" onclick="window.open('/p/${p.share_token}','_blank')">üëÅ Preview</button><button class="btn btn-secondary" onclick="downloadPDF('${id}')">üì• Export PDF</button><button class="btn btn-secondary" onclick="duplicateProposal('${id}')">üìã Duplicate</button>`:''} ${!isNew&&p.status!=='archived'?`<button class="btn btn-secondary btn-sm" onclick="archiveProposal('${id}')" style="margin-top:4px">üì¶ Archive</button>`:''} ${!isNew?`<button class="btn btn-danger btn-sm" onclick="deleteProposal('${id}')" style="margin-top:4px">üóë Delete</button>`:''}</div></div>
${!isNew&&p.accepted_at?`<div class="card" style="margin-top:16px;background:#f0fdf4;border-color:#bbf7d0"><h3 style="color:var(--success)">‚úÖ Accepted</h3><p style="font-size:.95rem;margin-top:8px">Signed by: <strong style="font-family:'Brush Script MT','Segoe Script',cursive;font-size:1.2rem">${esc(p.accepted_signature)}</strong></p><p style="font-size:.85rem;color:var(--text-light);margin-top:4px">${new Date(p.accepted_at).toLocaleString()}</p></div>`:''}</div></div></div>`;
window._lineItems=p.line_items.map(li=>({...li}));renderLineItems()}

function renderLineItems(){document.getElementById('lineItems').innerHTML=window._lineItems.map((it,i)=>`<tr><td><input value="${esc(it.description)}" onchange="window._lineItems[${i}].description=this.value;updateTotals()" placeholder="Service or product..."></td><td><input class="qty" type="number" min="0" step="0.5" value="${it.quantity}" onchange="window._lineItems[${i}].quantity=Math.max(0,parseFloat(this.value)||0);updateTotals()"></td><td><input class="price" type="number" min="0" step="0.01" value="${it.unit_price}" onchange="window._lineItems[${i}].unit_price=Math.max(0,parseFloat(this.value)||0);updateTotals()"></td><td class="line-total">${formatMoney(it.quantity*it.unit_price)}</td><td><button class="btn btn-secondary btn-sm" onclick="removeLineItem(${i})" style="padding:4px 8px" ${window._lineItems.length<=1?'disabled':''}>‚úï</button></td></tr>`).join('');updateTotals()}
function addLineItem(){if(window._lineItems.length>=50)return toast('Max 50 items','error');window._lineItems.push({description:'',quantity:1,unit_price:0});renderLineItems();document.querySelectorAll('#lineItems tr:last-child input')[0]?.focus()}
function removeLineItem(i){if(window._lineItems.length<=1)return;window._lineItems.splice(i,1);renderLineItems()}
function updateTotals(){const sub=window._lineItems.reduce((s,li)=>s+(li.quantity||0)*(li.unit_price||0),0),disc=Math.max(0,Math.min(100,parseFloat(document.getElementById('ed-discount')?.value||0))),tax=Math.max(0,Math.min(100,parseFloat(document.getElementById('ed-tax')?.value||0))),da=sub*(disc/100),ad=sub-da,ta=ad*(tax/100),tot=ad+ta;document.getElementById('totals').innerHTML=`<div class="total-row"><span>Subtotal:</span><span>${formatMoney(sub)}</span></div>${disc>0?`<div class="total-row"><span>Discount (${disc}%):</span><span style="color:var(--danger)">-${formatMoney(da)}</span></div>`:''}${tax>0?`<div class="total-row"><span>Tax (${tax}%):</span><span>+${formatMoney(ta)}</span></div>`:''}<div class="total-row grand-total"><span>Total:</span><span>${formatMoney(tot)}</span></div>`}
function copyShareLink(){const u=document.getElementById('shareUrl').value;navigator.clipboard.writeText(u).then(()=>toast('Link copied!','success')).catch(()=>{document.getElementById('shareUrl').select();document.execCommand('copy');toast('Link copied!','success')})}

async function saveProposal(id){if(_saving)return;const title=document.getElementById('ed-title').value.trim();if(!title){toast('Please enter a proposal title','error');return}if(!window._lineItems.some(li=>li.description?.trim())){toast('Add at least one line item','error');return}_saving=true;const btn=document.getElementById('saveBtn'),orig=btn.textContent;btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Saving...';const body={title,client_name:document.getElementById('ed-cname').value,client_email:document.getElementById('ed-cemail').value,client_company:document.getElementById('ed-ccompany').value,intro_text:document.getElementById('ed-intro').value,terms_text:document.getElementById('ed-terms').value,discount_percent:parseFloat(document.getElementById('ed-discount').value)||0,tax_percent:parseFloat(document.getElementById('ed-tax').value)||0,valid_until:document.getElementById('ed-valid').value||null,line_items:window._lineItems};try{if(id){await api(`/api/proposals/${id}`,{method:'PUT',body:JSON.stringify(body)});toast('Saved!','success');renderEditor(id)}else{const d=await api('/api/proposals',{method:'POST',body:JSON.stringify(body)});toast('Proposal created!','success');navigate('/edit/'+d.proposal.id)}}catch(err){toast(err.message,'error');btn.disabled=false;btn.textContent=orig}_saving=false}
async function sendProposal(id){if(!confirm('Mark as sent?'))return;try{await api(`/api/proposals/${id}`,{method:'PUT',body:JSON.stringify({status:'sent'})});toast('Marked as sent!','success');renderEditor(id)}catch(err){toast(err.message,'error')}}
async function archiveProposal(id){try{await api(`/api/proposals/${id}`,{method:'PUT',body:JSON.stringify({status:'archived'})});toast('Archived','success');renderEditor(id)}catch(err){toast(err.message,'error')}}
async function duplicateProposal(id){try{const d=await api(`/api/proposals/${id}/duplicate`,{method:'POST'});toast('Duplicated!','success');navigate('/edit/'+d.proposal.id)}catch(err){toast(err.message,'error')}}
async function deleteProposal(id){if(!confirm('Delete this proposal? Cannot be undone.'))return;try{await api(`/api/proposals/${id}`,{method:'DELETE'});toast('Deleted','success');navigate('/dashboard')}catch(err){toast(err.message,'error')}}

// ========================= PDF =========================
async function downloadPDF(id){toast('Generating PDF...');try{const d=await api(`/api/proposals/${id}/pdf-data`);generatePDFHTML(d.proposal,d.sender)}catch(err){toast('Failed: '+err.message,'error')}}
function generatePDFHTML(p,s){const sub=p.line_items.reduce((sum,li)=>sum+li.quantity*li.unit_price,0),da=sub*((p.discount_percent||0)/100),ad=sub-da,ta=ad*((p.tax_percent||0)/100),tot=ad+ta;const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(p.title)}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;color:#1e293b;line-height:1.6;padding:40px;max-width:800px;margin:0 auto}.header{display:flex;justify-content:space-between;margin-bottom:40px;border-bottom:3px solid ${s.brand_color||'#2563eb'};padding-bottom:24px}.sender h2{color:${s.brand_color||'#2563eb'};font-size:1.4rem}.sender p{color:#64748b;font-size:.9rem}.meta{text-align:right}.meta h1{font-size:1.8rem;margin-bottom:4px}.meta p{color:#64748b;font-size:.9rem}.section{margin:24px 0}.section h3{color:#64748b;font-size:.85rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}table{width:100%;border-collapse:collapse}th{text-align:left;padding:10px 12px;font-size:.8rem;color:#64748b;border-bottom:2px solid #e2e8f0}td{padding:10px 12px;border-bottom:1px solid #f1f5f9}.text-right{text-align:right}.fw-bold{font-weight:600}.totals{text-align:right;margin-top:16px}.totals .row{display:flex;justify-content:flex-end;gap:32px;padding:4px 0}.totals .grand{font-size:1.3rem;font-weight:800;color:${s.brand_color||'#2563eb'};border-top:2px solid #e2e8f0;padding-top:8px;margin-top:8px}.terms{white-space:pre-wrap;color:#475569}.footer{text-align:center;margin-top:48px;padding-top:16px;border-top:1px solid #e2e8f0;color:#94a3b8;font-size:.8rem}@media print{body{padding:20px}.no-print{display:none}}</style></head><body><div class="no-print" style="text-align:center;margin-bottom:24px;padding:12px;background:#eff6ff;border-radius:8px"><button onclick="window.print()" style="background:${s.brand_color||'#2563eb'};color:#fff;border:none;padding:10px 24px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer">‚¨á Print / Save as PDF</button></div><div class="header"><div class="sender"><h2>${esc(s.company||s.name)}</h2><p>${esc(s.name)}</p><p>${esc(s.email)}</p></div><div class="meta"><h1>${esc(p.title)}</h1><p>For <strong>${esc(p.client_name||p.client_company||'Client')}</strong></p>${p.valid_until?`<p>Valid until ${new Date(p.valid_until).toLocaleDateString()}</p>`:''}</div></div>${p.intro_text?`<div class="section"><h3>Overview</h3><p style="white-space:pre-wrap;color:#475569">${esc(p.intro_text)}</p></div>`:''}<div class="section"><h3>Pricing</h3><table><thead><tr><th>Description</th><th style="width:70px">Qty</th><th style="width:100px">Rate</th><th style="width:100px" class="text-right">Amount</th></tr></thead><tbody>${p.line_items.map(li=>`<tr><td>${esc(li.description)}</td><td>${li.quantity}</td><td>${formatMoney(li.unit_price,p.currency)}</td><td class="text-right fw-bold">${formatMoney(li.quantity*li.unit_price,p.currency)}</td></tr>`).join('')}</tbody></table><div class="totals"><div class="row"><span>Subtotal:</span><span>${formatMoney(sub,p.currency)}</span></div>${p.discount_percent>0?`<div class="row"><span>Discount (${p.discount_percent}%):</span><span>-${formatMoney(da,p.currency)}</span></div>`:''}${p.tax_percent>0?`<div class="row"><span>Tax (${p.tax_percent}%):</span><span>+${formatMoney(ta,p.currency)}</span></div>`:''}<div class="row grand"><span>Total:</span><span>${formatMoney(tot,p.currency)}</span></div></div></div>${p.terms_text?`<div class="section"><h3>Terms & Conditions</h3><p class="terms">${esc(p.terms_text)}</p></div>`:''}${p.accepted_at?`<div style="text-align:center;padding:24px;background:#f0fdf4;border-radius:12px;margin-top:32px"><h3 style="color:#059669">‚úÖ Accepted</h3><div style="font-family:'Brush Script MT',cursive;font-size:1.5rem;margin:8px 0">${esc(p.accepted_signature)}</div><p style="color:#64748b;font-size:.85rem">${new Date(p.accepted_at).toLocaleString()}</p></div>`:''}<div class="footer">Generated by ReviewFlow ¬∑ ${new Date().toLocaleDateString()}</div></body></html>`;const w=window.open('','_blank');w.document.write(html);w.document.close()}

// ========================= PUBLIC PROPOSAL =========================
async function renderPublicProposal(token){document.getElementById('app').innerHTML='<div class="loading-state"><div class="spinner"></div></div>';try{const d=await api(`/api/proposals/public/${token}`),p=d.proposal,s=d.sender;const sub=p.line_items.reduce((sum,li)=>sum+li.quantity*li.unit_price,0),da=sub*((p.discount_percent||0)/100),ad=sub-da,ta=ad*((p.tax_percent||0)/100),tot=ad+ta;
document.getElementById('app').innerHTML=`<div class="container public-proposal"><div class="card" style="padding:40px"><div class="public-header"><div class="sender-info"><h2 style="color:${s.brand_color||'var(--primary)'}">${esc(s.company||s.name)}</h2><p>${esc(s.name)}${s.company?' ¬∑ '+esc(s.company):''}</p><p style="font-size:.9rem">${esc(s.email)}</p></div><div class="proposal-meta"><h1>${esc(p.title)}</h1><p style="color:var(--text-light)">Prepared for <strong>${esc(p.client_name||p.client_company||'You')}</strong></p>${p.valid_until?`<p style="color:var(--text-light);font-size:.85rem">Valid until ${new Date(p.valid_until).toLocaleDateString()}</p>`:''}<span class="badge badge-${p.status}" style="margin-top:8px">${p.status}</span></div></div>
${p.intro_text?`<div class="public-section"><h3>Overview</h3><p style="white-space:pre-wrap">${esc(p.intro_text)}</p></div>`:''}
<div class="public-section"><h3>Pricing</h3><div style="overflow-x:auto"><table class="line-items-table" style="margin-bottom:16px"><thead><tr><th>Description</th><th style="width:70px">Qty</th><th style="width:100px">Rate</th><th style="width:100px;text-align:right">Amount</th></tr></thead><tbody>${p.line_items.map(li=>`<tr><td>${esc(li.description)}</td><td>${li.quantity}</td><td>${formatMoney(li.unit_price,p.currency)}</td><td style="text-align:right;font-weight:600">${formatMoney(li.quantity*li.unit_price,p.currency)}</td></tr>`).join('')}</tbody></table></div><div class="totals-section"><div class="total-row"><span>Subtotal:</span><span>${formatMoney(sub,p.currency)}</span></div>${p.discount_percent>0?`<div class="total-row"><span>Discount (${p.discount_percent}%):</span><span style="color:var(--danger)">-${formatMoney(da,p.currency)}</span></div>`:''}${p.tax_percent>0?`<div class="total-row"><span>Tax (${p.tax_percent}%):</span><span>+${formatMoney(ta,p.currency)}</span></div>`:''}<div class="total-row grand-total"><span>Total:</span><span>${formatMoney(tot,p.currency)}</span></div></div></div>
${p.terms_text?`<div class="public-section"><h3>Terms & Conditions</h3><p style="white-space:pre-wrap">${esc(p.terms_text)}</p></div>`:''}
${p.status==='sent'?`<div class="accept-section"><h2 style="margin-bottom:8px">Accept This Proposal</h2><p style="color:var(--text-light)">Type your name below to accept the terms and sign this proposal.</p><div class="signature-pad"><input id="sig-input" placeholder="Type your full name" style="font-size:1.8rem;font-style:italic"></div><div id="acceptError" class="field-error" style="margin-bottom:12px"></div><button class="btn btn-success btn-lg" onclick="acceptProposal('${token}')" id="acceptBtn">‚úçÔ∏è Accept & Sign</button></div>`:''}
${p.status==='accepted'?`<div class="accept-section"><h2>‚úÖ Proposal Accepted</h2><p style="font-family:'Brush Script MT','Segoe Script',cursive;font-size:1.8rem;margin:12px 0">${esc(p.accepted_signature)}</p><p style="color:var(--text-light);font-size:.85rem">${new Date(p.accepted_at).toLocaleString()}</p></div>`:''}
${p.status==='draft'?`<div style="text-align:center;padding:24px;background:#fef3c7;border-radius:var(--radius);margin-top:24px"><p style="color:#92400e;font-weight:600">‚ö†Ô∏è This proposal is still a draft.</p></div>`:''}</div>
<p style="text-align:center;margin:24px 0;color:var(--text-light);font-size:.85rem">Powered by <a href="/">ReviewFlow</a></p></div>`}catch(err){document.getElementById('app').innerHTML=`<div class="container" style="text-align:center;padding-top:80px"><div style="font-size:4rem;margin-bottom:16px">üîç</div><h1>Proposal Not Found</h1><p style="color:var(--text-light);margin:12px 0 24px">This proposal may have been removed or the link is incorrect.</p><a href="/" class="btn btn-primary">Go to ReviewFlow</a></div>`}}

async function acceptProposal(token){const sig=document.getElementById('sig-input').value.trim(),er=document.getElementById('acceptError');er.textContent='';if(!sig||sig.length<2){er.textContent='Please enter your full name';return}const btn=document.getElementById('acceptBtn');btn.disabled=true;btn.textContent='Accepting...';try{await api(`/api/proposals/public/${token}/accept`,{method:'POST',body:JSON.stringify({signature:sig})});toast('üéâ Proposal accepted!','success',5000);renderPublicProposal(token)}catch(err){er.textContent=err.message;btn.disabled=false;btn.textContent='‚úçÔ∏è Accept & Sign'}}

// ========================= PRICING =========================
function renderPricing(){document.getElementById('app').innerHTML=`<div class="container page" style="text-align:center;padding-top:60px"><h1 style="font-size:2.2rem">Simple, Transparent Pricing</h1><p style="color:var(--text-light);margin-top:8px;font-size:1.1rem">Start free. Upgrade when you need more.</p><div class="pricing-grid"><div class="card pricing-card"><h3>Free</h3><div class="price">$0<span>/mo</span></div><div class="price-note">Free forever</div><ul><li>5 active proposals</li><li>All 5 industry templates</li><li>View tracking & e-signatures</li><li>PDF export</li></ul><button class="btn ${currentUser?.plan==='free'?'btn-secondary':'btn-outline'}" style="width:100%" onclick="navigate(currentUser?'/dashboard':'/register')">${currentUser?.plan==='free'?'‚úì Current Plan':'Get Started Free'}</button></div><div class="card pricing-card popular"><div class="pop-badge">Most Popular</div><h3>Pro</h3><div class="price">$19<span>/mo</span></div><div class="price-note">Unlimited proposals</div><ul><li><strong>Unlimited</strong> proposals</li><li>All 5 templates</li><li>Custom branding</li><li>Advanced analytics</li><li>Priority support</li></ul><button class="btn btn-primary" style="width:100%" onclick="currentUser?toast('Coming soon!'):navigate('/register')">${currentUser?.plan==='pro'?'‚úì Current Plan':'Upgrade to Pro ‚Üí'}</button></div></div></div>`}

// ========================= SETTINGS =========================
function renderSettings(){document.getElementById('app').innerHTML=`<div class="container page" style="max-width:600px"><h1 style="margin-bottom:24px">Settings</h1><div class="card"><h3 style="margin-bottom:16px">Profile</h3><form id="settingsForm"><div class="editor-section"><label>Name</label><input id="set-name" value="${esc(currentUser.name)}" required></div><div class="editor-section"><label>Company</label><input id="set-company" value="${esc(currentUser.company||'')}" placeholder="Your company name"></div><div class="editor-section"><label>Brand Color</label><div style="display:flex;align-items:center;gap:12px"><input id="set-color" type="color" value="${currentUser.brand_color||'#2563eb'}" style="width:60px;height:40px;padding:2px;cursor:pointer"><span style="color:var(--text-light);font-size:.85rem">Used in proposals and client pages</span></div></div><button type="submit" class="btn btn-primary" id="settingsBtn">Save Changes</button></form></div><div class="card" style="margin-top:20px"><h3 style="margin-bottom:12px">Account</h3><p style="color:var(--text-light);margin:4px 0">üìß ${esc(currentUser.email)}</p><p style="color:var(--text-light);margin:4px 0">üìã Plan: <strong>${currentUser.plan==='pro'?'‚≠ê Pro':'Free'}</strong></p></div></div>`;document.getElementById('settingsForm').onsubmit=async e=>{e.preventDefault();const btn=document.getElementById('settingsBtn');btn.disabled=true;btn.textContent='Saving...';try{await api('/api/auth/me',{method:'PUT',body:JSON.stringify({name:document.getElementById('set-name').value,company:document.getElementById('set-company').value,brand_color:document.getElementById('set-color').value})});const d=await api('/api/auth/me');currentUser=d.user;renderNav();toast('Settings saved!','success');btn.disabled=false;btn.textContent='Save Changes'}catch(err){toast(err.message,'error');btn.disabled=false;btn.textContent='Save Changes'}}}

// ========================= ANALYTICS =========================
async function renderAnalytics(){document.getElementById('app').innerHTML='<div class="loading-state"><div class="spinner"></div></div>';try{const d=await api('/api/proposals/stats/analytics'),{counts,views:v,pipeline,winRate,recentViews,topByViews}=d,pt=pipeline.total||1;
document.getElementById('app').innerHTML=`<div class="container page"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px"><div><h1>üìä Analytics</h1><p style="color:var(--text-light)">Track your proposal performance</p></div><button class="btn btn-secondary btn-sm" onclick="navigate('/dashboard')">‚Üê Back</button></div>
<div class="analytics-grid"><div class="card analytics-card primary"><div class="analytics-value">${counts.total}</div><div class="analytics-label">Total Proposals</div></div><div class="card analytics-card" style="--c:#3b82f6"><div class="analytics-value" style="color:#3b82f6">${counts.sent}</div><div class="analytics-label">Sent</div></div><div class="card analytics-card success"><div class="analytics-value">${counts.accepted}</div><div class="analytics-label">Accepted</div></div><div class="card analytics-card warning"><div class="analytics-value">${v.total}</div><div class="analytics-label">Total Views</div></div><div class="card analytics-card primary"><div class="analytics-value">${winRate}%</div><div class="analytics-label">Win Rate</div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px"><div class="card" style="grid-column:1/-1"><h3 style="margin-bottom:16px">üí∞ Value Pipeline</h3><div class="analytics-grid" style="margin-bottom:16px"><div style="text-align:center"><div style="font-size:1.8rem;font-weight:800;color:var(--primary)">${formatMoney(pipeline.total)}</div><div style="color:var(--text-light);font-size:.85rem">Total</div></div><div style="text-align:center"><div style="font-size:1.8rem;font-weight:800;color:#64748b">${formatMoney(pipeline.draft)}</div><div style="color:var(--text-light);font-size:.85rem">Drafts</div></div><div style="text-align:center"><div style="font-size:1.8rem;font-weight:800;color:#3b82f6">${formatMoney(pipeline.sent)}</div><div style="color:var(--text-light);font-size:.85rem">Pending</div></div><div style="text-align:center"><div style="font-size:1.8rem;font-weight:800;color:var(--success)">${formatMoney(pipeline.accepted)}</div><div style="color:var(--text-light);font-size:.85rem">Won</div></div></div><div class="pipeline-bar">${pipeline.draft>0?`<div class="pipeline-segment" style="width:${pipeline.draft/pt*100}%;background:#94a3b8">${pipeline.draft/pt>.08?'Draft':''}</div>`:''}${pipeline.sent>0?`<div class="pipeline-segment" style="width:${pipeline.sent/pt*100}%;background:#3b82f6">${pipeline.sent/pt>.08?'Sent':''}</div>`:''}${pipeline.accepted>0?`<div class="pipeline-segment" style="width:${pipeline.accepted/pt*100}%;background:#10b981">${pipeline.accepted/pt>.08?'Won':''}</div>`:''}</div></div>
<div class="card"><h3 style="margin-bottom:16px">üìà Status Breakdown</h3><div class="status-breakdown"><div class="status-item" style="background:#f1f5f9"><div class="count" style="color:#64748b">${counts.draft}</div><div class="label">Draft</div></div><div class="status-item" style="background:#dbeafe"><div class="count" style="color:#2563eb">${counts.sent}</div><div class="label">Sent</div></div><div class="status-item" style="background:#d1fae5"><div class="count" style="color:#059669">${counts.accepted}</div><div class="label">Accepted</div></div></div></div>
<div class="card"><h3 style="margin-bottom:16px">üèÜ Top by Views</h3>${topByViews.length>0?`<div style="overflow-x:auto"><table class="top-proposals-table"><thead><tr><th>Proposal</th><th>Views</th><th style="text-align:right">Value</th></tr></thead><tbody>${topByViews.map(p=>`<tr style="cursor:pointer" onclick="navigate('/edit/${p.id}')"><td style="font-weight:600">${esc(truncate(p.title,30))}</td><td>üëÅ ${p.view_count}</td><td style="text-align:right;font-weight:600">${formatMoney(p.value||0)}</td></tr>`).join('')}</tbody></table></div>`:'<p style="color:var(--text-light);text-align:center;padding:24px">No views yet.</p>'}</div></div></div>`}catch(err){toast('Failed to load analytics','error');navigate('/dashboard')}}

// ========================= REVIEW ANALYTICS DASHBOARD =========================
async function renderReviewAnalytics(){
  document.getElementById('app').innerHTML='<div class="loading-state"><div class="spinner"></div></div>';
  try{
    const d=await api('/api/reviews/analytics');
    const{totalReviews,sentiment,clicks,weeklyTrends,recentReviews,avgRating,responseRate}=d;
    const maxR=Math.max(...weeklyTrends.map(w=>w.reviews),1);
    const sentTotal=sentiment.positive+sentiment.neutral+sentiment.negative;
    
    const barsHtml=weeklyTrends.map(w=>{
      const h=Math.max(8,Math.round(w.reviews/maxR*160));
      return '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">'+
        '<div style="width:100%;display:flex;flex-direction:column;justify-content:flex-end;height:160px">'+
        '<div style="background:linear-gradient(to top,#10b981,#34d399);border-radius:6px 6px 0 0;height:'+h+'px;display:flex;align-items:flex-start;justify-content:center;padding-top:4px">'+
        '<span style="font-size:.75rem;font-weight:700;color:#fff">'+w.reviews+'</span></div></div>'+
        '<span style="font-size:.7rem;color:var(--text-light)">'+w.week+'</span></div>';
    }).join('');
    
    const reviewsHtml=recentReviews.map(r=>{
      const stars='‚≠ê'.repeat(r.rating);
      const badgeClass=r.sentiment==='positive'?'accepted':r.sentiment==='neutral'?'sent':'declined';
      return '<tr><td style="font-weight:600">'+r.name+'</td><td>'+stars+'</td>'+
        '<td><span class="badge badge-'+badgeClass+'">'+r.sentiment+'</span></td>'+
        '<td>'+r.source+'</td>'+
        '<td style="color:var(--text-light);font-size:.85rem">'+new Date(r.date).toLocaleDateString()+'</td></tr>';
    }).join('');

    document.getElementById('app').innerHTML=`<div class="container page">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px">
        <div><h1>‚≠ê Review Analytics</h1><p style="color:var(--text-light)">Track reviews, sentiment, and engagement</p></div>
        <button class="btn btn-secondary btn-sm" onclick="navigate('/dashboard')">‚Üê Back</button>
      </div>
      <div class="analytics-grid">
        <div class="card analytics-card primary"><div class="analytics-value">${totalReviews}</div><div class="analytics-label">Total Reviews</div></div>
        <div class="card analytics-card success"><div class="analytics-value">${avgRating}</div><div class="analytics-label">Avg Rating</div></div>
        <div class="card analytics-card warning"><div class="analytics-value">${responseRate}%</div><div class="analytics-label">Response Rate</div></div>
        <div class="card analytics-card" style="--c:#3b82f6"><div class="analytics-value" style="color:#3b82f6">${clicks.ctr}%</div><div class="analytics-label">Click-Through Rate</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
        <div class="card"><h3 style="margin-bottom:16px">üòä Sentiment Breakdown</h3>
          <div style="display:flex;height:24px;border-radius:12px;overflow:hidden;margin-bottom:16px">
            <div style="width:${Math.round(sentiment.positive/sentTotal*100)}%;background:#10b981"></div>
            <div style="width:${Math.round(sentiment.neutral/sentTotal*100)}%;background:#f59e0b"></div>
            <div style="width:${Math.round(sentiment.negative/sentTotal*100)}%;background:#ef4444"></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="display:flex;justify-content:space-between;align-items:center"><span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:12px;border-radius:3px;background:#10b981;display:inline-block"></span> Positive</span><strong>${sentiment.positive}</strong></div>
            <div style="display:flex;justify-content:space-between;align-items:center"><span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:12px;border-radius:3px;background:#f59e0b;display:inline-block"></span> Neutral</span><strong>${sentiment.neutral}</strong></div>
            <div style="display:flex;justify-content:space-between;align-items:center"><span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:12px;border-radius:3px;background:#ef4444;display:inline-block"></span> Negative</span><strong>${sentiment.negative}</strong></div>
          </div>
        </div>
        <div class="card"><h3 style="margin-bottom:16px">üîó Click-Through Stats</h3>
          <div style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;justify-content:space-between;padding:14px;background:var(--bg);border-radius:8px"><span style="color:var(--text-light)">Total Link Clicks</span><strong style="font-size:1.2rem">${clicks.total}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:14px;background:var(--bg);border-radius:8px"><span style="color:var(--text-light)">Unique Clicks</span><strong style="font-size:1.2rem">${clicks.unique}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:14px;background:var(--bg);border-radius:8px"><span style="color:var(--text-light)">CTR</span><strong style="font-size:1.2rem;color:var(--primary)">${clicks.ctr}%</strong></div>
          </div>
        </div>
        <div class="card" style="grid-column:1/-1"><h3 style="margin-bottom:16px">üìà Weekly Trends</h3>
          <div style="display:flex;align-items:flex-end;gap:8px;height:200px;padding:16px 0">${barsHtml}</div>
        </div>
        <div class="card" style="grid-column:1/-1"><h3 style="margin-bottom:16px">üìù Recent Reviews</h3>
          <div style="overflow-x:auto"><table class="top-proposals-table"><thead><tr><th>Name</th><th>Rating</th><th>Sentiment</th><th>Source</th><th>Date</th></tr></thead>
          <tbody>${reviewsHtml}</tbody></table></div>
        </div>
      </div></div>`;
  }catch(err){toast('Failed to load review analytics','error');navigate('/dashboard')}
}


checkAuth();
</script>
</body>
</html>
